<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>
<!-- BUILD_ID: STACK-ABEF-FIX-20251104 -->

<style>
/* ---------- Brand font ---------- */
@font-face{
  font-family:"TechfontItalica";
  src:url("./Techfont-Italica.ttf") format("truetype");
  font-display:swap;
}

/* ---------- Theme ---------- */
:root{
  --ink:#f7f8ff; --ink-dim:#cfd4ff;
  --ring:rgba(255,255,255,.22);
  --glass1:rgba(255,255,255,.12);
  --glass2:rgba(255,255,255,.05);

  --mag:#ff7bf1; --sun:#ffb84d; --lime:#8dff6a; --vio:#ae8bff; --scar:#ff6a6a;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);
  font-family:"TechfontItalica",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:#0f0a1c;
}

/* Animated color field you approved (mildly faster + more vibrant) */
.bg{
  position:fixed; inset:0; z-index:-4;
  background:
    radial-gradient(1200px 700px at 15% 15%, rgba(255,123,241,.35), transparent 60%),
    radial-gradient(1200px 900px at 85% 10%, rgba(255,184,77,.32), transparent 65%),
    radial-gradient(1000px 800px at 20% 85%, rgba(141,255,106,.28), transparent 65%),
    linear-gradient(180deg, #1b1032 0%, #2a184a 50%, #25143f 100%);
  animation:hue 60s linear infinite;
  filter:saturate(125%);
}
@keyframes hue{ 0%{filter:hue-rotate(0deg)} 100%{filter:hue-rotate(360deg)} }

/* Sacred geometry overlay (transparent, subtle motion) */
.overlay{
  position:fixed; inset:-10%; z-index:-3; opacity:.22; pointer-events:none;
}
.overlay svg{ width:120%; height:120%; }
.overlay .spin{ transform-origin:50% 50%; animation:spin 60s linear infinite; }
@keyframes spin{ to{ transform:rotate(360deg) } }

/* Layout */
.wrap{display:grid;grid-template-columns:440px 1fr;gap:24px;padding:24px;min-height:100dvh}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}

.card{
  position:relative;border-radius:24px;padding:18px;border:1px solid var(--ring);
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}

/* ---------- Brand header ---------- */
.brand{display:grid;grid-template-columns:148px 1fr;gap:18px;align-items:center;margin-bottom:16px}
.logo-box{
  height:148px;border-radius:24px;border:1px solid var(--ring);
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
  overflow:hidden;position:relative;isolation:isolate;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 12px 40px rgba(0,0,0,.35)
}
.logo{position:absolute;left:50%;top:52%;transform:translate(-50%,-50%) scale(.95) scaleY(-1);width:520px;height:520px;object-fit:contain;filter:drop-shadow(0 0 12px rgba(255,255,255,.22)) drop-shadow(0 0 18px rgba(255,123,241,.35)) drop-shadow(0 0 22px rgba(255,216,106,.28)) drop-shadow(0 0 26px rgba(141,255,106,.28)) drop-shadow(0 0 32px rgba(174,139,255,.25)); animation:spin 36s linear infinite reverse;}
.titles h1{ margin:0; line-height:1.02; letter-spacing:.4px; font-size:46px; font-weight:800;
  text-shadow:0 2px 0 rgba(0,0,0,.28), 0 12px 30px rgba(0,0,0,.45); }
.titles .sub{ margin-top:6px;opacity:.92;font-weight:800; text-shadow:0 8px 20px rgba(0,0,0,.35); }
.badge{display:inline-block;margin-left:8px;padding:5px 10px;border-radius:999px;color:#0b0c14;font-weight:900;font-size:13px;background:linear-gradient(90deg,#ff7bf1,#ffd86a)}
.badge.demo{background:linear-gradient(90deg,#ff6a6a,#ffd86a)}

/* ---------- Roadmap ---------- */
.road{margin-top:18px;border:1px solid var(--ring);border-radius:18px;padding:16px;background:rgba(255,255,255,.10)}
.bar{height:12px;border-radius:999px;background:rgba(14,10,25,.6);border:1px solid var(--ring);overflow:hidden}
.bar>span{display:block;height:100%;width:0%;transition:width .35s ease;background:linear-gradient(90deg,#ff7bf1,#ffb84d,#8dff6a,#ff6a6a)}
.bar-legend{display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:var(--ink-dim)}
.row{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}

/* Buttons keep brand font */
.btn{
  appearance:none;border:none;cursor:pointer;font-weight:900;
  color:#0b0c14;background:linear-gradient(180deg,#fff,#e9eefc);
  border-radius:999px;padding:10px 14px;
  box-shadow:0 8px 20px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.4);
  font-family:"TechfontItalica", system-ui, sans-serif;
}
.btn-ghost{background:rgba(255,255,255,.08);color:var(--ink);border:1px solid var(--ring)}
.btn:active{transform:translateY(1px)}

/* Kebab */
.drop{position:relative}
/* force menu on top and fixed (anti-clipping) */
.drop-menu{
  position:fixed;display:none;min-width:280px;max-height:60dvh;overflow:auto;
  background:#0e0a1fe6;backdrop-filter:blur(10px);border:1px solid var(--ring);border-radius:16px;padding:8px;
  z-index:2147483647; pointer-events:auto;
}
.drop.open .drop-menu{display:block}
.drop-menu .item{padding:10px 12px;border-radius:10px;font-weight:800;color:var(--ink);font-family:"TechfontItalica",system-ui}
.drop-menu .item:hover{background:#ffffff18}
.drop-menu .danger{background:#ff5b5b1a;border:1px solid #ff5b5b45}

/* Demo CTA */
.cta{margin-top:14px;padding:16px;border-radius:16px;border:1px solid var(--ring);background:linear-gradient(180deg,rgba(50,10,35,.92),rgba(45,15,40,.88));text-align:center}
.cta .big{width:100%;padding:14px 16px;border-radius:12px;font-size:18px;font-weight:900;background:linear-gradient(90deg,#ff7bf1,#ffd86a);color:#0b0c14;font-family:"TechfontItalica",system-ui}
.cta small{display:block;margin-top:8px;color:var(--ink-dim)}

/* ---------- Chat ---------- */
.chat-col{ position:relative; height:calc(100dvh - 48px); display:flex; flex-direction:column; }
.chat{ flex:1; min-height:0; overflow:auto; padding:18px 18px 96px; background:linear-gradient(180deg,rgba(255,255,255,.11),rgba(255,255,255,.06)); border:1px solid var(--ring);border-radius:24px;scroll-behavior:smooth; scrollbar-width:none; }
.chat::-webkit-scrollbar{width:0;height:0}
.bubble{ position:relative;margin:14px 0;padding:14px 16px 14px 56px;border-radius:18px;border:1px solid var(--ring); background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05));box-shadow:0 10px 30px rgba(0,0,0,.25) }
.bubble .who{ position:absolute;left:12px;top:12px;width:32px;height:32px;display:grid;place-items:center;border-radius:10px; background:#0e0a1fe6;border:1px solid var(--ring) }

/* Coach card (status strip) */
.coach{margin-top:10px;border:1px solid var(--ring);border-radius:14px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.05));font-size:13px;color:var(--ink-dim)}
.coach b{color:var(--ink)}
.coach .pill{display:inline-block;margin-right:8px;padding:4px 8px;border-radius:999px;background:#ffffff12;color:var(--ink)}

/* Composer */
.composer{ position:absolute; left:0; right:0; bottom:0; display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:end; padding-top:10px; }
textarea{width:100%;min-height:54px;max-height:180px;resize:vertical;padding:14px 16px;color:var(--ink);background:#120d20;border:1px solid var(--ring);border-radius:16px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif !important}
.send{height:54px;border-radius:16px;font-weight:900;background:linear-gradient(130deg,#ff7bf1,#ffd86a);color:#0b0c14;font-family:"TechfontItalica",system-ui}

/* ---------- Modal (Expansions) ---------- */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10000; }
.modal.open{ display:flex; }
.modal::before{ content:""; position:absolute; inset:0; background:rgba(6,4,12,.6); backdrop-filter:blur(4px); }
.panel{ position:relative; z-index:1; width:min(720px,92vw); background:linear-gradient(180deg,var(--glass1),var(--glass2)); border:1px solid var(--ring); border-radius:20px; padding:16px; box-shadow:0 30px 80px rgba(0,0,0,.55); }
.modlist .mod{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:12px; border:1px solid var(--ring); border-radius:14px; margin:10px 0; }
.modlist .lock{ opacity:.6 }
</style>
</head>
<body>
<div class="bg"></div>

<!-- Sacred geometry overlay (transparent line circles) -->
<div class="overlay" aria-hidden="true">
  <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
    <defs>
      <linearGradient id="geo" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#111"/><stop offset="100%" stop-color="#333"/>
      </linearGradient>
    </defs>
    <g class="spin" fill="none" stroke="url(#geo)" stroke-width="0.3" opacity="0.6">
      <circle cx="50" cy="50" r="12"/><circle cx="50" cy="50" r="22"/><circle cx="50" cy="50" r="32"/>
      <circle cx="50" cy="50" r="42"/><circle cx="50" cy="50" r="52"/>
      <path d="M50 15 L72 72 L28 72 Z"/>
    </g>
  </svg>
</div>

<div class="wrap">

  <!-- LEFT -->
  <section class="card" id="left">
    <div class="brand">
      <div class="logo-box"><img class="logo" src="ias-logo.png" alt="IAS Logo"></div>
      <div class="titles">
        <h1>The Freedom Engine</h1>
        <div class="sub">Personal AI Trainer <span class="badge demo" id="tierBadge">Demo</span></div>
      </div>
    </div>

    <div class="road">
      <div class="bar"><span id="bar"></span></div>
      <div class="bar-legend"><span>Roadmap</span><span id="barText">1/5</span></div>
      <div class="row">
        <button class="btn btn-ghost" id="exportBtn">Export</button>
        <button class="btn btn-ghost" id="expBtn">Expansions</button>

        <div class="drop" id="kebab">
          <button class="btn btn-ghost" id="kebabBtn">‚Ä¶</button>
          <div class="drop-menu" id="kebabMenu">
            <div class="item" id="saveSnap">Save Snapshot</div>
            <div class="item" id="loadSnap">Load Snapshot</div>
            <div class="item" id="wake">Wake the Engine</div>
            <div class="item danger" id="reset">Reset Progress</div>
            <div class="item" id="switchMode">Switch to Demo / Sign Out</div>
            <div class="item" id="enterKey">I have a license key</div>
            <div class="item" id="buy">Buy</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEMO CTA -->
    <div class="cta" id="demoCTA" style="display:none">
      <button class="big" id="ctaBuy">$29 ‚Äî Unlock Full Engine</button>
      <small>Cloud saves + premium modules included.</small>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="chat-col">
    <div class="card chat" id="chat"></div>
    <div class="coach" id="coachCard"></div>
    <div class="composer">
      <textarea id="input" placeholder="Answer here. Press Enter to send."></textarea>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </section>

</div>

<!-- Expansions modal -->
<div class="modal" id="expModal" aria-hidden="true">
  <div class="panel">
    <h3 style="margin:6px 6px 10px 6px">Expansions</h3>
    <div class="modlist" id="expList"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn btn-ghost" id="expClose">Close</button>
    </div>
  </div>
</div>

<script>
/* ======= Config / State ======= */
const WORKER_BASE = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const STAGES = 5;
const state = {
  tier: localStorage.getItem("fe_tier") || "demo",
  license: localStorage.getItem("fe_license") || "",
  stage: 1,
  data: { lane:"", offer:"", avatar:"", channel:"", price:"" },
  messages: [], greeted:false, lastWake:0, pendingLock:false
};
const el = {
  bar:document.getElementById("bar"),
  barText:document.getElementById("barText"),
  chat:document.getElementById("chat"),
  input:document.getElementById("input"),
  send:document.getElementById("sendBtn"),
  kebab:document.getElementById("kebab"),
  kebabBtn:document.getElementById("kebabBtn"),
  kebabMenu:document.getElementById("kebabMenu"),
  demoCTA:document.getElementById("demoCTA"),
  tierBadge:document.getElementById("tierBadge"),
  enterKey:document.getElementById("enterKey"),
  buy:document.getElementById("buy"),
  ctaBuy:document.getElementById("ctaBuy"),
  switchMode:document.getElementById("switchMode"),
  reset:document.getElementById("reset"),
  saveSnap:document.getElementById("saveSnap"),
  loadSnap:document.getElementById("loadSnap"),
  expBtn:document.getElementById("expBtn"),
  expModal:document.getElementById("expModal"),
  expList:document.getElementById("expList"),
  expClose:document.getElementById("expClose"),
  wake:document.getElementById("wake"),
};

/* ======= Helpers ======= */
function normalize(t=""){ return t.trim().toLowerCase(); }
function setStage(n){ state.stage=Math.max(1,Math.min(STAGES,n)); updateBar(); }
function updateBar(){
  const pct = Math.max(1,Math.min(STAGES,state.stage))/STAGES*100;
  el.bar.style.width = pct+"%";
  el.barText.textContent = `${Math.max(1,state.stage)}/${STAGES}`;
}
function pushBubble(who,text){ if(!text)return;
  const b=document.createElement("div");
  b.className="bubble";
  b.innerHTML=`<div class="who">${who==="user"?"üí¨":"‚öôÔ∏è"}</div>${text}`;
  el.chat.appendChild(b);
  state.messages.push({who,text});
  requestAnimationFrame(()=>{ el.chat.scrollTop = el.chat.scrollHeight; });
}
function nudge(html){ pushBubble("ai", html); }
function renderCoachCard(){
  const d = state.data||{};
  const bits = [
    `<b>Stage:</b> ${state.stage}/5`,
    d.lane? `<b>Lane:</b> ${d.lane}` : ``,
    d.offer? `<b>Offer:</b> ${d.offer}`: ``,
    d.avatar? `<b>Avatar:</b> ${d.avatar}`: ``,
    d.channel? `<b>Channel:</b> ${d.channel}`: ``,
    d.price? `<b>Price:</b> $${String(d.price).replace(/^\$/,'')}`: ``
  ].filter(Boolean).map(s=>`<span class="pill">${s}</span>`).join(" ");
  const box = document.getElementById("coachCard");
  if(box) box.innerHTML = bits || `<span class="pill"><b>Stage:</b> ${state.stage}/5</span>`;
}
function safeReply(fn){ return (t)=>{ try{ fn(t); } catch(e){ console.error(e); pushBubble("ai","Glitch dodged. Say that again in plain words."); } finally { renderCoachCard(); } }; }

/* ======= Lightweight NLU hints ======= */
const STOP = new Set("the a an and or to for of on in with from at into by about as is are was were be been being i you we they he she it my your our their me us them this that these those".split(" "));
const normText = s => (s||"").toLowerCase().replace(/[^\w$@\- ]+/g," ").replace(/\s+/g," ").trim();
const tokenize = s => normText(s).split(" ").filter(w=>w && !STOP.has(w));
const verbs = /(build|create|write|audit|design|setup|optimi[sz]e|fix|record|craft|review|map|coach|train|plan|launch|code|script|edit|template)/i;
function guessLane(raw){
  const t=normText(raw);
  if(/\bdesign|logo|brand|graphic|thumbnail|banner|art\b/.test(t)) return "Design";
  if(/\bwriting|copy|email|thread|blog|post|tweet|caption|script\b/.test(t)) return "Writing";
  if(/\bcoach|coaching|audit|review|feedback|teardown\b/.test(t)) return "Coaching";
  if(/\bdev|code|build|tool|automation|worker|script|site|landing\b/.test(t)) return "Dev";
  return "";
}
function guessChannel(raw){
  const t=normText(raw);
  if(/\bemail|inbox|subject\b/.test(t)) return "email";
  if(/\bdm|message|pm\b/.test(t)) return "dm";
  if(/\bpost|tweet|thread|story\b/.test(t)) return "post";
  if(/\bcall|phone|zoom\b/.test(t)) return "call";
  return "";
}
function guessPrice(raw){ const m = raw.match(/\$?\b(\d{2,4})\b/); return m? m[1] : ""; }

/* ======= Cloud (D1) ======= */
async function cloudSave(){
  if(state.tier!=="premium" || !state.license) return;
  const payload = { stage:state.stage, data:state.data, messages:state.messages };
  try{
    await fetch(WORKER_BASE+"/progress",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({license_key:state.license,data:JSON.stringify(payload)})});
  }catch(e){}
}
async function cloudLoad(){
  if(state.tier!=="premium" || !state.license) return false;
  try{
    const r=await fetch(WORKER_BASE+"/progress?license_key="+encodeURIComponent(state.license));
    const j=await r.json();
    if(j.ok && j.found && j.data){
      const d=JSON.parse(j.data);
      state.stage=Number(d.stage)||1;
      state.data = Object.assign({lane:"",offer:"",avatar:"",channel:"",price:""}, d.data||{});
      state.messages = Array.isArray(d.messages)? d.messages.slice(-100):[];
      el.chat.innerHTML=""; state.messages.forEach(m=>pushBubble(m.who,m.text));
      updateBar(); renderCoachCard(); return true;
    }
  }catch(e){}
  return false;
}

/* ======= Onboarding ======= */
function greet(){
  if(state.greeted) return; state.greeted=true;
  const intro = `Welcome to <b>The Freedom Engine</b> ‚Äî I‚Äôm your 1‚Äëon‚Äë1 mentor. We‚Äôll build a tiny paid offer you can ship fast and repeat.`;
  const next = {
    1:`Pick a lane or just talk‚ÄîI'll infer: <b>design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other</b>`,
    2:`We‚Äôre shaping a <b>48h tiny offer</b>. Tell me the deliverable, who it‚Äôs for, how you‚Äôll reach them, and a flat price.`,
    3:`Copy time. Say <b>ready</b> when you want drafts.`,
    4:`Launch loop. Say <b>ready</b> for the 72h checklist.`,
    5:`Light automation so this keeps working while you breathe. Say <b>ready</b>.`
  }[state.stage] || "";
  nudge(intro + "<br><br>" + next);
}

/* ======= Brain ======= */
function aiReply(userText){
  const raw = (userText||"").trim();
  const t   = normalize(userText);
  const tooShort = raw.split(/\s+/).filter(Boolean).length < 3;
  const hasVerb  = verbs.test(raw);
  if(!t){ nudge("Give me a crumb or say <em>help me choose</em>."); return; }
  if(tooShort && !hasVerb && !/^\d$/.test(t) && !/(ready|done|help|menu|expansions)/i.test(t)){
    nudge("Too vague. What exactly will they get? One sentence with the action + outcome."); return;
  }

  switch(state.stage){
    case 1: { // Lane
      const num = t.match(/^\s*([1-5])\s*$/);
      const word = t.match(/\b(design|writing|coaching|development|dev|other)\b/i);
      const laneGuess = guessLane(raw);
      if(num || word || laneGuess){
        const lane = num ? ["","Design","Writing","Coaching","Dev","Other"][Number(num[1])]
                    : (word ? (word[1].toLowerCase().startsWith("dev")?"Dev":word[1][0].toUpperCase()+word[1].slice(1)) : laneGuess);
        state.data.lane = lane || "Other";
        nudge(`Locked: <b>${state.data.lane}</b>.<br>What‚Äôs a <b>tiny deliverable in ~48h</b> someone would pay for? One sentence.`);
        setStage(2); cloudSave(); return;
      }
      nudge(`Tell me your lane (design / writing / coaching / dev / other) or say a number 1‚Äì5.`);
      return;
    }

    case 2: { // Offer Design
      // infer pieces in any order
      if(!state.data.offer && hasVerb && raw.length>20) state.data.offer = raw;
      const ch = guessChannel(raw); if(ch) state.data.channel = ch;
      const pr = guessPrice(raw);   if(pr) state.data.price = pr;
      if(!state.data.avatar && !hasVerb && raw.length<=120) state.data.avatar = raw;

      const missing = [];
      if(!state.data.offer)  missing.push("offer");
      if(!state.data.avatar) missing.push("avatar");
      if(!state.data.channel)missing.push("channel");
      if(!state.data.price)  missing.push("price");

      if(missing.length){
        const Q = {
          offer:  "What exactly do they get in 48h? (scope + outcome)",
          avatar: "Who is the first buyer you‚Äôd ship to? (name/role)",
          channel:"Fastest way to reach them? (email/DM/post/call)",
          price:  "Flat price you won‚Äôt resent ($29‚Äì$199)?"
        }[missing[0]];
        nudge(Q); renderCoachCard(); return;
      }

      if(!state.pendingLock){
        state.pendingLock=true;
        nudge(`Recap: <b>${state.data.offer}</b> ‚Üí <i>${state.data.avatar}</i> via <b>${state.data.channel}</b> at <b>$${String(state.data.price).replace(/^\$/,'')}</b>.<br>Lock it? <b>yes</b> / <b>no</b>`);
        return;
      }
      if(/^y(es)?$/i.test(t)){ state.pendingLock=false; nudge("Module 2 complete. On to <b>Copy Templates & AI Prompts</b>. Say <b>ready</b> to generate drafts."); completeModule(); return; }
      if(/^n(o)?$/i.test(t)){ state.pendingLock=false; nudge("No problem. Tell me what to change‚Äîoffer, avatar, channel, or price."); return; }
      return;
    }

    case 3: { // Copy & Prompts (placeholder demo experience)
      if(/ready/i.test(t)){
        nudge("Drafting your outreach + landing hero using your data‚Ä¶ (demo preview).");
        if(state.tier==="demo"){ nudge(`You‚Äôve reached the end of the demo. <b>Unlock Premium</b> to continue through Modules 3‚Äì5.`); return; }
        nudge("Module 3 complete. Say <b>ready</b> for Launch & Traffic Loops."); completeModule(); return;
      }
      nudge("Say <b>ready</b> to generate drafts.");
      return;
    }

    case 4: { // Launch & Loops
      if(/ready/i.test(t)){
        nudge("72‚Äëhour launch checklist generated. (demo preview)");
        if(state.tier==="demo"){ nudge(`Unlock Premium to get the full launch map + traffic loops.`); return; }
        nudge("Module 4 complete. Say <b>ready</b> for Automation & Scaling."); completeModule(); return;
      }
      nudge("Say <b>ready</b> to print the 72h checklist.");
      return;
    }

    case 5: { // Automation
      if(/ready/i.test(t)){
        nudge("Light automations queued. (demo preview)");
        if(state.tier==="demo"){ nudge(`Unlock Premium to wire automations + cloud saves.`); return; }
        nudge("Module 5 complete. You‚Äôre done. Open Expansions for add-ons."); completeModule(); return;
      }
      nudge("Say <b>ready</b> to wire the first automation.");
      return;
    }
  }
}

function completeModule(){
  if(state.stage < STAGES){
    if(state.tier==="demo" && state.stage>=2){
      setStage(2); nudge(`Demo limit reached. <b>Buy</b> to continue.`); return;
    }
    setStage(state.stage+1);
  }
  cloudSave(); renderCoachCard();
}

/* ======= UI Boot / Events ======= */
document.addEventListener("DOMContentLoaded", async ()=>{
  // portal kebab menu so it never clips
  try{ document.body.appendChild(el.kebabMenu); }catch(e){}

  // kebab events
  const openKebab=()=>{
    el.kebab.classList.add("open");
    const m = el.kebabMenu;
    m.style.display="block";
    const r = el.kebabBtn.getBoundingClientRect();
    const mw = m.offsetWidth||300, mh = m.offsetHeight||240, pad=8;
    let top  = (window.innerHeight - r.bottom > mh+pad) ? r.bottom+8 : r.top - mh - 8;
    let left = r.right - mw;
    top  = Math.max(pad, Math.min(window.innerHeight-mh-pad, top));
    left = Math.max(pad, Math.min(window.innerWidth -mw-pad, left));
    m.style.top  = `${top}px`; m.style.left = `${left}px`;
  };
  const closeKebab=()=>{ el.kebab.classList.remove("open"); el.kebabMenu.style.display="none"; };
  el.kebabBtn.addEventListener("click", (e)=>{ e.stopPropagation(); if(el.kebab.classList.contains("open")) closeKebab(); else openKebab(); });
  window.addEventListener("resize", ()=>{ if(el.kebab.classList.contains("open")) openKebab(); });
  document.addEventListener("click", (e)=>{ if(!el.kebab.contains(e.target)) closeKebab(); });

  // demo/premium
  const gumroad="https://intellartsystems.gumroad.com/l/the-freedom-engine";
  el.buy.addEventListener("click", ()=>window.open(gumroad,"_blank"));
  el.ctaBuy?.addEventListener("click", ()=>window.open(gumroad,"_blank"));
  el.enterKey.addEventListener("click", async ()=>{
    const key=prompt("Enter license key:"); if(!key) return;
    state.license=key.trim(); localStorage.setItem("fe_license",state.license);
    setTier("premium"); const ok = await cloudLoad();
    if(!ok){ el.chat.innerHTML=""; state.messages=[]; greet(); }
    updateBar(); renderCoachCard();
  });
  el.switchMode.addEventListener("click", ()=>{
    localStorage.removeItem("fe_license"); setTier("demo");
    state.license=""; setStage(1); state.data={lane:"",offer:"",avatar:"",channel:"",price:""}; state.messages=[]; state.greeted=false;
    el.chat.innerHTML=""; greet(); updateBar(); renderCoachCard();
  });
  el.reset.addEventListener("click", ()=>{
    setStage(1); state.data={lane:"",offer:"",avatar:"",channel:"",price:""}; state.messages=[]; state.greeted=false; state.pendingLock=false;
    el.chat.innerHTML=""; greet(); updateBar(); renderCoachCard(); cloudSave();
  });

  // export / snapshots
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const data={stage:state.stage,data:state.data,messages:state.messages,tier:state.tier};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="freedom-engine-snapshot.json"; a.click(); URL.revokeObjectURL(a.href);
  });
  el.saveSnap.addEventListener("click", ()=>{
    const data={stage:state.stage,data:state.data,messages:state.messages};
    const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="fe-local-snapshot.json"; a.click(); URL.revokeObjectURL(a.href);
  });
  el.loadSnap.addEventListener("click", ()=>{
    const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
    inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return;
      try{ const d=JSON.parse(await f.text());
        setStage(Math.max(1,Math.min(5,Number(d.stage)||1)));
        state.data=Object.assign({lane:"",offer:"",avatar:"",channel:"",price:""}, d.data||{});
        state.messages=Array.isArray(d.messages)?d.messages.slice(-100):[];
        el.chat.innerHTML=""; state.messages.forEach(m=>pushBubble(m.who,m.text)); updateBar(); renderCoachCard(); cloudSave();
      }catch{ alert("Bad snapshot file."); }
    }; inp.click();
  });

  // expansions
  const renderExpansions=()=>{
    const isDemo = state.tier==="demo";
    el.expList.innerHTML="";
    const rows = [
      {name:"Offer Sprint", desc:"Guided 72-hour micro-offer builder", locked:isDemo},
      {name:"Copy Booster", desc:"Emails, posts, and landing copy blocks", locked:isDemo},
      {name:"Launch Maps", desc:"Checklists + timelines", locked:isDemo},
    ];
    rows.forEach(r=>{
      const div=document.createElement("div");
      div.className="mod"+(r.locked?" lock":"");
      div.innerHTML=`<div><b>${r.name}</b><br><span class="dim">${r.desc}</span></div>
                     <div>${r.locked? "üîí" : "<button class='btn btn-ghost'>Enable</button>"}</div>`;
      el.expList.appendChild(div);
    });
  };
  el.expBtn.addEventListener("click", ()=>{ renderExpansions(); el.expModal.classList.add("open"); });
  el.expClose.addEventListener("click", ()=> el.expModal.classList.remove("open"));
  el.expModal.addEventListener("click",(e)=>{ if(e.target===el.expModal) el.expModal.classList.remove("open"); });

  // wake
  el.wake.addEventListener("click", ()=>{
    const now=Date.now(); if(now-state.lastWake<2000) return; state.lastWake=now;
    nudge("Engine‚Äôs awake. Where were we?");
  });

  // send
  const _aiCore = safeReply(aiReply);
  function send(){ const v=el.input.value.trim(); if(!v) return; pushBubble("user",v); el.input.value=""; _aiCore(v); }
  el.send.addEventListener("click", send);
  el.input.addEventListener("keydown", e=>{ if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}});

  // init
  // move kebab menu into body once (anti-clipping)
  try{ if(el.kebabMenu.parentElement!==document.body){ document.body.appendChild(el.kebabMenu); } }catch(e){}
  setTier(state.tier);
  let loaded=false;
  if(state.tier==="premium" && state.license){ loaded=await cloudLoad(); }
  if(!loaded || state.messages.length===0) greet();
  updateBar(); renderCoachCard();
});

/* ======= Tier UI ======= */
function setTier(t){
  state.tier=t; localStorage.setItem("fe_tier",t);
  const isDemo = t==="demo";
  document.body.classList.toggle("is-premium", !isDemo);
  el.demoCTA.style.display = isDemo ? "block":"none";
  el.enterKey.style.display = isDemo ? "block":"none";
  el.buy.style.display      = isDemo ? "block":"none";
  el.switchMode.style.display = isDemo ? "none":"block";
  el.tierBadge.textContent  = isDemo ? "Demo":"Premium";
  el.tierBadge.classList.toggle("demo", isDemo);
}
</script>
</body>
</html>
