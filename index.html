<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,600;1,600&display=swap" rel="stylesheet">

<style>
  :root{
    --glass: rgba(255,255,255,0.08);
    --glass-2: rgba(255,255,255,0.14);
    --ring: rgba(255,255,255,0.22);
    --ink: #e8ecff;
    --ink-dim:#bfc7f9;
    --neon-c:#82f3ff; --neon-m:#ff7bf1; --neon-y:#ffd86a; --neon-g:#77ffb0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family: "Kanit", system-ui, sans-serif;
    background: radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,0.12), transparent 60%),
                radial-gradient(900px 600px at 80% 30%, rgba(255,255,255,0.10), transparent 60%),
                linear-gradient(140deg, #2b0f27 0%, #23173a 40%, #18324a 100%);
  }

  /* Layout */
  .wrap{display:grid; grid-template-columns: 420px 1fr; gap:24px; padding:24px; height:100%;}
  @media(max-width:900px){ .wrap{grid-template-columns: 1fr; height:auto; min-height:100%} }

  .card{
    background:var(--glass); border:1px solid var(--ring);
    border-radius:22px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
    padding:18px; position:relative; overflow:hidden;
  }
  .card::before{
    content:""; position:absolute; inset:-40%;
    background: conic-gradient(from 0deg, var(--neon-c), var(--neon-m), var(--neon-y), var(--neon-g), var(--neon-c));
    opacity:.12; filter: blur(80px);
    animation: swirl 16s linear infinite;
  }
  @keyframes swirl{to{transform:rotate(360deg)}}

  /* Left column (header) */
  .brand{
    display:grid; grid-template-columns: 132px 1fr; gap:16px; align-items:center;
    margin-bottom:16px; position:relative; z-index:1;
  }
  .logo-box{
    height:132px; border-radius:20px; background:var(--glass-2); border:1px solid var(--ring);
    overflow:hidden; display:grid; place-items:center;
  }
  .logo{
    width:320px; height:320px; /* 3x bigger but clipped by the box */
    object-fit:contain; animation: spin 38s linear infinite;
    filter: drop-shadow(0 0 12px rgba(255,255,255,.25));
  }
  @keyframes spin{to{ transform: rotate(360deg) }}

  .titles h1{margin:0; line-height:1.02; font-weight:600; font-size:44px; letter-spacing:.5px}
  .titles .sub{opacity:.8; margin-top:4px;}
  .badge{display:inline-block; padding:5px 10px; border-radius:999px;
    background:linear-gradient(90deg,var(--neon-m),var(--neon-c)); color:#151327; font-weight:700; margin-top:8px; font-size:13px}
  .badge.demo{background:linear-gradient(90deg,#ff8ab5,#ffd86a);}

  .road{
    margin-top:18px; background:var(--glass-2); border:1px solid var(--ring); border-radius:16px; padding:14px;
  }
  .bar{height:12px; border-radius:999px; overflow:hidden; background:rgba(0,0,0,.35); border:1px solid var(--ring)}
  .bar > span{display:block; height:100%; width:0%;
    background:linear-gradient(90deg,var(--neon-c),var(--neon-m),var(--neon-y),var(--neon-g));
    transition: width .35s ease;
  }
  .bar-legend{display:flex; justify-content:space-between; margin-top:8px; font-size:13px; color:var(--ink-dim)}

  .row{display:flex; gap:8px; margin-top:14px}
  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:700; color:#0b0c14;
    background:linear-gradient(180deg,#fff,#e9eefc); border-radius:999px; padding:10px 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.35);
  }
  .btn:active{transform:translateY(1px)}
  .btn-ghost{
    background:var(--glass); color:var(--ink); border:1px solid var(--ring);
  }
  .drop{position:relative}
  .drop-menu{
    position:absolute; right:0; bottom:calc(100% + 8px); /* OPEN UPWARDS */
    background:#0e1122ee; border:1px solid var(--ring); border-radius:16px; padding:8px;
    min-width:260px; display:none; z-index:50; backdrop-filter: blur(8px);
  }
  .drop.open .drop-menu{display:block}
  .drop-menu .item{padding:10px 12px; border-radius:10px; color:var(--ink); font-weight:600;}
  .drop-menu .item:hover{background:#ffffff18}
  .drop-menu .danger{background:#ff5b5b1a; border:1px solid #ff5b5b45}
  .cta{
    margin-top:14px; padding:16px; border-radius:16px; background:linear-gradient(180deg,#1a1031aa,#231b3daa);
    border:1px solid var(--ring); text-align:center;
  }
  .cta .big{
    width:100%; padding:14px 16px; border-radius:12px; font-size:18px; font-weight:900;
    background:linear-gradient(90deg,#ff84f7,#ffd86a); color:#0b0c14;
  }
  .cta small{display:block; margin-top:8px; color:var(--ink-dim)}

  /* Right column (chat) */
  .chat-col{display:grid; grid-template-rows: 1fr auto; height:calc(100vh - 48px);}
  @media(max-width:900px){ .chat-col{height: auto; min-height: 70vh} }

  .chat{
    overflow:auto; background:var(--glass); border:1px solid var(--ring);
    border-radius:22px; padding:18px; scroll-behavior:smooth;
  }
  .bubble{
    background:linear-gradient(180deg, rgba(255,255,255,0.11), rgba(255,255,255,0.05));
    border:1px solid var(--ring); border-radius:18px; padding:14px 16px; margin:10px 0;
    position:relative;
  }
  .bubble .who{position:absolute; left:-38px; top:10px; width:28px; height:28px;
    display:grid; place-items:center; border-radius:10px; background:#0e1122eb; border:1px solid var(--ring);}
  .who.user{content:"üí¨"}
  .dim{color:var(--ink-dim)}

  .composer{
    margin-top:12px; display:grid; grid-template-columns: 1fr 110px; gap:10px; align-items:end;
  }
  textarea{
    width:100%; min-height:54px; max-height:180px; resize:vertical;
    padding:14px 16px; color:var(--ink); background:#0b0f1f; border:1px solid var(--ring); border-radius:16px;
  }
  .send{height:54px; border-radius:16px; font-weight:900; background:linear-gradient(130deg,#ff7bf1,#82f3ff); color:#0b0c14}
</style>
</head>
<body>

<div class="wrap">

  <!-- LEFT / HEADER -->
  <section class="card" id="left">
    <div class="brand">
      <div class="logo-box"><img class="logo" src="ias-logo.png" alt="IAS Logo"></div>
      <div class="titles">
        <h1>The Freedom Engine</h1>
        <div class="sub"><span id="planLabel">Personal AI Trainer</span> <span class="badge demo" id="tierBadge">Demo</span></div>
      </div>
    </div>

    <div class="road">
      <div class="bar"><span id="bar"></span></div>
      <div class="bar-legend"><span>Roadmap</span><span id="barText">1/5</span></div>
      <div class="row">
        <button class="btn btn-ghost" id="exportBtn">Export</button>
        <button class="btn btn-ghost" id="modulesBtn">Modules</button>
        <div class="drop" id="kebab">
          <button class="btn btn-ghost">‚Ä¶</button>
          <div class="drop-menu">
            <div class="item" id="saveSnap">Save Snapshot</div>
            <div class="item" id="loadSnap">Load Snapshot</div>
            <div class="item" id="wake">Wake the Engine</div>
            <div class="item danger" id="reset">Reset Progress</div>
            <div class="item" id="switchMode">Switch to Demo / Sign Out</div>
            <div class="item" id="enterKey">I have a license key</div>
            <div class="item" id="buy">Buy</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEMO CTA -->
    <div class="cta" id="demoCTA" style="display:none">
      <button class="big" id="ctaBuy">$29 ‚Äî Unlock Full Engine</button>
      <small>Cloud saves + premium modules included.</small>
    </div>
  </section>

  <!-- RIGHT / CHAT -->
  <section class="chat-col">
    <div class="chat" id="chat"></div>
    <div class="composer">
      <textarea id="input" placeholder="Answer here. Press Enter to send."></textarea>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </section>

</div>

<script>
/* =========================
   CONFIG & STATE
========================= */
const WORKER_BASE = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const STAGES = 5;
const state = {
  tier: localStorage.getItem("fe_tier") || "demo",     // "demo" | "premium"
  license: localStorage.getItem("fe_license") || "",
  roadmap: 1,
  messages: [] // {who:'ai'|'user', text}
};

const el = {
  bar: document.getElementById("bar"),
  barText: document.getElementById("barText"),
  chat: document.getElementById("chat"),
  input: document.getElementById("input"),
  send: document.getElementById("sendBtn"),
  kebab: document.getElementById("kebab"),
  demoCTA: document.getElementById("demoCTA"),
  tierBadge: document.getElementById("tierBadge"),
  enterKey: document.getElementById("enterKey"),
  buy: document.getElementById("buy"),
  ctaBuy: document.getElementById("ctaBuy"),
  switchMode: document.getElementById("switchMode"),
  reset: document.getElementById("reset"),
  saveSnap: document.getElementById("saveSnap"),
  loadSnap: document.getElementById("loadSnap"),
};

/* =========================
   UTIL
========================= */
function setTier(t){
  state.tier = t;
  localStorage.setItem("fe_tier", t);
  // Show/Hide monetization controls
  const showDemo = t === "demo";
  el.demoCTA.style.display = showDemo ? "block" : "none";
  el.enterKey.parentElement.style.display = showDemo ? "block" : "none";
  el.buy.parentElement.style.display = showDemo ? "block" : "none";
  el.tierBadge.textContent = showDemo ? "Demo" : "Premium";
  el.tierBadge.classList.toggle("demo", showDemo);
}

function updateBar(){
  const pct = Math.max(1, Math.min(STAGES, state.roadmap)) / STAGES * 100;
  el.bar.style.width = pct + "%";
  el.barText.textContent = `${Math.max(1,state.roadmap)}/${STAGES}`;
}

function pushBubble(who, text){
  if(!text || typeof text !== 'string') return;
  const b = document.createElement("div");
  b.className = "bubble";
  b.innerHTML = `<div class="who">${who === "user" ? "üí¨" : "‚öôÔ∏è"}</div>${text}`;
  el.chat.appendChild(b);
  state.messages.push({who,text});
  requestAnimationFrame(()=> el.chat.scrollTop = el.chat.scrollHeight);
}

function onceBootGreeting(){
  if(sessionStorage.getItem("fe_booted")) return false;
  sessionStorage.setItem("fe_booted","1");
  pushBubble("ai",
    `Welcome to the Freedom Engine. I‚Äôll carry strategy, templates, and deadlines; you do bite-size reps.
     We‚Äôll ship one in ~72 hours. No monk retreat required.<br><br>
     Pick a lane and I‚Äôll carry the heavy boxes:<br>
     ‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other<br><br>
     If you‚Äôre blank, say <em>‚Äúhelp me choose‚Äù</em> and I‚Äôll pitch options.`
  );
  return true;
}

/* =========================
   CLOUD SAVE / LOAD (D1)
========================= */
async function cloudSave(){
  if(state.tier !== "premium" || !state.license) return;
  const payload = { roadmap: state.roadmap, messages: state.messages };
  try{
    await fetch(WORKER_BASE + "/progress",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ license_key: state.license, data: JSON.stringify(payload) })
    });
  }catch(e){ /* ignore but don‚Äôt crash UI */ }
}

async function cloudLoad(){
  if(state.tier !== "premium" || !state.license) return false;
  try{
    const r = await fetch(WORKER_BASE + "/progress?license_key=" + encodeURIComponent(state.license));
    const j = await r.json();
    if(j.ok && j.found && j.data){
      const data = JSON.parse(j.data);
      if(data.roadmap) state.roadmap = data.roadmap;
      if(Array.isArray(data.messages)) {
        state.messages = data.messages.slice(-80); // cap
        el.chat.innerHTML = "";
        for(const m of state.messages) pushBubble(m.who, m.text);
      }
      updateBar();
      return true;
    }
  }catch(e){ /* noop */ }
  return false;
}

/* =========================
   AI BRAIN (simple router)
========================= */
function aiReply(userText){
  const t = (userText||"").trim().toLowerCase();

  // Friendly handling for ‚Äúhelp me choose‚Äù
  if(/help me choose|no clue|idk|i don.?t know/.test(t)){
    state.roadmap = Math.max(1, state.roadmap);
    pushBubble("ai",
      `No problem. Here are five lanes ‚Äî reply with a number:<br>
       1) <b>Design</b> ‚Äî logos, graphics, visual packs<br>
       2) <b>Writing</b> ‚Äî copy, guides, micro-ebooks<br>
       3) <b>Coaching</b> ‚Äî 1:1 accelerators, audits<br>
       4) <b>Dev</b> ‚Äî tiny tools, setups, automations<br>
       5) <b>Other</b> ‚Äî pitch your weird idea`
    );
    return;
  }

  // Map numeric choice
  const m = t.match(/^\s*([1-5])\s*$/);
  if(m){
    const n = Number(m[1]);
    const lane = ["","Design","Writing","Coaching","Dev","Other"][n];
    state.roadmap = 2;
    pushBubble("ai",
      `Great ‚Äî <b>${lane}</b> it is. We‚Äôll ship a tiny paid offer.<br>
       Hit me with one of these to move fast:<br>
       ‚Ä¢ one thing you can deliver in &lt;48h<br>
       ‚Ä¢ one real person who needs it<br>
       ‚Ä¢ any proof/screens you already have`
    );
    cloudSave();
    updateBar();
    return;
  }

  // Default mentor-y response (keeps tone tight, no undefineds)
  state.roadmap = Math.min(STAGES, state.roadmap + 1);
  pushBubble("ai",
    `Good ‚Äî noted. I‚Äôll turn that into a shippable step. Next, give me the <b>constraint</b>:
     time you can invest in 3 days, any tools you refuse to use, and your absolute ‚Äúnope‚Äù line.
     Constraints make good products brutal and real.`
  );
  cloudSave();
  updateBar();
}

/* =========================
   HOOKS
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  // Kebab drop-up
  el.kebab.querySelector("button").addEventListener("click", () => {
    el.kebab.classList.toggle("open");
  });
  document.addEventListener("click",(e)=>{
    if(!el.kebab.contains(e.target)) el.kebab.classList.remove("open");
  });

  // Buttons
  el.buy.addEventListener("click",()=> window.open("https://intellartsystems.gumroad.com/l/the-freedom-engine","_blank"));
  el.ctaBuy.addEventListener("click",()=> window.open("https://intellartsystems.gumroad.com/l/the-freedom-engine","_blank"));

  el.enterKey.addEventListener("click", async ()=>{
    const key = prompt("Enter license key:");
    if(!key) return;
    // (Optional) verify endpoint already exists in your worker
    state.license = key.trim();
    localStorage.setItem("fe_license", state.license);
    setTier("premium");
    const ok = await cloudLoad();
    if(!ok){ el.chat.innerHTML=""; pushBubble("ai","Premium engaged. Clean slate. Tell me where you want to start ‚Äî or say ‚Äúhelp me choose.‚Äù"); }
    updateBar();
  });

  el.switchMode.addEventListener("click", ()=>{
    // sign out
    localStorage.removeItem("fe_license");
    setTier("demo");
    state.license = "";
    state.roadmap = 1;
    state.messages = [];
    sessionStorage.removeItem("fe_booted");
    el.chat.innerHTML="";
    onceBootGreeting();
    updateBar();
  });

  el.reset.addEventListener("click", ()=>{
    state.roadmap = 1;
    state.messages = [];
    sessionStorage.removeItem("fe_booted");
    el.chat.innerHTML = "";
    onceBootGreeting();
    cloudSave();
    updateBar();
  });

  // Send
  function sendNow(){
    const v = el.input.value.trim();
    if(!v) return;
    pushBubble("user", v);
    el.input.value="";
    aiReply(v);
  }
  el.send.addEventListener("click", sendNow);
  el.input.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendNow(); }
  });

  // Tier on boot
  setTier(state.tier);

  // Try cloud load if premium
  let greeted = false;
  if(state.tier==="premium" && state.license){
    const ok = await cloudLoad();
    if(!ok) greeted = onceBootGreeting();
  } else {
    greeted = onceBootGreeting();
  }

  updateBar();
  if(!greeted && state.messages.length===0) onceBootGreeting();
});

/* Prevent duplicate opener on hard reload */
window.addEventListener("pageshow",()=>{
  // Keep only the last opener bubble if multiples snuck in
  const bubbles = [...document.querySelectorAll(".bubble")];
  const openerIdx = bubbles.filter(b => b.innerText.includes("Freedom Engine")).map(b => b);
  if(openerIdx.length > 1){
    openerIdx.slice(0, -1).forEach(b=> b.remove());
  }
});
</script>
</body>
</html>
