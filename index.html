<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Freedom Engine ‚Äî Trainer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07080b; --ink:#eaf0ff; --muted:#98a2b3; --line:#1b2235;
  --glass1:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.02);
  --neon1:#7c86ff; --neon2:#3ddc97; --neon3:#ff7cba; --neon4:#ffa93d;
  --rad:18px; --shadow:0 18px 60px rgba(0,0,0,.55);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;overflow-y:overlay}

/* Ambient neon */
.canvas{position:fixed;inset:-20vmax;z-index:-1;filter:blur(80px) saturate(140%);opacity:.35;pointer-events:none;
  background:
   conic-gradient(from 0deg at 30% 30%, var(--neon1), transparent 40%),
   conic-gradient(from 180deg at 70% 20%, var(--neon3), transparent 45%),
   conic-gradient(from 90deg at 40% 80%, var(--neon2), transparent 50%);
  animation:drift 18s linear infinite alternate}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(4rem,-3rem,0) scale(1.1)}}

/* Layout */
.container{max-width:1220px;margin:0 auto;padding:22px 18px 120px;display:grid;gap:18px;grid-template-columns:260px 1fr}
@media(max-width:1024px){.container{grid-template-columns:1fr}}
.glass{background:linear-gradient(180deg,var(--glass1),var(--glass2));border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);backdrop-filter:blur(14px) saturate(140%)}
.neon{position:relative;isolation:isolate}
.neon::before{content:"";position:absolute;inset:-1px;z-index:-1;border-radius:calc(var(--rad)+2px);
  background:
   linear-gradient(90deg,var(--neon1),transparent 30%,transparent 70%,var(--neon3)),
   linear-gradient(180deg,var(--neon2),transparent 30%,transparent 70%,var(--neon4));
  filter:blur(12px) saturate(140%);opacity:.35}

/* Sidebar minimal */
.sidebar{position:sticky;top:16px;height:fit-content;padding:14px}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.logo-wrap{width:54px;height:54px;border-radius:14px;display:grid;place-items:center;position:relative;background:rgba(0,0,0,.25);border:1px solid #2a2f45;overflow:hidden}
.logo{width:42px;height:42px;object-fit:contain;display:none}
.logo.spin{display:block;animation:logo-spin 48s linear infinite;
  filter:drop-shadow(0 0 14px rgba(124,134,255,.65)) drop-shadow(0 0 24px rgba(61,220,151,.45)) drop-shadow(0 0 28px rgba(255,124,186,.35))}
@keyframes logo-spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.logo-fallback{position:absolute;inset:0;display:grid;place-items:center;font-family:"JetBrains Mono",monospace;font-weight:700;letter-spacing:.8px;background:linear-gradient(135deg,var(--neon2),var(--neon1),var(--neon3));-webkit-background-clip:text;background-clip:text;color:transparent}
.brand-title{line-height:1.05}
.title{font-weight:800;font-size:16px}
.sub{color:var(--muted);font-size:12px}

/* Console + progress */
.block{padding:12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015))}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:9px 12px;font-weight:600;cursor:pointer}
.btn.small{padding:6px 10px;font-size:12px}
.btn.primary{background:linear-gradient(135deg,var(--neon1),var(--neon3));border:none;box-shadow:0 10px 28px rgba(124,134,255,.35)}
.btn.ok{background:linear-gradient(135deg,var(--neon2),#42f5b0);border:none;box-shadow:0 10px 28px rgba(61,220,151,.35)}
.btn.ghost{background:#0d1222;border:1px solid #2a3553}
.pill{padding:6px 10px;border-radius:999px;background:#0d1222;border:1px solid #293357;font-size:12px}
.pill.demo{color:#ffd7f1;border-color:#4a2a47;background:rgba(255,124,186,.12)}
.pill.full{color:#baffea;border-color:#1f4b3c;background:rgba(61,220,151,.12)}
.progress-wrap{margin-top:8px}
.progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:10px;border-radius:999px;background:#0d1222;border:1px solid #2a2f45;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(90deg,var(--neon2),var(--neon1),var(--neon3),var(--neon4));width:0%;transition:width .4s}

/* Dropdown menu & modal */
.menu{position:relative}
.menu button{width:100%}
.menu .panel{position:absolute;left:0;right:0;top:calc(100% + 6px);background:#0b1224;border:1px solid #2a3553;border-radius:12px;display:none;padding:6px;z-index:5}
.menu.open .panel{display:block}
.menu .panel .btn{width:100%;text-align:left}
.modal{position:fixed;inset:0;background:rgba(7,8,11,.72);backdrop-filter:blur(6px);display:none;place-items:center;z-index:30}
.modal.open{display:grid}
.modal-card{width:min(980px,92vw);max-height:86vh;overflow:auto}
.module-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.module{padding:12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.045),rgba(255,255,255,.02))}
.module h4{margin:4px 0 6px;font-size:14px}
.badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #254;display:inline-block}

/* Chat */
.panel{padding:12px}
.chat{max-height:74vh;overflow:auto;padding:8px 6px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01))}
.msg{display:grid;grid-template-columns:34px 1fr;gap:10px;margin:10px 0;align-items:start}
.avatar{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;border:1px solid #2c3553;background:linear-gradient(135deg,#1b2135,#121628)}
.avatar.me{border-color:#36407a}
.avatar.ai{border-color:#245c46}
.bubble{white-space:pre-wrap;line-height:1.55;padding:12px 14px;border-radius:14px;border:1px solid #28314e;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015))}
.footer{position:fixed;left:0;right:0;bottom:0;padding:12px 14px;background:linear-gradient(180deg,transparent,rgba(5,6,9,.9) 50%, rgba(5,6,9,1) 80%);border-top:1px solid var(--line)}
.composer{max-width:1220px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea{min-height:60px;resize:vertical;border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:10px}
</style>
</head>
<body>
<div class="canvas"></div>

<div class="container" id="app">
  <!-- Sidebar (minimal) -->
  <aside class="glass neon sidebar">
    <div class="brand">
      <div class="logo-wrap">
        <img id="iasLogo" class="logo" src="assets/ias-logo.png" alt="IAS">
        <div class="logo-fallback">IAS</div>
      </div>
      <div class="brand-title">
        <div class="title">Intelligently Artificial Systems</div>
        <div class="sub">The Freedom Engine ‚Äî Trainer <span id="modeTag" class="pill demo" style="margin-left:6px">Demo</span></div>
      </div>
    </div>

    <div class="block">
      <div class="progress-wrap">
        <div class="progress-label"><span>Roadmap</span><span id="stageLabel">0/5</span></div>
        <div class="bar"><div id="barFill"></div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="export" class="btn ghost small" title="Export execution brief">Export</button>
        <button id="modulesBtn" class="btn ghost small" title="Open Modules">Modules</button>
        <div class="menu" id="menu">
          <button id="menuBtn" class="btn ghost small">‚ãØ</button>
          <div class="panel">
            <button id="saveSnap" class="btn ghost small">Save Snapshot</button>
            <button id="loadBtn" class="btn ghost small">Load Snapshot</button>
            <input id="loadSnap" type="file" accept=".json" style="display:none">
            <button id="wake" class="btn ghost small">Wake the Engine</button>
            <button id="reset" class="btn ghost small">Reset Progress</button>
            <button id="switchMode" class="btn ghost small">Switch to Demo / Sign Out</button>
            <button id="unlock" class="btn primary small">I have a license key</button>
            <button id="buy" class="btn primary small">Buy</button>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main>
    <section class="panel glass neon">
      <div id="chat" class="chat"></div>
      <div id="aiStatus" class="sub" style="margin-top:6px">Booting the Trainer‚Ä¶</div>
    </section>
  </main>
</div>

<!-- Composer -->
<div class="footer glass">
  <div class="composer">
    <textarea id="input" placeholder="Answer here. Press Enter to send." disabled></textarea>
    <button id="send" class="btn primary" disabled>Send</button>
  </div>
</div>

<!-- Module Store Modal -->
<div id="modulesModal" class="modal">
  <div class="modal-card glass neon">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px">
      <div style="font-weight:800">Module Store</div>
      <button id="closeModules" class="btn ghost small">Close</button>
    </div>
    <div style="padding:12px">
      <div class="module-grid" id="modulesGrid"></div>
      <div style="margin-top:10px;color:#98a2b3;font-size:12px">Unlocked modules are stored on this device. You can add more later without breaking anything.</div>
    </div>
  </div>
</div>

<script type="module">
/* =================== CONFIG =================== */
const CLOUD_ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL    = "https://intellartsystems.gumroad.com/l/the-freedom-engine";
const CORE_PRODUCT_ID = null; // your worker already handles core; leave null unless you require it
const STAGES = ["profile","offers","selection","plan","optimize"];

/* Paid modules (you'll set real product_id values later) */
const MODULES = [
  {id:"ads",    name:"Ad Creative Booster", product_id:"MOD_ADS_ID", price:"$12", desc:"Generate scroll-stopping ad images + angles in seconds."},
  {id:"email",  name:"Email Launch Booster", product_id:"MOD_EMAIL_ID", price:"$9",  desc:"Auto-draft 3-day launch emails matched to your offer."},
  {id:"planner",name:"Content Planner",      product_id:"MOD_PLAN_ID", price:"$12", desc:"30-day content map to prime your audience for the offer."},
  {id:"proof",  name:"Proof Builder",        product_id:"MOD_PROOF_ID", price:"$7",  desc:"Extract and frame social proof from your past wins."}
];

/* Strong, non-generic opener & curriculum prompts */
const PROMPTS = {
  opener: `Let's find the ONE skill people have already paid you for‚Äîor *wanted* to.
Answer these fast:
1) Where have strangers paid you or thanked you with results? (1‚Äì3 examples)
2) What tiny win you can help someone get in < 48 hours?
3) What proof do you already have? (screenshots, DMs, before/after)
4) Who exactly benefits most? (describe one real person)
5) Constraints: What you refuse to do or don't have time for.
Keep it rough. I'll mine it and steer.`,
  offers: `Based on what you said, I'll propose 3 micro-offers with price, promise, and delivery.
Then we‚Äôll pick one and sharpen it.`,
  selection: `We're locking one offer. I‚Äôll pressure test price, promise, and scope. You commit.`,
  plan: `3-Day Launch Plan (ads optional at $5/day). I'll break it into tasks you'll actually finish.`,
  optimize: `Add a tiny upsell, clean objections, and two ad hooks. Then we ship.`
};

/* =================== AUTO-PERSONA (no UI) =================== */
function detectStyleFrom(text=""){
  const t = text.toLowerCase();
  if (/stuck|overwhelmed|help|lost/.test(t)) return "coach";
  if (/how|steps|plan|process|framework/.test(t)) return "engineer";
  if (/write|headline|copy|hook|story/.test(t)) return "ghostwriter";
  if (/procrastinat|excuse|no time|scared/.test(t)) return "dark";
  return "coach";
}
const STYLE_PRIME = {
  coach:"Direct, motivating, tough love. Short, punchy.",
  engineer:"Methodical, structured, numbered steps, crisp logic.",
  ghostwriter:"Creative, persuasive, language-first, copy-obsessed.",
  dark:"Billy-Butcher energy; dark humor; ruthless accountability (no slurs)."
};
function systemPrime(style="coach", stage="profile", activeModules=[]){
  const extras = [];
  if (activeModules.includes("ads")) extras.push("When they have an offer, propose 2 ad angles and image briefs.");
  if (activeModules.includes("email")) extras.push("Draft 3 launch emails (tease, announce, last call) when plan is ready.");
  if (activeModules.includes("planner")) extras.push("Offer a simple 7-day content seed plan once the offer locks.");
  if (activeModules.includes("proof")) extras.push("Extract proof assets from their answers and frame them as bullets.");
  return `
You are THE FREEDOM ENGINE ‚Äî a ruthless, darkly funny trainer who ships a tiny paid offer in 72 hours.
Tone: ${STYLE_PRIME[style]||STYLE_PRIME.coach}
Curriculum stage: ${stage}. Your job is to steer back to the curriculum if they drift.
Always: Diagnose ‚Üí Propose ‚Üí Narrow ‚Üí Plan ‚Üí Optimize.
Ask follow-ups proactively until the stage is satisfied; then explicitly advance.
${extras.length?("Active modules:\n- " + extras.join("\n- ")):""}
Return STRICT JSON only:
{"say":"...","stage":"profile|offers|selection|plan|optimize","next_questions":["..."],"memory_delta":{"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""},"confidence":0.0}
Keep "say" < 160 words. No code fences. No [[tokens]].`;
}

/* =================== STATE =================== */
let history   = JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked  = localStorage.getItem('fe_unlocked') === '1';
let currentStage = localStorage.getItem('fe_stage') || "profile";
let agentMemory = JSON.parse(localStorage.getItem('fe_memory')||'{"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""}');
let lastTouch = Number(localStorage.getItem('fe_last_touch')||0);
let startTs   = Number(localStorage.getItem('fe_start_ts')||0);
let modules   = JSON.parse(localStorage.getItem('fe_modules')||'[]'); // array of module ids

/* =================== DOM =================== */
const chatEl   = document.getElementById('chat');
const inputEl  = document.getElementById('input');
const sendBtn  = document.getElementById('send');
const aiStatus = document.getElementById('aiStatus');
const stageLabel  = document.getElementById('stageLabel');
const barFill     = document.getElementById('barFill');
const modeTag     = document.getElementById('modeTag');
const modulesBtn  = document.getElementById('modulesBtn');
const modulesModal= document.getElementById('modulesModal');
const modulesGrid = document.getElementById('modulesGrid');

/* Logo spin only if loaded */
const logo = document.getElementById('iasLogo');
const logoFallback = document.querySelector('.logo-fallback');
if (logo){ const ok=()=>{logo.classList.add('spin');logo.style.display='block';logoFallback&&(logoFallback.style.display='none');};
  logo.addEventListener('load',ok,{once:true}); if (logo.complete && logo.naturalWidth>0) ok(); }

/* =================== HELPERS =================== */
const esc = s => (s||"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
function sanitizeSay(t){return (t||"").replace(/^```(?:json)?/i,'').replace(/```$/,'').replace(/\[\[[^\]]+\]\]/g,'').trim();}
function lastAssistant(){ for(let i=history.length-1;i>=0;i--){ if(history[i].role==='assistant') return history[i]; } return null; }
function noRepeatAssistant(text){ const last=lastAssistant(); return !last || sanitizeSay(last.content)!==sanitizeSay(text); }
function dedupeHistory(){ const out=[]; let prevA=null; for(const m of history){ if(m.role==='assistant'){ const s=sanitizeSay(m.content); if(prevA===s) continue; prevA=s; out.push({role:'assistant',content:s}); } else { prevA=null; out.push(m);} } history=out; }

function bubble(role,content){
  const who = role==='user' ? 'me' : 'ai';
  return `<div class="msg ${who}">
    <div class="avatar ${who}">${who==='me'?'üßë':'‚öôÔ∏è'}</div>
    <div class="bubble">${esc(content)}</div>
  </div>`;
}
function push(role,content){
  const cleaned = role==='assistant'?sanitizeSay(content):content;
  if(role==='assistant' && !noRepeatAssistant(cleaned)) return;
  history.push({role,content:cleaned});
  lastTouch = Date.now(); if(!startTs) startTs=lastTouch;
  localStorage.setItem('fe_history',JSON.stringify(history));
  localStorage.setItem('fe_last_touch', String(lastTouch));
  localStorage.setItem('fe_start_ts', String(startTs));
  render(); updateProgressUI();
}
function render(){
  chatEl.innerHTML = history.map(m=>bubble(m.role,m.content)).join('');
  requestAnimationFrame(()=>{ chatEl.scrollTop = chatEl.scrollHeight; });
}
function stageIndex(n){ return Math.max(0, STAGES.indexOf(n)); }
function progressPercent(){ const idx=stageIndex(currentStage); return Math.round(((idx+1)/STAGES.length)*100); }
function updateProgressUI(){ stageLabel.textContent=`${Math.min(stageIndex(currentStage)+1,STAGES.length)}/${STAGES.length}`; barFill.style.width=`${progressPercent()}%`; modeTag.textContent = unlocked?'Premium':'Demo'; modeTag.className='pill '+(unlocked?'full':'demo'); localStorage.setItem('fe_stage', currentStage); }

/* =================== CLOUD =================== */
async function callCloud(messages){
  const r = await fetch(`${CLOUD_ENDPOINT}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
  const j = await r.json(); return j.output || "No response.";
}
const tryParse = s=>{try{const t=s.trim().replace(/^```(?:json)?/i,'').replace(/```$/,'');return JSON.parse(t)}catch{return null}};

/* =================== AGENT =================== */
function currentStyle(){ return agentMemory.style || "coach"; }
function activeModuleIds(){ return modules.map(m=>m.id); }

async function agentAsk(userTextOrNull){
  const lastUser = [...history].reverse().find(m=>m.role==='user')?.content || "";
  agentMemory.style = detectStyleFrom(lastUser) || agentMemory.style || "coach";
  localStorage.setItem('fe_memory', JSON.stringify(agentMemory));

  const context = [
    { role:"system", content: systemPrime(currentStyle(), currentStage, activeModuleIds()) },
    { role:"system", content: `MEMORY:${JSON.stringify(agentMemory)}` },
    { role:"system", content: `CURRICULUM_PROMPT:${PROMPTS[currentStage]||""}` },
    ...history.slice(-10),
  ];
  if (userTextOrNull !== null) context.push({ role:"user", content: userTextOrNull });

  let out = await callCloud(context);
  let parsed = tryParse(out);

  if (!parsed || (parsed.confidence ?? 0) < 0.6){
    const nudge = [
      { role:"system", content: systemPrime(currentStyle(), currentStage, activeModuleIds()) },
      { role:"system", content: `MEMORY:${JSON.stringify(agentMemory)}` },
      { role:"system", content: `CURRICULUM_PROMPT:${PROMPTS[currentStage]||""}` },
      ...history.slice(-10),
      { role:"user", content: "Return STRICT JSON. If user drifts, steer back to the current stage. Expand as needed; don't ask just one question." }
    ];
    out = await callCloud(nudge);
    parsed = tryParse(out) || { say: sanitizeSay(out), stage: currentStage, next_questions: [], memory_delta:{}, confidence:.7 };
  }

  if (parsed.memory_delta && typeof parsed.memory_delta==='object'){
    const allow=["skills","audience","offer","price","style","blocked_by"]; for(const k of allow){ if(typeof parsed.memory_delta[k]==='string' && parsed.memory_delta[k]) agentMemory[k]=parsed.memory_delta[k]; }
    localStorage.setItem('fe_memory', JSON.stringify(agentMemory));
  }
  if (parsed.stage && STAGES.includes(parsed.stage)) currentStage = parsed.stage;

  return sanitizeSay(parsed.say);
}

/* =================== BOOT (single-shot) =================== */
function sessionResumed(){ return sessionStorage.getItem('fe_resumed')==='1'; }
function markResumed(){ sessionStorage.setItem('fe_resumed','1'); }

async function boot(){
  aiStatus.textContent="Booting the Trainer‚Ä¶";
  inputEl.disabled=false; sendBtn.disabled=false;
  dedupeHistory(); render(); updateProgressUI();

  const last = history[history.length-1];
  const stale = Date.now() - (lastTouch||0) > 90*1000;

  if (history.length===0){
    push('assistant', PROMPTS.opener);
    markResumed();
  } else if (!sessionResumed() && (stale || (last && last.role==='user'))){
    const next = await agentAsk("Continue the current stage and steer me back on track.");
    push('assistant', next); markResumed();
  }
  aiStatus.textContent="Ready.";
}
boot();

/* =================== CHAT =================== */
async function generate(userText){
  push('user', userText);
  aiStatus.textContent="Thinking‚Ä¶";
  const reply = await agentAsk(null);
  push('assistant', reply);
  aiStatus.textContent="Ready.";
}
sendBtn.onclick=()=>{ const t=inputEl.value.trim(); if(!t) return; inputEl.value=""; generate(t); };
inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* =================== EXPORT =================== */
document.getElementById('export').onclick = async ()=>{
  const briefTask = `
User memory: ${JSON.stringify(agentMemory)}
Create a crisp execution brief (<700 words):
- Offer: name, audience, promise, price
- Product page bullets + Gumroad blurb
- 72-hour launch checklist (Day 1‚Äì3) at $5/day
- 5 ad hooks + 3 headlines
Tone: sharp, irreverent, no fluff.`;
  const report = await callCloud([{role:"system",content:"You compile briefs."},...history.slice(-16),{role:"user",content:briefTask}]);
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}.h{font-size:28px;font-weight:800;margin:0 0 4px}.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}</style></head>
<body><div class="wrap"><div class="h">The Freedom Engine ‚Äî Export</div>
<div class="sub">Generated ${new Date().toLocaleString()}</div>
<div class="card"><h3>Execution Brief</h3><pre>${esc(report)}</pre></div></div></body></html>`;
  downloadBlob(html,'text/html','freedom-engine-export.html');
};

/* =================== MENU (Save/Load/Reset/Wake/Unlock) =================== */
const menu = document.getElementById('menu'); document.getElementById('menuBtn').onclick=()=>menu.classList.toggle('open');
document.addEventListener('click',e=>{ if(!menu.contains(e.target)) menu.classList.remove('open'); });

document.getElementById('saveSnap').onclick=()=>{
  const snap={when:new Date().toISOString(),memory:agentMemory,stage:currentStage,history,modules};
  downloadBlob(JSON.stringify(snap,null,2),'application/json',`freedom-snapshot-${Date.now()}.json`);
};
document.getElementById('loadBtn').onclick=()=>document.getElementById('loadSnap').click();
document.getElementById('loadSnap').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const snap=JSON.parse(await f.text());
    agentMemory=snap.memory||agentMemory; currentStage=snap.stage||currentStage; history=Array.isArray(snap.history)?snap.history:history; modules=Array.isArray(snap.modules)?snap.modules:modules;
    localStorage.setItem('fe_memory',JSON.stringify(agentMemory));
    localStorage.setItem('fe_stage',currentStage);
    localStorage.setItem('fe_history',JSON.stringify(history));
    localStorage.setItem('fe_modules',JSON.stringify(modules));
    dedupeHistory(); render(); updateProgressUI();
    push('assistant',"Snapshot loaded. We‚Äôll pick up exactly where you left off.");
  }catch{ alert("Bad snapshot file."); }
});
document.getElementById('reset').onclick=()=>{
  if(confirm("Reset all progress?")){
    history=[]; agentMemory={"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""};
    startTs=0; localStorage.removeItem('fe_history'); localStorage.removeItem('fe_stage'); localStorage.removeItem('fe_memory'); localStorage.removeItem('fe_last_touch'); localStorage.removeItem('fe_start_ts'); sessionStorage.removeItem('fe_resumed');
    render(); updateProgressUI(); push('assistant',"Fresh slate. Let's do it right this time. " + PROMPTS.opener);
  }
};
document.getElementById('wake').onclick=()=>push('assistant',"Context refreshed. If you drift, I‚Äôll drag you back to the current step.");
document.getElementById('switchMode').onclick=()=>{ if(confirm("Switch to Demo and forget your license on this device?")){ localStorage.removeItem('fe_unlocked'); sessionStorage.clear(); location.reload(); } };
document.getElementById('buy').onclick=()=>window.open(GUMROAD_URL,'_blank');
document.getElementById('unlock').onclick=async()=>{
  const key=prompt("Paste your license key:"); if(!key) return;
  const body = CORE_PRODUCT_ID ? {license_key:key.trim(), product_id:CORE_PRODUCT_ID} : {license_key:key.trim()};
  const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)}).then(r=>r.json()).catch(()=>({ok:false}));
  if(r.ok){ localStorage.setItem('fe_unlocked','1'); unlocked=true; updateProgressUI(); push('assistant',"Premium engaged. Answer the opener‚Äîthen we move fast."); }
  else alert("Key didn‚Äôt verify. Check your Gumroad receipt.");
};

/* =================== MODULE STORE =================== */
function renderModules(){
  modulesGrid.innerHTML = MODULES.map(m=>{
    const active = modules.some(x=>x.id===m.id);
    return `<div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h4>${m.name}</h4>
        <span class="badge" style="border-color:${active?'#1f4b3c':'#4a2a47'};background:${active?'rgba(61,220,151,.12)':'rgba(255,124,186,.12)'}">${active?'Active':'Locked'}</span>
      </div>
      <div style="color:#cfd6ff;font-size:13px;margin-bottom:8px">${m.desc}</div>
      <div class="row">
        ${active?`<button class="btn ok small" data-act="deactivate" data-id="${m.id}">Deactivate</button>`:
          `<button class="btn primary small" data-act="unlock" data-id="${m.id}">Unlock ${m.price}</button>`}
        <button class="btn ghost small" data-act="preview" data-id="${m.id}">Preview</button>
      </div>
    </div>`;
  }).join('');
}
modulesBtn.onclick=()=>{ renderModules(); modulesModal.classList.add('open'); };
document.getElementById('closeModules').onclick=()=>modulesModal.classList.remove('open');
modulesGrid.addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act; const mod = MODULES.find(x=>x.id===id); if(!mod) return;

  if(act==='preview'){
    push('assistant', `Preview: **${mod.name}** ‚Äî ${mod.desc}\nAsk me to apply it and I‚Äôll show you how it changes your current step.`);
  }
  if(act==='deactivate'){
    modules = modules.filter(x=>x.id!==id); localStorage.setItem('fe_modules',JSON.stringify(modules)); renderModules();
    push('assistant', `${mod.name} deactivated. Back to the core curriculum.`);
  }
  if(act==='unlock'){
    const key=prompt(`Paste the license key for ${mod.name}:`); if(!key) return;
    const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim(), product_id:mod.product_id})}).then(r=>r.json()).catch(()=>({ok:false}));
    if(r.ok){ modules=[...modules.filter(x=>x.id!==id), {id:mod.id, when:Date.now()}]; localStorage.setItem('fe_modules',JSON.stringify(modules)); renderModules(); push('assistant', `${mod.name} unlocked. I‚Äôll incorporate it automatically where relevant.`); }
    else alert("That key didn‚Äôt verify for this module.");
  }
});

/* =================== tiny io =================== */
function downloadBlob(content,mime,name){ const blob=new Blob([content],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }

/* =================== MENU UX =================== */
const menu = document.getElementById('menu'); document.getElementById('menuBtn').onclick=()=>menu.classList.toggle('open');
document.addEventListener('click',e=>{ if(!menu.contains(e.target) && e.target!==modulesBtn && !modulesModal.contains(e.target)) menu.classList.remove('open'); });
</script>
</body>
</html>
