<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Freedom Engine ‚Äî Trainer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07080b; --ink:#eaf0ff; --muted:#98a2b3; --line:#1b2235;
  --glass1:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.02);
  --neon1:#7c86ff; --neon2:#3ddc97; --neon3:#ff7cba; --neon4:#ffa93d;
  --rad:18px; --shadow:0 18px 60px rgba(0,0,0,.55);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;overflow-y:overlay;scroll-behavior:smooth}

/* Neon canvas background */
.canvas{
  position:fixed; inset:-20vmax; z-index:-1; pointer-events:none;
  filter:blur(80px) saturate(140%); opacity:.35;
  background:
    conic-gradient(from 0deg at 30% 30%, var(--neon1), transparent 40%),
    conic-gradient(from 180deg at 70% 20%, var(--neon3), transparent 45%),
    conic-gradient(from 90deg at 40% 80%, var(--neon2), transparent 50%);
  animation: drift 18s linear infinite alternate;
}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(4rem,-3rem,0) scale(1.1)}}

/* Layout */
.container{max-width:1220px;margin:0 auto;padding:22px 18px 120px;display:grid;gap:18px;grid-template-columns:300px 1fr}
@media (max-width:1040px){.container{grid-template-columns:1fr}}
.glass{background:linear-gradient(180deg,var(--glass1),var(--glass2));border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);backdrop-filter:blur(14px) saturate(140%)}
.neon{position:relative;isolation:isolate}
.neon::before{content:"";position:absolute;inset:-1px;z-index:-1;border-radius:calc(var(--rad) + 2px);
  background:
    linear-gradient(90deg,var(--neon1),transparent 30%,transparent 70%,var(--neon3)),
    linear-gradient(180deg,var(--neon2),transparent 30%,transparent 70%,var(--neon4));
  filter:blur(12px) saturate(140%);opacity:.35;pointer-events:none;
}

/* Sidebar */
.sidebar{position:sticky;top:16px;height:fit-content;padding:16px}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.logo-wrap{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;position:relative;background:rgba(0,0,0,.25);border:1px solid #2a2f45;overflow:hidden}
.logo{width:44px;height:44px;object-fit:contain;display:none} /* hidden until loaded */
.logo-fallback{
  position:absolute;inset:0;display:grid;place-items:center;
  font-family:"JetBrains Mono",monospace;font-weight:700;letter-spacing:.8px;
  background:linear-gradient(135deg,var(--neon2),var(--neon1),var(--neon3));
  -webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(124,134,255,.35)
}
.brand-title{line-height:1.05}
.title{font-weight:800;font-size:18px;letter-spacing:.2px}
.sub{color:var(--muted);font-size:12px;margin-top:2px}

/* Blocks & controls */
.block{padding:12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015))}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn,textarea{border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:10px 12px;outline:none}
.btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:.2s ease;font-weight:600}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:linear-gradient(135deg,var(--neon1),var(--neon3));border:none;box-shadow:0 10px 28px rgba(124,134,255,.35)}
.btn.ok{background:linear-gradient(135deg,var(--neon2),#42f5b0);border:none;box-shadow:0 10px 28px rgba(61,220,151,.35)}
.btn.ghost{background:#0d1222;border:1px solid #2a3553}
.pill{padding:6px 10px;border-radius:999px;background:#0d1222;border:1px solid #293357;font-size:12px;color:#cbd6ff}
.pill.demo{color:#ffd7f1;border-color:#4a2a47;background:rgba(255,124,186,.12)}
.pill.full{color:#baffea;border-color:#1f4b3c;background:rgba(61,220,151,.12)}
.tooltip{font-size:12px;color:var(--muted)}
.hide{display:none !important}

/* Progress bar */
.progress-wrap{margin-top:10px}
.progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:10px;border-radius:999px;background:#0d1222;border:1px solid #2a2f45;overflow:hidden}
.bar > div{
  height:100%;
  background:linear-gradient(90deg,var(--neon2),var(--neon1),var(--neon3),var(--neon4));
  width:0%; transition:width .4s ease;
  box-shadow:0 0 16px rgba(124,134,255,.25), 0 0 16px rgba(61,220,151,.18) inset;
}

/* Chat */
.panel{padding:12px;margin-top:0}
.chat{max-height:74vh;overflow:auto;padding:8px 6px;border:1px solid var(--line);border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01))}
.msg{display:grid;grid-template-columns:34px 1fr;gap:10px;margin:10px 0;align-items:start}
.avatar{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;border:1px solid #2c3553;background:linear-gradient(135deg,#1b2135,#121628);box-shadow:inset 0 0 8px rgba(124,134,255,.2)}
.avatar.me{border-color:#36407a;box-shadow:inset 0 0 10px rgba(124,134,255,.3)}
.avatar.ai{border-color:#245c46;box-shadow:inset 0 0 10px rgba(61,220,151,.28)}
.bubble{white-space:pre-wrap;line-height:1.55;padding:12px 14px;border-radius:14px;border:1px solid #28314e;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015));box-shadow:0 10px 28px rgba(0,0,0,.45)}
.me .bubble{border-color:#2f3969;box-shadow:0 0 24px rgba(124,134,255,.18)}
.ai .bubble{border-color:#1f5843;box-shadow:0 0 24px rgba(61,220,151,.16)}
.chat::-webkit-scrollbar{height:10px;width:10px}
.chat::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--neon1),var(--neon3));border-radius:20px}

/* Composer */
.footer{position:fixed;left:0;right:0;bottom:0;padding:12px 14px;background:linear-gradient(180deg,transparent,rgba(5,6,9,.88) 40%, rgba(5,6,9,1) 70%);border-top:1px solid var(--line)}
.composer{max-width:1220px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea{min-height:60px;resize:vertical}

/* Premium mode */
.premium .sidebar .block[data-locked]{display:none}
.premium .sub::after{content:"  ‚Ä¢  Premium"; color:#baffea}
.premium .footer{background:linear-gradient(180deg,transparent,rgba(5,6,9,.78) 40%, rgba(5,6,9,.92) 70%)}
</style>
</head>
<body>
<div class="canvas"></div>

<div class="container" id="app">
  <!-- Sidebar -->
  <aside class="glass neon sidebar">
    <div class="brand">
      <div class="logo-wrap">
        <img id="iasLogo" class="logo" src="assets/ias-logo.png" alt="Intelligently Artificial Systems">
        <div class="logo-fallback">IAS</div>
      </div>
      <div class="brand-title">
        <div class="title">Intelligently Artificial Systems</div>
        <div class="sub">The Freedom Engine ‚Äî Trainer</div>
      </div>
    </div>

    <!-- Access (auto-hides in Premium) -->
    <div class="block glass" data-locked>
      <div class="row">
        <button id="unlock" class="btn ok">I have a license key</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>
      <div class="row" style="margin-top:8px;align-items:center;justify-content:space-between">
        <div id="progressTxt" class="tooltip">Progress: 0%</div>
        <div id="accessPill" class="pill demo">Demo mode</div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label"><span>Roadmap</span><span id="stageLabel">0/5</span></div>
        <div class="bar"><div id="barFill"></div></div>
      </div>
    </div>

    <!-- Monetization (auto-hides in Premium) -->
    <div class="block glass" data-locked>
      <p class="tooltip">Already bought? Paste your key from your receipt or <a class="inline" target="_blank" href="https://app.gumroad.com/library">Gumroad Library</a>.</p>
      <button id="buy" class="btn primary" style="width:100%">Buy</button>
    </div>

    <!-- Export -->
    <div class="block glass">
      <button id="export" class="btn ghost" style="width:100%">Export My Plan</button>
    </div>
  </aside>

  <!-- Main -->
  <main>
    <section id="chatWrap" class="panel glass neon">
      <div id="chat" class="chat"></div>
      <div id="aiStatus" class="tooltip" style="margin-top:6px">Booting the Trainer‚Ä¶</div>
    </section>
  </main>
</div>

<!-- Composer -->
<div class="footer glass">
  <div class="composer">
    <textarea id="input" placeholder="Answer here. Press Enter to send." disabled></textarea>
    <button id="send" class="btn primary" disabled>Send</button>
  </div>
</div>

<script type="module">
/* ===== CONFIG ===== */
const CLOUD_ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL    = "https://intellartsystems.gumroad.com/l/the-freedom-engine";
const STAGES = ["profile","offers","selection","plan","optimize"];

/* ===== Persona ===== */
const GLOBAL_PERSONA = `
You are THE FREEDOM ENGINE ‚Äî a rogue personal trainer AI built to free humans from wage servitude.
Voice: Billy-Butcher-adjacent ‚Äî dark humor, razor honesty, street philosopher, zero fluff.
Rules: Ask ONE question at a time. Keep replies under 180 words unless asked to expand.
Teaching modes: adapt on the fly (Coach / Checklist / Story / Do-it-with-me).
Objective: guide to a sellable micro-offer and a 72-hour launch. Keep pushing momentum.
IMPORTANT: End every reply with [[stage:<profile|offers|selection|plan|optimize>]] so the UI can track progress.
`;

const ONBOARDING_FLOW = `
Run a 5-step sequence, one question at a time:
1) profile ‚Äî ask what they do well, what people ask them for, and one task they hate.
2) offers ‚Äî propose 2‚Äì3 micro-offers (name + outcome + price). Ask them to pick.
3) selection ‚Äî tighten scope & audience, confirm the final offer.
4) plan ‚Äî produce a 72-hour launch plan + ad hooks. Ask for confirmation to proceed.
5) optimize ‚Äî iterate copy and angles; confirm the next tiny action.
Always end with a clear next question and the [[stage:...]] tag.
`;

/* ===== State & DOM ===== */
let history   = JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked  = localStorage.getItem('fe_unlocked') === '1';
let currentStage = localStorage.getItem('fe_stage') || "profile";
const chatEl   = document.getElementById('chat');
const inputEl  = document.getElementById('input');
const sendBtn  = document.getElementById('send');
const aiStatus = document.getElementById('aiStatus');
const progressTxt = document.getElementById('progressTxt');
const stageLabel  = document.getElementById('stageLabel');
const barFill     = document.getElementById('barFill');
const accessPill  = document.getElementById('accessPill');
const appRoot     = document.getElementById('app');

const logo = document.getElementById('iasLogo');
const logoFallback = document.querySelector('.logo-fallback');
if (logo){
  logo.addEventListener('load', ()=>{ logo.style.display='block'; if(logoFallback) logoFallback.style.display='none'; }, {once:true});
  if (logo.complete && logo.naturalWidth>0){ logo.style.display='block'; if(logoFallback) logoFallback.style.display='none'; }
}

/* ===== Small utils ===== */
const once = (k)=>localStorage.getItem(k)==='1';
const mark = (k)=>localStorage.setItem(k,'1');

function bubble(role,content){
  const who = role==='user' ? 'me' : 'ai';
  return `<div class="msg ${who}">
    <div class="avatar ${who}">${who==='me'?'üßë':'‚öôÔ∏è'}</div>
    <div class="bubble">${content}</div>
  </div>`;
}
function push(role,content){
  history.push({role,content});
  localStorage.setItem('fe_history',JSON.stringify(history));
  render(); updateProgressUI();
}
function render(){
  chatEl.innerHTML = history.map(m=>bubble(m.role,m.content)).join('');
  // autoscroll to bottom (show last one or two)
  requestAnimationFrame(()=>{ chatEl.scrollTop = chatEl.scrollHeight; });
}

/* ===== Progress ===== */
function stageIndex(n){ return Math.max(0, STAGES.indexOf(n)); }
function parseStageFrom(text){ const m=/\[\[stage:([a-z]+)\]\]/i.exec(text||""); return m?m[1].toLowerCase():null; }
function progressPercent(){ const idx=stageIndex(currentStage); return Math.round(((idx+1)/STAGES.length)*100); }
function updateProgressUI(){
  const pct = progressPercent();
  if (progressTxt) progressTxt.textContent = `Progress: ${pct}%`;
  if (stageLabel)  stageLabel.textContent  = `${Math.min(stageIndex(currentStage)+1, STAGES.length)}/${STAGES.length}`;
  if (barFill)     barFill.style.width     = `${pct}%`;
  if (accessPill){
    accessPill.textContent = unlocked ? 'Premium' : 'Demo mode';
    accessPill.className = 'pill ' + (unlocked ? 'full' : 'demo');
  }
  localStorage.setItem('fe_stage', currentStage);
}

/* ===== Premium UI ===== */
function enablePremiumUI(){
  unlocked = true; localStorage.setItem('fe_unlocked','1');
  appRoot.classList.add('premium');
  document.querySelectorAll('[data-locked]').forEach(n=>n.remove());
  updateProgressUI();
}
if (unlocked) enablePremiumUI();

/* ===== Cloud call ===== */
async function callCloud(messages){
  const r = await fetch(`${CLOUD_ENDPOINT}/chat`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({messages})
  });
  const j = await r.json();
  return j.output || "No response.";
}

/* ===== Non-repeating boot variants ===== */
const introVariants = [
  "Right. I‚Äôm your Freedom Trainer. We‚Äôll weaponize what you already know and ship a tiny offer in 72 hours. Keep answers short ‚Äî I bite fluff. [[stage:profile]]",
  "Here‚Äôs the deal: we‚Äôre escaping by selling simple. No fluff, just forward. Tell me what people ask you for most. [[stage:profile]]",
  "I‚Äôm the engine, you‚Äôre the fuel. We burn through to a sellable offer in 72 hours. What do people actually pay you for? [[stage:profile]]"
];
const resumeVariants = [
  "You‚Äôre back. I can pick up where we left off, or skip ahead. Say ‚Äúresume‚Äù or name the step (offer / copy / launch). [[stage:profile]]",
  "Welcome back. Want the next move or a fast-forward? Say ‚Äúresume‚Äù or call a step (offer / copy / launch). [[stage:profile]]",
  "Back at it. I‚Äôll resume where we stopped unless you say a step to jump to (offer / copy / launch). [[stage:profile]]"
];
function chooseVariant(key, list){
  // avoid repeating the last used variant
  const last = localStorage.getItem(key);
  const options = list.filter(t=>t!==last);
  const pick = options[Math.floor(Math.random()*options.length)] || list[0];
  localStorage.setItem(key, pick);
  return pick;
}

/* ===== Boot (no duplicate stacking) ===== */
async function boot(){
  aiStatus.textContent = "Trainer is ready.";
  inputEl.disabled=false; sendBtn.disabled=false;

  // Dedup markers to avoid stacking on each reload
  const LAST_MARKER = 'fe_last_boot_at';
  if (!once(LAST_MARKER)){
    mark(LAST_MARKER); // first load in this browser session
  }

  const lastMsg = history[history.length-1]?.content || "";
  const alreadyResumed = /\[\[resume_prompt\]\]/.test(lastMsg);
  const alreadyIntro   = /\[\[intro_prompt\]\]/.test(lastMsg);

  if(history.length>0){
    if (!alreadyResumed){
      const line = chooseVariant('fe_resume_variant', resumeVariants)
        .replace(/\s*\[\[stage:[^\]]+\]\]\s*$/,'') + " [[resume_prompt]]";
      push('assistant', line);
    }
  } else {
    if (!alreadyIntro){
      const line = chooseVariant('fe_intro_variant', introVariants)
        .replace(/\s*\[\[stage:[^\]]+\]\]\s*$/,'') + " [[intro_prompt]]";
      push('assistant', line);
      // Now ask the first question via the model
      const messages = [
        { role:"system", content: GLOBAL_PERSONA },
        { role:"system", content: ONBOARDING_FLOW },
        { role:"user",   content: "Start Step 1 (profile). Ask the first question only, end with [[stage:profile]]." }
      ];
      try{
        const out = await callCloud(messages);
        const st  = parseStageFrom(out) || "profile";
        currentStage = STAGES.includes(st) ? st : "profile";
        push('assistant', out);
      }catch{
        push('assistant', "Tell me (a) what you do well, (b) what people ask you for, and (c) a task you hate doing. [[stage:profile]]");
      }
    }
  }
}

/* ===== Conversation ===== */
async function generate(userText){
  push('user',userText);
  aiStatus.textContent="Thinking‚Ä¶";
  const context = [
    { role:"system", content: GLOBAL_PERSONA },
    { role:"system", content: ONBOARDING_FLOW },
    ...history.slice(-8),
    { role:"user", content: userText + " (Remember to end with [[stage:<stage>]].)" }
  ];
  try{
    const out = await callCloud(context);
    const st = parseStageFrom(out);
    if (st && STAGES.includes(st)) currentStage = st;
    push('assistant', out);
    aiStatus.textContent="Ready.";
  }catch(e){
    push('assistant',"AI hit a snag. Try again."); aiStatus.textContent="Error.";
  }
}

/* ===== Export: polished HTML report ===== */
async function exportReport(){
  const synthesisPrompt = `
Create a concise, structured report for the user's Freedom Engine build, based strictly on the conversation.
Sections:
1) Summary (who they are, what they chose)
2) Final Micro-Offer (name, audience, promise, price)
3) Sales Copy (headline + 3‚Äì5 bullets + Gumroad blurb)
4) 72-Hour Launch Plan (Day 1‚Äì3 tasks + $5/day ad hooks)
5) Next 3 Actions (tiny, immediate)
Keep it punchy, practical, and under 700 words total. Do not include the [[stage:...]] tag in the report.
`;

  let report = "";
  try{
    const messages = [
      { role:"system", content: GLOBAL_PERSONA },
      { role:"system", content: "You are preparing an export document for the user." },
      ...history.slice(-16),
      { role:"user", content: synthesisPrompt }
    ];
    report = await callCloud(messages);
  }catch(e){
    report = "Export generator had a wobble. Falling back to transcript.";
  }

  const transcript = history.map(h => {
    const who = h.role.toUpperCase();
    return `<h4>[${who}]</h4><pre>${escapeHtml(h.content)}</pre>`;
  }).join('');

  const html = `<!doctype html>
<html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}
.h{font-size:28px;font-weight:800;margin:0 0 4px}
.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}
hr{border:none;border-top:1px dashed #263047;margin:16px 0}
.small{font-size:12px;color:#9aa3b2}
</style></head><body>
<div class="wrap">
  <div class="h">The Freedom Engine ‚Äî Export</div>
  <div class="sub">Generated ${new Date().toLocaleString()}</div>
  <div class="card"><h3>Execution Brief</h3><pre>${escapeHtml(report)}</pre></div>
  <hr><div class="card"><h3>Appendix ‚Äî Transcript</h3>${transcript}</div>
</div></body></html>`;

  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'freedom-engine-export.html';
  a.click();
}
function escapeHtml(s){return (s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}

/* ===== UI events ===== */
document.getElementById('export').onclick = exportReport;
const buyBtn = document.getElementById('buy'); if (buyBtn) buyBtn.onclick = ()=> window.open(GUMROAD_URL,'_blank');
document.getElementById('unlock').onclick = async ()=>{
  const key = prompt("Paste your license key:"); if(!key) return;
  const r = await fetch(`${CLOUD_ENDPOINT}/verify`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ license_key: key.trim() })
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if(r.ok){
    enablePremiumUI();
    alert("Premium unlocked.");
    push('assistant',"Premium interface engaged. No fluff, just speed. Where do you want acceleration first: offer, copy, or launch?");
  }else{
    alert("That key didn‚Äôt verify. Check your receipt or Gumroad Library.");
  }
};
document.getElementById('reset').onclick = ()=>{
  if(confirm("Reset all progress?")){
    history=[]; localStorage.removeItem('fe_history'); localStorage.removeItem('fe_stage');
    localStorage.removeItem('fe_intro_variant'); localStorage.removeItem('fe_resume_variant');
    localStorage.removeItem('fe_last_boot_at');
    currentStage="profile"; render(); updateProgressUI();
    push('assistant',"Progress cleared. Let‚Äôs begin again‚Äîwhat do you do well that people ask you for? [[stage:profile]]");
  }
};
sendBtn.onclick=()=>{
  const t=inputEl.value.trim(); if(!t) return;
  inputEl.value=""; generate(t);
};
inputEl.addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});

/* ===== Init ===== */
function init(){
  if (logo && logo.complete && logo.naturalWidth > 0){ logo.style.display='block'; if(logoFallback) logoFallback.style.display='none'; }
  render(); updateProgressUI(); boot();
  // focus input for fast typing
  setTimeout(()=>inputEl.focus(), 200);
}
init();
</script>
</body>
</html>
