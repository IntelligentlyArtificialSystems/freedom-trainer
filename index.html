<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Freedom Engine â€” Personal AI Trainer</title>

<!-- Brand font -->
<link rel="preload" href="Techfont-Italica.ttf" as="font" type="font/ttf" crossorigin>
<style>
  :root{
    --bg:#0a0d17;
    --glass1:rgba(255,255,255,.08);
    --glass2:rgba(255,255,255,.14);
    --ink:#e9f1ff;
    --muted:#a9b4cd;
    --accent:#7bffde;
    --pink:#ff6ad5;
    --gold:#ffc34d;
    --good:#6fffaf;
    --danger:#ff6b6b;
    --radius:22px;
    --shadow:0 24px 70px rgba(0,0,0,.45);
  }

  @font-face{
    font-family:"Techfont";
    src:url("Techfont-Italica.ttf") format("truetype");
    font-display:swap;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
  body{
    font-family:Techfont, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    letter-spacing:.25px; line-height:1.25;
    /* REVERTED background (calm neon glass look) */
    background:
      radial-gradient(900px 600px at 10% -10%, rgba(255,0,255,.12), transparent),
      radial-gradient(800px 600px at 90% 30%, rgba(0,255,255,.10), transparent),
      url("bg-warp.png");
    background-size:cover, cover, cover;
    background-attachment:fixed;
  }

  .wrap{max-width:1200px;margin:22px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:380px 1fr;gap:20px}
  @media (max-width:960px){ .grid{grid-template-columns:1fr; gap:16px} }

  .card{
    position:relative; border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--glass2); box-shadow:var(--shadow);
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
  }
  .pad{padding:18px}
  .row{display:flex;align-items:center;gap:10px}
  .muted{color:var(--muted)}
  .headline{font-weight:800; letter-spacing:.35px}

  /* Header/Brand (reverted proportions) */
  .brand{display:grid; grid-template-columns:120px 1fr; gap:14px}
  .logoBox{
    height:120px; width:120px; border-radius:20px; overflow:hidden; position:relative;
    background: radial-gradient(60% 60% at 20% 20%, rgba(255,255,255,.15), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.18)
  }
  /* 3x bigger logo, masked inside the box; slow spin */
  .logoSpin{
    position:absolute; inset:-100%;
    width:300%; height:300%; margin:auto; transform-origin:50% 50%;
    background:url("ias-logo.png") center/contain no-repeat;
    animation:spin 36s linear infinite;
    filter:drop-shadow(0 0 12px rgba(255,255,255,.25));
  }
  @keyframes spin{ to { transform: rotate(360deg); } }

  .titleBlock h1{margin:0; font-size:44px; line-height:1; text-shadow:0 8px 40px rgba(0,0,0,.5)}
  .sub{margin-top:6px}
  .pill{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;letter-spacing:.3px}
  .pill.demo{background:rgba(255,90,190,.18); color:#ffd8f1; border:1px solid rgba(255,90,190,.35)}
  .pill.full{background:rgba(120,255,170,.18); color:#d9ffef; border:1px solid rgba(120,255,170,.35)}

  /* Roadmap bar */
  .barWrap{margin-top:14px}
  .bar{position:relative;height:14px;border-radius:14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);overflow:hidden}
  .bar>i{position:absolute;inset:0;width:0%;transition:width .45s ease;
    background:linear-gradient(90deg,#7afcff,#ffb86b,#ff6ad5,#e4ff6a)}
  .barEnd{position:absolute;right:8px;top:-22px;font-size:12px;color:var(--muted)}
  .barMeta{color:var(--muted);margin-top:4px}

  .rowBtns{display:flex;gap:10px;margin-top:14px}
  .btn{
    user-select:none;cursor:pointer;border:none;outline:none;
    padding:10px 14px;border-radius:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18); color:var(--ink); font-weight:800; box-shadow:var(--shadow)
  }
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:rgba(255,255,255,.06)}
  .btn.cta{background:linear-gradient(180deg, rgba(255,120,200,.45), rgba(255,120,200,.18));
    border-color:rgba(255,120,200,.5)}

  /* Kebab & menu (open upward; above composer) */
  .kebabWrap{position:relative; z-index:40}
  .menu{
    position:absolute; bottom:48px; left:0; width:240px; padding:10px;
    background:rgba(9,14,28,.96); border:1px solid rgba(255,255,255,.18); border-radius:14px;
    display:none; z-index:1000;
  }
  .menu.open{display:block}
  .menu .btn{width:100%; text-align:left; padding:10px 12px}

  /* Demo CTA (unchanged) */
  .cta{display:block; margin-top:12px}
  body.is-premium .cta{display:none!important}
  body.is-demo .cta{display:block!important}

  /* Chat (reverted dimensions + no clipping) */
  .chat{min-height:420px; display:flex; flex-direction:column}
  @media (max-width:960px){ .chat{min-height:560px} }
  .msgs{flex:1; overflow:auto; padding:16px}
  .bubble{
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18); border-radius:18px;
    padding:14px 16px; margin:8px 8px; box-shadow:var(--shadow)
  }
  .sys{background:linear-gradient(180deg, rgba(120,255,200,.14), rgba(255,255,255,.06))}
  .me{background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))}
  .msgRow{display:grid; grid-template-columns:32px 1fr; gap:10px}
  .avatar{height:32px;width:32px;border-radius:10px;display:grid;place-items:center;
    background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);font-size:16px}
  .composer{display:grid; grid-template-columns:1fr 86px; gap:10px; padding:14px;
    border-top:1px solid rgba(255,255,255,.14); z-index:30}
  .input{height:54px;border-radius:14px;border:1px solid rgba(255,255,255,.2);
    background:rgba(7,11,22,.75);color:var(--ink);padding:14px 16px;font:inherit}
  .foot{font-size:12px;color:var(--muted);padding:8px 14px}

  /* Sacred-geometry overlays for PREMIUM ONLY (subtle, neon, animated) */
  .premium-geo{display:none}
  body.is-premium .premium-geo{
    display:block; pointer-events:none; position:absolute; inset:-8px; border-radius:inherit; z-index:0;
    background:
      radial-gradient(closest-side, rgba(123,255,222,.28), transparent 70%),
      conic-gradient(from 0deg, rgba(255,105,210,.16), rgba(130,255,210,.16), rgba(255,255,160,.16), rgba(255,105,210,.16));
    mix-blend-mode:screen;
    animation:geoSpin 42s linear infinite;
    mask-image:
      radial-gradient(circle at 50% 50%, black 62%, transparent 64%),
      radial-gradient(circle at 50% 50%, transparent 0 44%, black 46% 52%, transparent 54%),
      radial-gradient(circle at 50% 50%, transparent 0 26%, black 28% 34%, transparent 36%),
      radial-gradient(circle at 50% 50%, black 0 18%, transparent 20%);
    mask-composite: intersect;
  }
  @keyframes geoSpin{ to { transform: rotate(360deg); } }

  /* Mode switches */
  body.is-premium #licenseItems{display:none!important}
  body.is-premium #modeTag.demo{display:none!important}
  body.is-demo #modeTag.full{display:none!important}
</style>
</head>
<body class="is-demo">
  <div class="wrap">
    <div class="grid">

      <!-- LEFT: Brand/Roadmap (reverted layout) -->
      <div class="card pad" id="leftCard">
        <div class="premium-geo"></div>
        <div class="brand">
          <div class="logoBox"><div class="logoSpin" aria-hidden="true"></div></div>
          <div class="titleBlock">
            <h1 class="headline" id="appTitle">The Freedom Engine</h1>
            <div class="row sub">
              <span class="muted">Personal AI Trainer</span>
              <span id="modeTag" class="pill demo">Demo</span>
            </div>
            <div class="barMeta">Roadmap: <span id="barLabel">1/5</span></div>
          </div>
        </div>

        <div class="barWrap">
          <div class="bar"><i id="barFill"></i></div>
          <div class="barEnd" id="barEnd">1/5</div>
        </div>

        <div class="rowBtns">
          <button class="btn" id="exportBtn">Export</button>
          <div class="kebabWrap">
            <button class="btn ghost" id="modulesBtn">Modules</button>
          </div>
          <div class="kebabWrap">
            <button class="btn ghost" id="kebab">â€¦</button>
            <div class="menu" id="menu">
              <button class="btn ghost" id="saveSnap">Save Snapshot</button>
              <button class="btn ghost" id="loadSnap">Load Snapshot</button>
              <button class="btn ghost" id="poke">Wake the Engine</button>
              <button class="btn ghost" id="reset">Reset Progress</button>
              <button class="btn ghost" id="signout">Switch to Demo / Sign Out</button>

              <div id="licenseItems">
                <button class="btn ghost" id="haveKey">I have a license key</button>
                <button class="btn cta" id="buy">Buy</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Big CTA (Demo only) -->
        <div class="cta" id="demoCta">
          <div class="card pad" style="margin-top:12px; background:linear-gradient(180deg, rgba(255,120,200,.15), rgba(255,120,200,.08))">
            <div class="row" style="justify-content:space-between; gap:12px; flex-wrap:wrap">
              <div>Unlock Full Engine â€” <strong>$29</strong><br>
                <span class="muted">Cloud-saved progress across devices. Premium modules included.</span>
              </div>
              <button class="btn cta" id="buyBig">Unlock $29</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Conversation (reverted layout) -->
      <div class="card chat" id="chatCard">
        <div class="premium-geo"></div>
        <div class="msgs" id="msgs"></div>
        <div class="composer">
          <input id="composer" class="input" placeholder="Answer here. Press Enter to send." />
          <button class="btn" id="send">Send</button>
        </div>
        <div class="foot" id="foot">Ready.</div>
      </div>

    </div>
  </div>

<script>
/* ----------------- CONFIG ----------------- */
const BUILD_ID = "fe-rollback-prem-geo-01";
const CLOUD_ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const FE_SCHEMA = "2";

/* ----------------- STATE ------------------ */
let verified = localStorage.getItem('fe_verified') === '1';
let licenseKey = localStorage.getItem('fe_license') || "";
let unlocked = verified && !!licenseKey;
let currentStage = +(localStorage.getItem('fe_stage') || 1);
let history = JSON.parse(localStorage.getItem('fe_history') || "[]");

if (localStorage.getItem('fe_schema') !== FE_SCHEMA){
  localStorage.clear(); localStorage.setItem('fe_schema', FE_SCHEMA);
  verified=false; licenseKey=""; unlocked=false; currentStage=1; history=[];
}

/* ----------------- MODE ------------------- */
function computeMode(){
  const q = new URLSearchParams(location.search);
  if(q.get('mode')==='demo') return { premium:false };
  return { premium:(verified && !!licenseKey) };
}
function enforceUIState(){
  const { premium } = computeMode();
  document.body.classList.toggle('is-premium', premium);
  document.body.classList.toggle('is-demo', !premium);
  const cta = document.getElementById('demoCta');
  if (cta) cta.style.display = premium ? 'none' : 'block';
  const tag = document.getElementById('modeTag');
  if (tag){ tag.textContent = premium ? 'Premium' : 'Demo'; tag.className='pill ' + (premium?'full':'demo');}
}

/* -------------- DOM HOOKS ----------------- */
const msgs = document.getElementById('msgs');
const composer = document.getElementById('composer');
const sendBtn = document.getElementById('send');
const exportBtn = document.getElementById('exportBtn');
const modulesBtn = document.getElementById('modulesBtn');
const kebab = document.getElementById('kebab');
const menu = document.getElementById('menu');
const haveKey = document.getElementById('haveKey');
const buy = document.getElementById('buy');
const buyBig = document.getElementById('buyBig');
const saveSnap = document.getElementById('saveSnap');
const loadSnap = document.getElementById('loadSnap');
const resetBtn = document.getElementById('reset');
const signoutBtn = document.getElementById('signout');
const pokeBtn = document.getElementById('poke');
const barFill = document.getElementById('barFill');
const barEnd = document.getElementById('barEnd');
const barLabel = document.getElementById('barLabel');

/* -------------- HELPERS ------------------- */
function stagePct(){ return Math.max(0, Math.min(100, (currentStage-1) * 25)); }
function updateBar(){
  const pct = stagePct();
  barFill.style.width = pct + "%";
  barEnd.textContent = currentStage + "/5";
  barLabel.textContent = currentStage + "/5";
}
function scrollEnd(){ msgs.scrollTop = msgs.scrollHeight; }
function sanitizeText(t){ return (t || "").toString().replaceAll("undefined","").replace(/\s{3,}/g," ").trim(); }
function push(role, content){
  const row = document.createElement('div'); row.className='msgRow';
  const avatar = document.createElement('div'); avatar.className='avatar';
  avatar.textContent = role === 'user' ? 'ðŸ’¬' : 'âš™';
  const b = document.createElement('div'); b.className='bubble ' + (role==='user'?'me':'sys');
  b.textContent = content;
  row.append(avatar, b); msgs.append(row);
  history.push({role,content,ts:Date.now()});
  localStorage.setItem('fe_history', JSON.stringify(history));
  scrollEnd();
}

/* -------------- CLOUD SAVE ---------------- */
async function cloudLoad(){
  try{
    if(!verified || !licenseKey) return false;
    const r = await fetch(`${CLOUD_ENDPOINT}/progress?license_key=${encodeURIComponent(licenseKey)}`);
    const j = await r.json();
    if(j?.ok && j.data){
      currentStage = j.data.stage || 1;
      history = j.data.history || [];
      localStorage.setItem('fe_stage', currentStage);
      localStorage.setItem('fe_history', JSON.stringify(history));
      return true;
    }
  }catch(e){}
  return false;
}
async function cloudSave(data){
  if(!verified || !licenseKey) return false;
  try{
    const r = await fetch(`${CLOUD_ENDPOINT}/progress`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ license_key: licenseKey, data })
    });
    const j = await r.json(); return !!j?.ok;
  }catch(e){ return false; }
}
async function cloudSaveWithBackoff(){
  if(await cloudSave({stage:currentStage,history})) return;
  await new Promise(r=>setTimeout(r,350));
  await cloudSave({stage:currentStage,history});
}

/* --------------- EXPORT ------------------- */
function exportPlan(){
  const md = `# The Freedom Engine â€” Plan (Stage ${currentStage}/5)
Generated: ${new Date().toISOString()}

## Recent
${history.slice(-8).map(h=>`- **${h.role}**: ${sanitizeText(h.content)}`).join('\n')}

## Next
- Say "help me choose" for quick options.
- Name a lane: design / writing / coaching / dev / other.
`;
  const blob = new Blob([md],{type:"text/markdown;charset=utf-8"});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = `freedom-engine-plan-${Date.now()}.md`; a.click(); URL.revokeObjectURL(a.href);
}

/* --------------- MENU --------------------- */
kebab.addEventListener('click', ()=> menu.classList.toggle('open'));
document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==kebab) menu.classList.remove('open'); });

/* --------------- LICENSE ------------------ */
buy?.addEventListener('click', ()=>window.open('https://intellartsystems.gumroad.com/l/the-freedom-engine','_blank'));
buyBig?.addEventListener('click', ()=>window.open('https://intellartsystems.gumroad.com/l/the-freedom-engine','_blank'));
haveKey?.addEventListener('click', async ()=>{
  const key = prompt("Enter your license key:");
  if(!key) return;
  try{
    const r = await fetch(`${CLOUD_ENDPOINT}/verify`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ license_key: key })
    }).then(x=>x.json());
    if(r.ok){
      licenseKey = key.trim(); verified=true; unlocked=true;
      localStorage.setItem('fe_license', licenseKey);
      localStorage.setItem('fe_verified', '1');
      enforceUIState();
      await cloudSaveWithBackoff();
      const pulled = await cloudLoad();
      render(true);
      push('assistant', pulled ? "Premium engaged. Clean slate synced. Letâ€™s move." : "Premium engaged. Clean slate saved. Letâ€™s move.");
    }else{
      alert("Couldnâ€™t verify that key. Double-check your Gumroad receipt.");
    }
  }catch(e){ alert("Network error. Try again."); }
});

/* -------------- SNAP/RESET/SIGNOUT -------- */
saveSnap.onclick = ()=>{
  const blob = new Blob([JSON.stringify({stage:currentStage,history},null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = `freedom-engine-snapshot-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
};
loadSnap.onclick = ()=>{
  const i = document.createElement('input'); i.type='file'; i.accept='.json,application/json';
  i.onchange = ev=>{
    const f = ev.target.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const j = JSON.parse(r.result);
        currentStage = j.stage || 1; history = j.history || [];
        localStorage.setItem('fe_stage', currentStage);
        localStorage.setItem('fe_history', JSON.stringify(history));
        cloudSaveWithBackoff(); render(true); push('assistant',"Snapshot loaded.");
      }catch(e){ alert("Bad file."); }
    }; r.readAsText(f);
  }; i.click();
};
resetBtn.onclick = ()=>{
  if(!confirm("Reset your local progress to Stage 1?")) return;
  currentStage=1; history=[]; localStorage.setItem('fe_stage',1); localStorage.setItem('fe_history',"[]");
  updateBar(); render(true); push('assistant',"Fresh slate. Letâ€™s start right."); cloudSaveWithBackoff();
};
signoutBtn.onclick = ()=>{
  if(!confirm("Sign out and switch to Demo? Local data will clear.")) return;
  localStorage.clear(); verified=false; licenseKey=""; unlocked=false; currentStage=1; history=[];
  enforceUIState(); updateBar(); render(true);
  push('assistant',"Back to Demo. Use the $29 button when youâ€™re ready to unlock.");
};
pokeBtn.onclick = ()=> push('assistant',"Iâ€™m here. Say â€œhelp me chooseâ€ or name a lane (design / writing / coaching / dev / other).");

/* --------------- CHAT --------------------- */
function mentorIntro(){
  return "Welcome to the Freedom Engine. Iâ€™ll carry strategy, templates, and deadlines; youâ€™ll do bite-size reps. Weâ€™ll ship one in ~72 hours. No monk retreat required.\n\nPick a lane and Iâ€™ll carry the heavy boxes:\nâ€¢ design â€¢ writing â€¢ coaching â€¢ dev â€¢ other\n\nIf youâ€™re blank, say â€œhelp me chooseâ€ and Iâ€™ll pitch options.";
}
function systemPrompt(){
  return `You are The Freedom Engine, a personal AI trainer.
Style: mentor energy, warm + darkly funny, light bullying toward success.
Rules:
- Explain, then ask for one small action.
- Curriculum stages (1..5): profile â†’ offer â†’ copy â†’ launch â†’ iterate.
- Avoid â€œwhat do people thank you forâ€. Use: â€œpick a laneâ€ or â€œhelp me chooseâ€.
- Always end with the next micro-action.`;
}
function render(skipIntro=false){
  msgs.innerHTML=""; updateBar(); enforceUIState();
  if(!skipIntro){
    if(history.length){ push('assistant',"Youâ€™re back. Want me to resume or jump ahead? Say â€œresumeâ€ or name the step (offer / copy / launch)."); }
    else { push('assistant', mentorIntro()); }
  }else{
    for(const m of history.slice(-20)){ push(m.role,m.content); }
  }
  setTimeout(scrollEnd, 50);
}

async function sendMessage(){
  const text = sanitizeText(composer.value); if(!text) return;
  menu.classList.remove('open'); composer.value=""; push('user', text);

  const t = text.toLowerCase().trim();
  if(["help","help me choose","choose","idk","i dont know","no clue","?"].includes(t)){
    push('assistant',"Cool. Pick a lane and Iâ€™ll pitch 3 tiny offers:\nâ€¢ design â€¢ writing â€¢ coaching â€¢ dev â€¢ other\nSay one of those, or â€œsurprise meâ€.");
    return;
  }
  if(t.includes("design")||t.includes("writing")||t.includes("coaching")||t.includes("dev")){
    currentStage=Math.min(5,currentStage+1); localStorage.setItem('fe_stage', currentStage);
    updateBar(); cloudSaveWithBackoff();
  }

  try{
    const r = await fetch(`${CLOUD_ENDPOINT}/chat`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        messages:[{role:"system",content:systemPrompt()}, ...history.slice(-16), {role:"user",content:text}]
      })
    });
    const j = await r.json();
    const out = sanitizeText(j?.output || j?.message || "Alright. Next: name a lane or say â€œhelp me chooseâ€.");
    push('assistant', out);
  }catch(e){
    push('assistant',"Network nap. Keep going: name a lane (design/writing/coaching/dev) or say â€œhelp me chooseâ€.");
  }
}

sendBtn.onclick = sendMessage;
composer.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
exportBtn.onclick = exportPlan;
modulesBtn.onclick = ()=> alert("Module upgrades hub coming soon (Premium shows new tiles automatically).");

/* --------------- BOOT --------------------- */
(async function boot(){
  enforceUIState(); updateBar();
  if(unlocked){ await cloudLoad(); }
  render(history.length>0);
})();
</script>
</body>
</html>
