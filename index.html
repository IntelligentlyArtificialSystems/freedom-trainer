<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>

<style>
/* ---------- Brand font ---------- */
@font-face{
  font-family:"TechfontItalica";
  src:url("./Techfont-Italica.ttf") format("truetype");
  font-display:swap;
}

/* ---------- Theme ---------- */
:root{
  --ink:#f7f8ff; --ink-dim:#cfd4ff;
  --ring:rgba(255,255,255,.22);
  --glass1:rgba(255,255,255,.14);
  --glass2:rgba(255,255,255,.08);

  --mag:#ff7bf1; --pink:#ff76b5; --sun:#ffb84d; --gold:#ffd86a; --lime:#8dff6a; --vio:#ae8bff; --scar:#ff6a6a;

  /* Logo tuning */
  --logo-x:50%;
  --logo-y:52%;
  --logo-scale:.95;            /* logo size (you asked: about half of the big one) */
  --logo-speed:36s;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);
  font-family:"TechfontItalica",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:#0f0a1c;
}

/* Old neon, muted behind glass */
.bg{
  position:fixed; inset:0; z-index:-4;
  background:
    radial-gradient(1200px 700px at 15% 15%, rgba(255,123,241,.32), transparent 60%),
    radial-gradient(1200px 900px at 85% 10%, rgba(255,184,77,.28), transparent 65%),
    radial-gradient(1000px 800px at 20% 85%, rgba(141,255,106,.22), transparent 65%),
    linear-gradient(180deg, #1b1032 0%, #2a184a 50%, #25143f 100%);
  filter:saturate(125%) blur(0.2px);
}

/* Premium: subtle sacred geometry (existing layer) */
.prem-geo{
  position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.14; display:none;
}
body.is-premium .prem-geo{ display:block; }
.prem-geo svg{ width:100%; height:100%; }
.prem-geo .spin path{ transform-origin:50% 50%; animation:geoSpin 60s linear infinite; }
@keyframes geoSpin{ to{ transform:rotate(360deg) } }

/* Premium: NEW iridescent wallpaper under everything (half opacity of the above) */
.prem-geo-bg{
  position:fixed; inset:-10%; z-index:-3; pointer-events:none; display:none; opacity:.07; filter:saturate(140%);
}
body.is-premium .prem-geo-bg{ display:block; }
.prem-geo-bg .field{
  width:100%; height:100%;
  background:
    radial-gradient(600px 600px at 25% 30%, #ff7bf150, transparent 60%),
    radial-gradient(800px 800px at 75% 70%, #8dff6a50, transparent 65%),
    radial-gradient(700px 700px at 50% 50%, #ffd86a50, transparent 55%);
  animation:iris 30s linear infinite;
}
@keyframes iris{
  0%{ filter:hue-rotate(0deg) blur(0.5px); transform:scale(1); }
  50%{ filter:hue-rotate(120deg) blur(0.7px); transform:scale(1.02); }
  100%{ filter:hue-rotate(360deg) blur(0.5px); transform:scale(1); }
}

/* Layout */
.wrap{display:grid;grid-template-columns:440px 1fr;gap:24px;padding:24px;min-height:100dvh}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}

.card{
  position:relative;border-radius:24px;padding:18px;border:1px solid var(--ring);
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}

/* ---------- Brand header ---------- */
.brand{display:grid;grid-template-columns:148px 1fr;gap:18px;align-items:center;margin-bottom:16px}
.logo-box{
  height:148px;border-radius:24px;border:1px solid var(--ring);
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
  overflow:hidden;position:relative;isolation:isolate;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 12px 40px rgba(0,0,0,.35)
}
.logo{
  position:absolute; left:var(--logo-x); top:var(--logo-y);
  width:520px;height:520px; object-fit:contain; pointer-events:none;
  transform-origin:center center;
  /* flip Y so it spins ‚Äúinwards‚Äù as requested */
  transform:translate(-50%,-50%) scale(var(--logo-scale)) scaleY(-1);
  animation:spinIn var(--logo-speed) linear infinite reverse;
  /* multicolor glow (stacked drop-shadows) */
  filter:
    drop-shadow(0 0 12px rgba(255,255,255,.22))
    drop-shadow(0 0 18px rgba(255,123,241,.35))
    drop-shadow(0 0 22px rgba(255,216,106,.28))
    drop-shadow(0 0 26px rgba(141,255,106,.28))
    drop-shadow(0 0 32px rgba(174,139,255,.25));
}
@keyframes spinIn{to{transform:translate(-50%,-50%) scale(var(--logo-scale)) scaleY(-1) rotateZ(360deg)}}

.titles h1{
  margin:0; line-height:1.02; letter-spacing:.4px;
  font-size:46px; font-weight:800;
  text-shadow:
    0 2px 0 rgba(0,0,0,.28),
    0 12px 30px rgba(0,0,0,.45);       /* stronger pop */
}
.titles .sub{
  margin-top:6px;opacity:.92;font-weight:800;
  text-shadow:0 8px 20px rgba(0,0,0,.35);
}
.badge{display:inline-block;margin-left:8px;padding:5px 10px;border-radius:999px;color:#0b0c14;font-weight:900;font-size:13px;background:linear-gradient(90deg,#ff7bf1,#ffd86a)}
.badge.demo{background:linear-gradient(90deg,#ff6a6a,#ffd86a)}

/* ---------- Roadmap ---------- */
.road{margin-top:18px;border:1px solid var(--ring);border-radius:18px;padding:16px;background:rgba(255,255,255,.10)}
.bar{height:12px;border-radius:999px;background:rgba(14,10,25,.6);border:1px solid var(--ring);overflow:hidden}
.bar>span{display:block;height:100%;width:0%;transition:width .35s ease;background:linear-gradient(90deg,#ff7bf1,#ffb84d,#8dff6a,#ff6a6a)}
.bar-legend{display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:var(--ink-dim)}
.row{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}

/* Buttons keep brand font */
.btn{
  appearance:none;border:none;cursor:pointer;font-weight:900;
  color:#0b0c14;background:linear-gradient(180deg,#fff,#e9eefc);
  border-radius:999px;padding:10px 14px;
  box-shadow:0 8px 20px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.4);
  font-family:"TechfontItalica", system-ui, sans-serif;
}
.btn-ghost{background:rgba(255,255,255,.08);color:var(--ink);border:1px solid var(--ring)}
.btn:active{transform:translateY(1px)}

/* Kebab */
.drop{position:relative}
.drop-menu{
  position:fixed;display:none;min-width:280px;max-height:60dvh;overflow:auto;
  background:#0e0a1fe6;backdrop-filter:blur(10px);border:1px solid var(--ring);border-radius:16px;padding:8px;z-index:9999
}
.drop.open .drop-menu{display:block}
.drop-menu .item{padding:10px 12px;border-radius:10px;font-weight:800;color:var(--ink);font-family:"TechfontItalica",system-ui}
.drop-menu .item:hover{background:#ffffff18}
.drop-menu .danger{background:#ff5b5b1a;border:1px solid #ff5b5b45}

/* Demo CTA */
.cta{margin-top:14px;padding:16px;border-radius:16px;border:1px solid var(--ring);background:linear-gradient(180deg,rgba(50,10,35,.92),rgba(45,15,40,.88));text-align:center}
.cta .big{width:100%;padding:14px 16px;border-radius:12px;font-size:18px;font-weight:900;background:linear-gradient(90deg,#ff7bf1,#ffd86a);color:#0b0c14;font-family:"TechfontItalica",system-ui}
.cta small{display:block;margin-top:8px;color:var(--ink-dim)}

/* ---------- Chat (ANCHOR composer & chat) ---------- */
.chat-col{
  position:relative; height:calc(100dvh - 48px);   /* fixed column height */
  display:flex; flex-direction:column;
}
@media(max-width:980px){ .chat-col{ height:calc(100dvh - 48px); } }

.chat{
  flex:1; min-height:0; overflow:auto;              /* scroll instead of expand */
  padding:18px 18px 96px;                           /* bottom space for composer */
  background:linear-gradient(180deg,rgba(255,255,255,.11),rgba(255,255,255,.06));
  border:1px solid var(--ring);border-radius:24px;scroll-behavior:smooth;
  /* hide scrollbars visually */
  scrollbar-width:none;
}
.chat::-webkit-scrollbar{width:0;height:0}

.bubble{
  position:relative;margin:14px 0;padding:14px 16px 14px 56px;border-radius:18px;border:1px solid var(--ring);
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05));box-shadow:0 10px 30px rgba(0,0,0,.25)
}
.bubble .who{
  position:absolute;left:12px;top:12px;width:32px;height:32px;display:grid;place-items:center;border-radius:10px;
  background:#0e0a1fe6;border:1px solid var(--ring)
}

/* Composer is ANCHORED */
.composer{
  position:absolute; left:0; right:0; bottom:0;
  display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:end;
  padding-top:10px;
}
textarea{width:100%;min-height:54px;max-height:180px;resize:vertical;padding:14px 16px;color:var(--ink);background:#120d20;border:1px solid var(--ring);border-radius:16px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif !important}
.send{height:54px;border-radius:16px;font-weight:900;background:linear-gradient(130deg,#ff7bf1,#ffd86a);color:#0b0c14;font-family:"TechfontItalica",system-ui}

/* ---------- Modal (Modules) ---------- */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10000; }
.modal.open{ display:flex; }
.modal::before{ content:""; position:absolute; inset:0; background:rgba(6,4,12,.6); backdrop-filter:blur(4px); }
.panel{
  position:relative; z-index:1; width:min(720px,92vw);
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  border:1px solid var(--ring); border-radius:20px; padding:16px;
  box-shadow:0 30px 80px rgba(0,0,0,.55);
}
.modlist .mod{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:12px; border:1px solid var(--ring); border-radius:14px; margin:10px 0; }
.modlist .lock{ opacity:.6 }
</style>
</head>
<body>
<div class="bg"></div>

<!-- Premium iridescent wallpaper (new, behind existing) -->
<div class="prem-geo-bg" aria-hidden="true"><div class="field"></div></div>

<!-- Premium sacred geometry overlay (existing) -->
<div class="prem-geo" aria-hidden="true">
  <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
    <g class="spin" fill="none" stroke="url(#g)" stroke-width="0.4" opacity="0.85">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%"  stop-color="#ff7bf1"/><stop offset="50%" stop-color="#ffd86a"/><stop offset="100%" stop-color="#8dff6a"/>
        </linearGradient>
      </defs>
      <circle cx="50" cy="50" r="30"/>
      <circle cx="50" cy="50" r="20"/>
      <path d="M50 18 L68 62 L32 62 Z"/>
      <g opacity="0.45">
        <circle cx="50" cy="35" r="10"/>
        <circle cx="65" cy="58" r="10"/>
        <circle cx="35" cy="58" r="10"/>
      </g>
    </g>
  </svg>
</div>

<div class="wrap">

  <!-- LEFT -->
  <section class="card" id="left">
    <div class="brand">
      <div class="logo-box">
        <img class="logo" src="ias-logo.png" alt="IAS Logo">
      </div>
      <div class="titles">
        <h1>The Freedom Engine</h1>
        <div class="sub">Personal AI Trainer <span class="badge demo" id="tierBadge">Demo</span></div>
      </div>
    </div>

    <div class="road">
      <div class="bar"><span id="bar"></span></div>
      <div class="bar-legend"><span>Roadmap</span><span id="barText">1/5</span></div>
      <div class="row">
        <button class="btn btn-ghost" id="exportBtn">Export</button>
        <button class="btn btn-ghost" id="modulesBtn">Modules</button>

        <div class="drop" id="kebab">
          <button class="btn btn-ghost" id="kebabBtn">‚Ä¶</button>
          <div class="drop-menu" id="kebabMenu">
            <div class="item" id="saveSnap">Save Snapshot</div>
            <div class="item" id="loadSnap">Load Snapshot</div>
            <div class="item" id="wake">Wake the Engine</div>
            <div class="item danger" id="reset">Reset Progress</div>
            <div class="item" id="switchMode">Switch to Demo / Sign Out</div>
            <div class="item" id="enterKey">I have a license key</div>
            <div class="item" id="buy">Buy</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEMO CTA -->
    <div class="cta" id="demoCTA" style="display:none">
      <button class="big" id="ctaBuy">$29 ‚Äî Unlock Full Engine</button>
      <small>Cloud saves + premium modules included.</small>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="chat-col">
    <div class="card chat" id="chat"></div>
    <div class="composer">
      <textarea id="input" placeholder="Answer here. Press Enter to send."></textarea>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </section>

</div>

<!-- Modules modal -->
<div class="modal" id="modModal" aria-hidden="true">
  <div class="panel">
    <h3 style="margin:6px 6px 10px 6px">Modules</h3>
    <div class="modlist" id="modList"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn btn-ghost" id="modClose">Close</button>
    </div>
  </div>
</div>

<script>
/* ======= Config / State ======= */
const WORKER_BASE = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const STAGES = 5;

const state = {
  tier: localStorage.getItem("fe_tier") || "demo",
  license: localStorage.getItem("fe_license") || "",
  roadmap: 1,
  messages: [],
  greeted:false,
  lastWake:0,
  sending:false
};

const el = {
  bar:document.getElementById("bar"),
  barText:document.getElementById("barText"),
  chat:document.getElementById("chat"),
  input:document.getElementById("input"),
  send:document.getElementById("sendBtn"),
  kebab:document.getElementById("kebab"),
  kebabBtn:document.getElementById("kebabBtn"),
  kebabMenu:document.getElementById("kebabMenu"),
  demoCTA:document.getElementById("demoCTA"),
  tierBadge:document.getElementById("tierBadge"),
  enterKey:document.getElementById("enterKey"),
  buy:document.getElementById("buy"),
  ctaBuy:document.getElementById("ctaBuy"),
  switchMode:document.getElementById("switchMode"),
  reset:document.getElementById("reset"),
  saveSnap:document.getElementById("saveSnap"),
  loadSnap:document.getElementById("loadSnap"),
  modulesBtn:document.getElementById("modulesBtn"),
  modModal:document.getElementById("modModal"),
  modList:document.getElementById("modList"),
  modClose:document.getElementById("modClose"),
  wake:document.getElementById("wake")
};

/* ======= Small utilities ======= */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function normalize(t=""){ return t.trim().toLowerCase(); }
function autoscroll(){ el.chat.scrollTop = el.chat.scrollHeight; }

/* Debounce helper for cloud saves */
let saveTimer=null;
function debounceSave(fn, delay=400){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(fn, delay);
}

/* Bubble rendering
   FE_PATCH: add `record=true` flag ‚Äî lets us render history without duplicating state */
function pushBubble(who,text,{record=true}={}){
  if(!text) return;
  const b=document.createElement("div");
  b.className="bubble";
  b.innerHTML=`<div class="who">${who==="user"?"üí¨":"‚öôÔ∏è"}</div>${text}`;
  el.chat.appendChild(b);
  if(record) state.messages.push({who,text});
  requestAnimationFrame(autoscroll);
}

/* ======= UI ======= */
function setTier(t){
  state.tier=t; localStorage.setItem("fe_tier",t);
  const isDemo = t==="demo";
  document.body.classList.toggle("is-premium", !isDemo); // sacred geometry toggle
  el.demoCTA.style.display = isDemo ? "block":"none";
  el.enterKey.style.display = isDemo ? "block":"none";
  el.buy.style.display      = isDemo ? "block":"none";
  el.switchMode.style.display = isDemo ? "none":"block";
  el.tierBadge.textContent  = isDemo ? "Demo":"Premium";
  el.tierBadge.classList.toggle("demo", isDemo);
}

function updateBar(){
  const pct = Math.max(1,Math.min(STAGES,state.roadmap))/STAGES*100;
  el.bar.style.width = pct+"%";
  el.barText.textContent = `${Math.max(1,state.roadmap)}/${STAGES}`;
}

/* ======= Kebab placement (clamped to viewport) ======= */
function openKebab(){
  el.kebab.classList.add("open");
  const m = el.kebabMenu;
  const btnRect = el.kebabBtn.getBoundingClientRect();
  m.style.display="block";
  requestAnimationFrame(()=>{
    const mw = m.offsetWidth || 280, mh = m.offsetHeight || 180;
    const margin=8;
    const roomBelow = window.innerHeight - btnRect.bottom;
    let top = roomBelow > mh + margin ? (btnRect.bottom + 8) : (btnRect.top - mh - 8);
    let left = btnRect.right - mw;
    top  = Math.max(margin, Math.min(window.innerHeight - mh - margin, top));
    left = Math.max(margin, Math.min(window.innerWidth  - mw - margin, left));
    m.style.top  = `${top}px`;
    m.style.left = `${left}px`;
  });
}
function closeKebab(){ el.kebab.classList.remove("open"); el.kebabMenu.style.display="none"; }

/* ======= Cloud (D1) ======= */
async function cloudSaveNow(){
  if(state.tier!=="premium" || !state.license) return;
  const payload = { roadmap:state.roadmap, messages:state.messages.slice(-300) };
  try{
    await fetch(WORKER_BASE+"/progress",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({license_key:state.license,data:JSON.stringify(payload)})});
  }catch(e){/* silent fail */}
}
function cloudSave(){ debounceSave(cloudSaveNow, 450); }

async function cloudLoad(){
  if(state.tier!=="premium" || !state.license) return false;
  try{
    const r=await fetch(WORKER_BASE+"/progress?license_key="+encodeURIComponent(state.license));
    const j=await r.json();
    if(j.ok && j.found && j.data){
      const data=JSON.parse(j.data);
      state.roadmap = Number(data.roadmap)||1;
      state.messages = Array.isArray(data.messages)? data.messages.slice(-100):[];
      el.chat.innerHTML="";
      // FE_PATCH: render history WITHOUT re-adding to state
      state.messages.forEach(m=>pushBubble(m.who,m.text,{record:false}));
      // state.messages already set; don't mutate further here
      updateBar(); return true;
    }
  }catch(e){/* ignore */}
  return false;
}

/* ======= License verify (no more instant upgrade) ======= */
async function verifyLicense(key){
  try{
    const r=await fetch(WORKER_BASE+"/verify",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({license_key:key.trim()})});
    const j=await r.json();
    return Boolean(j && (j.valid || j.ok)); // accept {valid:true} or {ok:true}
  }catch(e){
    return false;
  }
}

/* ======= Conversational flow ======= */
function aiReply(userText){
  const t = normalize(userText);

  if(!t){ pushBubble("ai","Give me a crumb or say <em>help me choose</em>."); return; }

  if(/(help me choose|idk|no clue|stuck)/.test(t)){
    pushBubble("ai",
      `Okay, options time. Reply 1‚Äì5:<br>
       1) <b>Design</b> ‚Ä¢ logos/graphics<br>
       2) <b>Writing</b> ‚Ä¢ copy/guides<br>
       3) <b>Coaching</b> ‚Ä¢ audits/accelerators<br>
       4) <b>Dev</b> ‚Ä¢ tiny tools/setups<br>
       5) <b>Other</b> ‚Ä¢ pitch me your chaos`);
    return;
  }

  const m=t.match(/^\s*([1-5])\s*$/);
  if(m){
    const lane=["","Design","Writing","Coaching","Dev","Other"][Number(m[1])];
    state.roadmap=Math.max(2,state.roadmap);
    updateBar();
    pushBubble("ai",
      `Locked: <b>${lane}</b>.<br>Now: what‚Äôs a <b>tiny deliverable in 48h</b> someone would pay for? One sentence.`);
    cloudSave(); return;
  }

  pushBubble("ai",
    `Got it. I‚Äôll translate that into a tiny paid offer.<br>
     Quick confirm: who‚Äôs the <b>one real human</b> you‚Äôd ship this to first? (Name or describe them.)`);
  state.roadmap=Math.min(5,state.roadmap+1); updateBar(); cloudSave();
}

/* ======= Greeting once ======= */
function greet(){
  if(state.greeted) return; state.greeted=true;
  [...document.querySelectorAll(".bubble")].forEach(b=>{ if(b.dataset.greet==="1") b.remove(); });
  const text = `
    Welcome to the Freedom Engine. I‚Äôm your personal trainer for tiny paid offers.<br><br>
    I‚Äôll carry strategy, templates, and deadlines; you‚Äôll do bite-size reps. We‚Äôll ship one in ~72 hours.<br><br>
    To get moving, pick a lane or say <em>‚Äúhelp me choose‚Äù</em>:<br>
    ‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other
  `;
  const b=document.createElement("div");
  b.className="bubble"; b.dataset.greet="1";
  b.innerHTML=`<div class="who">‚öôÔ∏è</div>${text}`;
  el.chat.appendChild(b); requestAnimationFrame(autoscroll);
}

/* ======= Modules modal ======= */
function renderModules(){
  const isDemo = state.tier==="demo";
  el.modList.innerHTML="";
  const rows = [
    {name:"Offer Sprint", desc:"Guided 72-hour micro-offer builder", locked:isDemo},
    {name:"Copy Booster", desc:"Emails, posts, and landing copy blocks", locked:isDemo},
    {name:"Launch Maps", desc:"Checklists + timelines", locked:isDemo},
  ];
  rows.forEach(r=>{
    const div=document.createElement("div");
    div.className="mod"+(r.locked?" lock":"");
    div.innerHTML=`<div><b>${r.name}</b><br><span class="dim">${r.desc}</span></div>
                   <div>${r.locked? "üîí" : "<button class='btn btn-ghost'>Enable</button>"}</div>`;
    el.modList.appendChild(div);
  });
}

/* ======= Boot ======= */
document.addEventListener("DOMContentLoaded", async ()=>{
  // kebab
  el.kebabBtn.addEventListener("click", (e)=>{
    e.stopPropagation(); if(el.kebab.classList.contains("open")) closeKebab(); else openKebab();
  });
  window.addEventListener("resize", ()=>{ if(el.kebab.classList.contains("open")) openKebab(); });
  document.addEventListener("click", (e)=>{ if(!el.kebab.contains(e.target)) closeKebab(); });

  // demo/premium
  const gumroad="https://intellartsystems.gumroad.com/l/the-freedom-engine";
  el.buy.addEventListener("click", ()=>window.open(gumroad,"_blank"));
  el.ctaBuy?.addEventListener("click", ()=>window.open(gumroad,"_blank"));

  el.enterKey.addEventListener("click", async ()=>{
    const key=prompt("Enter license key:"); if(!key) return;
    // FE_PATCH: verify before upgrading
    const valid = await verifyLicense(key);
    if(!valid){ alert("Invalid or inactive license."); return; }
    state.license=key.trim(); localStorage.setItem("fe_license",state.license);
    setTier("premium");
    const ok = await cloudLoad();
    if(!ok){ el.chat.innerHTML=""; greet(); }
    updateBar();
  });

  el.switchMode.addEventListener("click", ()=>{
    localStorage.removeItem("fe_license"); setTier("demo");
    state.license=""; state.roadmap=1; state.messages=[]; state.greeted=false;
    el.chat.innerHTML=""; greet(); updateBar();
  });

  el.reset.addEventListener("click", ()=>{
    state.roadmap=1; state.messages=[]; state.greeted=false;
    el.chat.innerHTML=""; greet(); updateBar(); cloudSave();
  });

  // export / snapshots
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const data={roadmap:state.roadmap,messages:state.messages,tier:state.tier};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="freedom-engine-snapshot.json"; a.click(); URL.revokeObjectURL(a.href);
  });
  el.saveSnap.addEventListener("click", ()=>{
    const data={roadmap:state.roadmap,messages:state.messages};
    const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="fe-local-snapshot.json"; a.click(); URL.revokeObjectURL(a.href);
  });
  el.loadSnap.addEventListener("click", ()=>{
    const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
    inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return;
      try{
        const d=JSON.parse(await f.text());
        state.roadmap=Math.max(1,Math.min(5,Number(d.roadmap)||1));
        // FE_PATCH: set state, render without re-recording
        state.messages=Array.isArray(d.messages)?d.messages.slice(-100):[];
        el.chat.innerHTML="";
        state.messages.forEach(m=>pushBubble(m.who,m.text,{record:false}));
        updateBar(); cloudSave();
      }catch{ alert("Bad snapshot file."); }
    }; inp.click();
  });

  // modules
  el.modulesBtn.addEventListener("click", ()=>{ renderModules(); el.modModal.classList.add("open"); });
  el.modClose.addEventListener("click", ()=> el.modModal.classList.remove("open"));
  el.modModal.addEventListener("click",(e)=>{ if(e.target===el.modModal) el.modModal.classList.remove("open"); });

  // wake (debounced)
  el.wake.addEventListener("click", ()=>{
    const now=Date.now(); if(now-state.lastWake<2000) return; state.lastWake=now;
    pushBubble("ai","Engine‚Äôs awake. I‚Äôve got caffeine and poor judgment. Where were we?");
  });

  // send (guard against double-send)
  async function send(){
    if(state.sending) return;
    const v=el.input.value.trim(); if(!v) return;
    state.sending=true;
    el.send.disabled=true; el.input.disabled=true;

    pushBubble("user",v);
    el.input.value="";
    await sleep(50); // tiny yield for UX
    aiReply(v);

    await sleep(200); // minimal lock to avoid double taps
    el.send.disabled=false; el.input.disabled=false; el.input.focus();
    state.sending=false;
  }
  el.send.addEventListener("click", send);
  el.input.addEventListener("keydown", e=>{ if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}});

  // init
  setTier(state.tier);
  let loaded=false;
  if(state.tier==="premium" && state.license){ loaded=await cloudLoad(); }
  if(!loaded || state.messages.length===0) greet();
  updateBar();
  requestAnimationFrame(autoscroll);
});
</script>
</body>
</html>
