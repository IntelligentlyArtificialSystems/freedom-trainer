<!DOCTYPE html>
<html lang="en" class="fe">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>
<!-- FE-UI v1.0.0 (locked) -->

<style>
/* ========== NAMESPACE LOCK ========== */
.fe :root{
  --bg:#0a0b14;
  --panel:#101327f0;
  --panel-2:#141938f0;
  --chip:#1a1f3f;
  --ink:#eef1ff;
  --ink-dim:#cfd6ff;
  --ring:rgba(153,171,255,.28);
  --glass-1:rgba(255,255,255,.10);
  --glass-2:rgba(255,255,255,.05);
  --n1:#7c86ff; --n2:#3ddc97; --n3:#ff7cba; --n4:#ffa93d;
  --shadow:0 14px 40px rgba(0,0,0,.45), inset 0 0 1px rgba(255,255,255,.12);
}
.fe *{box-sizing:border-box}
html.fe, .fe body{height:100%}
.fe body{
  margin:0; color:var(--ink);
  background: radial-gradient(1200px 800px at 8% -10%, #2b2b66 0%, #0a0b14 55%) fixed;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
  overflow:hidden;
}
/* star haze */
.fe body::before{
  content:""; position:fixed; inset:-20% -20% auto -20%; height:140%; pointer-events:none;
  background:
    radial-gradient(1200px 700px at 80% -20%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(900px 600px at 10% 110%, rgba(255,255,255,.06), transparent 60%);
  filter:saturate(120%);
}
/* premium shimmer */
.fe body.premium::after{
  content:""; position:fixed; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:.28;
  background:
    radial-gradient(600px 600px at 18% 24%, rgba(124,134,255,.45), transparent 60%),
    radial-gradient(740px 620px at 84% 18%, rgba(61,220,151,.35), transparent 62%),
    radial-gradient(800px 680px at 76% 80%, rgba(255,124,186,.35), transparent 58%),
    radial-gradient(820px 700px at 22% 78%, rgba(255,169,61,.30), transparent 60%);
  animation: fe-swirl 50s linear infinite;
  filter: blur(36px);
}
@keyframes fe-swirl{to{transform:rotate(360deg) scale(1.03)}}

.fe .wrap{display:grid; grid-template-columns: 420px 1fr; gap:22px; padding:22px; height:100%}
@media (max-width: 980px){
  .fe body{overflow:auto}
  .fe .wrap{grid-template-columns:1fr; gap:14px; padding:14px; height:auto}
}

/* cards */
.fe .card{
  background:
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05)) padding-box,
    radial-gradient(120% 120% at -10% -30%, #7bffad44, transparent 40%),
    radial-gradient(90% 90% at 120% 10%, #66e1ff33, transparent 40%),
    var(--panel);
  border:1px solid var(--ring);
  border-radius:22px; box-shadow:var(--shadow); position:relative; overflow:hidden;
}
.fe .inner{padding:20px}

/* left header */
.fe .header{display:grid; grid-template-rows:auto auto auto 1fr; gap:12px; height:100%}
.fe .brand{display:grid; grid-template-columns:140px 1fr; gap:16px; align-items:center}
@media(max-width:980px){ .fe .brand{grid-template-columns:110px 1fr} }
.fe .logo-box{
  width:140px;height:140px;border-radius:20px;background:linear-gradient(180deg,var(--glass-1),var(--glass-2));
  border:1px solid var(--ring); display:grid; place-items:center; overflow:hidden; box-shadow:var(--shadow)
}
@media(max-width:980px){ .fe .logo-box{width:110px;height:110px} }
/* 3x big logo clipped in the box */
.fe .logo{
  width:420px;height:420px; background:url("./ias-logo.png?v=fe1") center/contain no-repeat;
  animation: fe-logo 44s linear infinite;
  filter: drop-shadow(0 0 12px rgba(124,134,255,.35)) drop-shadow(0 0 18px rgba(61,220,151,.25));
}
@keyframes fe-logo{to{transform:rotate(360deg)}}

.fe .title h1{margin:0; line-height:1.05; font-weight:900; font-size:44px; letter-spacing:.4px;
  text-shadow:0 2px 0 rgba(0,0,0,.35), 0 0 16px rgba(102,225,255,.30)}
@media(max-width:980px){ .fe .title h1{font-size:34px} }
.fe .sub{opacity:.9; margin-top:6px; font-size:14px}
.fe .badge{display:inline-block; margin-left:8px; padding:6px 10px; border-radius:999px;
  background:#0f1532; border:1px solid var(--ring); font-size:12px; font-weight:800}

/* roadmap */
.fe .roadmap{margin-top:8px}
.fe .bar-head{display:flex;justify-content:space-between;font-size:12px;opacity:.9;margin:8px 2px 6px}
.fe .bar{height:14px;border-radius:999px;background:#050712;border:1px solid var(--ring);position:relative;overflow:hidden}
.fe .fill{position:absolute;inset:0 auto 0 0;width:20%;
  background:linear-gradient(90deg, var(--n2), var(--n1), var(--n3), var(--n4));
  border-right:1px solid rgba(255,255,255,.35)}

/* actions + kebab */
.fe .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
.fe .btn{background:#0d132d;color:var(--ink);border:1px solid var(--ring);
  padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.fe .btn.primary{background:linear-gradient(90deg, var(--n1), var(--n3)); color:#0a0b14; border:none}
.fe .btn.kebab{width:42px;height:42px;display:grid;place-items:center}
.fe .btn.kebab::after{content:"‚ãØ"; font-size:22px}

/* kebab menu above button */
.fe .menu{position:absolute;min-width:240px;background:var(--panel-2);border:1px solid var(--ring);
  border-radius:16px;box-shadow:var(--shadow);padding:8px;display:none;z-index:40}
.fe .menu.open{display:block}
.fe .menu .mi{padding:10px 12px;border-radius:12px;cursor:pointer}
.fe .menu .mi:hover{background:rgba(255,255,255,.08)}

/* demo CTA */
.fe .cta{margin-top:12px;padding:12px;border:1px dashed var(--ring);border-radius:16px;
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
.fe .cta-title{font-weight:900;margin-bottom:8px}
.fe .cta-note{font-size:13px;opacity:.9}

/* chat column */
.fe .chat{display:grid;grid-template-rows:1fr auto;height:100%}
.fe .surface{
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05)),var(--panel);
  border:1px solid var(--ring); border-radius:22px; padding:18px; overflow:auto; min-height:240px;
}
.fe .msg{background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.05));
  border:1px solid var(--ring); border-radius:18px; margin:12px 0; padding:16px 18px; box-shadow:var(--shadow); position:relative}
.fe .msg .head{position:absolute;left:-12px;top:-12px;width:36px;height:36px;display:grid;place-items:center;
  border-radius:10px;background:#141a3b;border:1px solid var(--ring)}
.fe .msg.user .head{background:linear-gradient(135deg, var(--n1), var(--n3));color:#0a0b14;font-weight:900}
.fe .msg.user .head::after{content:"üí¨"}
.fe .msg.bot  .head::after{content:"‚öôÔ∏è"}

.fe .composer{margin-top:10px;display:grid;grid-template-columns:1fr 84px;gap:10px}
.fe .composer textarea{
  resize:none;height:64px;border-radius:14px;border:1px solid var(--ring);
  background:#0d1126;color:var(--ink);padding:14px 16px;outline:none;box-shadow:var(--shadow)
}
.fe .composer button{
  height:64px;border-radius:14px;border:1px solid var(--ring);background:#101636;color:var(--ink);
  font-weight:900;cursor:pointer;box-shadow:var(--shadow);background-image:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04))
}

@media(max-width:980px){
  .fe .composer{grid-template-columns:1fr 76px}
  .fe .composer textarea{height:76px}
}
</style>
</head>

<body class="fe">
  <div class="wrap">
    <!-- LEFT PANEL -->
    <section class="card header" id="left">
      <div class="inner">
        <div class="brand">
          <div class="logo-box"><div class="logo" aria-hidden="true"></div></div>
          <div class="title">
            <h1>The Freedom Engine</h1>
            <div class="sub">Personal AI Trainer <span class="badge" data-mode-badge>Demo</span></div>
          </div>
        </div>

        <div class="roadmap">
          <div class="bar-head"><div>Roadmap</div><div data-roadmap-text>1/5</div></div>
          <div class="bar"><div class="fill" data-roadmap-fill style="width:20%"></div></div>
        </div>

        <div class="actions">
          <button class="btn" id="btnExport">Export</button>
          <button class="btn" id="btnModules">Modules</button>
          <button class="btn kebab" id="btnMore" aria-haspopup="menu" aria-expanded="false"></button>

          <div class="menu" id="menu" role="menu" aria-label="More">
            <div class="mi" id="miSave">Save Snapshot</div>
            <div class="mi" id="miLoad">Load Snapshot</div>
            <div class="mi" id="miWake">Wake the Engine</div>
            <div class="mi" id="miReset">Reset Progress</div>
            <div class="mi" id="miSign">Switch to Demo / Sign Out</div>
            <div class="mi" data-menu-have-key>I have a license key</div>
            <div class="mi" data-menu-buy>Buy</div>
          </div>
        </div>

        <!-- Demo CTA (hidden in Premium) -->
        <div class="cta" id="demoCta">
          <div class="cta-title">Unlock Full Engine ‚Äî <strong>$29</strong></div>
          <div class="cta-note">Keep your progress across devices. Premium modules included.</div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn primary" data-cta-buy>$29 ‚Äî Unlock Full Engine</button>
            <button class="btn" data-cta-have-key>I have a license key</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CHAT PANEL -->
    <section class="card chat" id="chatCard">
      <div class="surface" id="chatSurface" aria-live="polite"></div>
      <div class="composer">
        <textarea id="composer" placeholder="Answer here. Press Enter to send."></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </section>
  </div>

<script>
/* ---------------- CONFIG ---------------- */
const ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const VERIFY_URL = `${ENDPOINT}/verify`;
const CHAT_URL   = `${ENDPOINT}/chat`;

/* -------------- PROGRESS / LICENSE (cloud + local) -------------- */
(() => {
  const LS = { key:"fe.license", cache:"fe.progress.cache" };
  const STAGES = ["profile","offer","copy","launch","done"];
  const stageIndex = s => Math.max(1, Math.min(5, STAGES.indexOf((s||"").toLowerCase()) + 1));

  const $ = s => document.querySelector(s);
  const el = {
    fill: $('[data-roadmap-fill]'),
    text: $('[data-roadmap-text]'),
    badge:$('[data-mode-badge]'),
    demoCta: $('#demoCta'),
    buyBtns: [...document.querySelectorAll('[data-cta-buy],[data-menu-buy]')],
    keyBtns: [...document.querySelectorAll('[data-cta-have-key],[data-menu-have-key]')],
  };

  const getLicense = () => localStorage.getItem(LS.key) || "";
  const setLicense = k => { k ? localStorage.setItem(LS.key,k) : localStorage.removeItem(LS.key); };

  const api = {
    async getProgress(license){
      const u=new URL(ENDPOINT+"/progress"); u.searchParams.set("license_key",license);
      const r=await fetch(u); if(!r.ok) throw new Error("GET "+r.status); return r.json();
    },
    async putProgress(license,data){
      const r=await fetch(ENDPOINT+"/progress",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:license,data})});
      if(!r.ok) throw new Error("POST "+r.status); return r.json();
    }
  };

  const getLocal=()=>{ try{ return JSON.parse(localStorage.getItem(LS.cache)||"null"); }catch{ return null; } };
  const setLocal=(obj)=>{ try{ localStorage.setItem(LS.cache, JSON.stringify(obj||null)); }catch{} };

  let saveTimer=null, saving=Promise.resolve();
  function queueSave(license,data){
    clearTimeout(saveTimer);
    const payload=structuredClone(data);
    saveTimer=setTimeout(()=>{ saving=saving.then(()=>api.putProgress(license,payload).catch(()=>{})); },350);
  }

  function setModeUI(premium){
    if(el.badge) el.badge.textContent = premium? "Premium":"Demo";
    document.body.classList.toggle('premium', !!premium);
    if(el.demoCta) el.demoCta.style.display = premium? "none":"";
  }
  function setRoadmap(stage){
    const idx=stageIndex(stage), pct=(idx/5)*100;
    if(el.fill) el.fill.style.width = pct+"%";
    if(el.text) el.text.textContent = `${idx}/5`;
  }

  const Progress = {
    data:{ stage:"profile", memory:{}, history:[], modules:[] },
    isPremium:false, license:"",

    async hydrate(){
      const k=getLicense(); this.license=k; this.isPremium=!!k;
      if(k){
        try{
          const res=await api.getProgress(k);
          if(res?.ok && res.data){ this.data=res.data; setLocal(res.data); }
          else{
            const local=getLocal();
            if(local){ this.data=local; await api.putProgress(k,local).catch(()=>{}); }
            else{ await api.putProgress(k,this.data).catch(()=>{}); }
          }
        }catch{
          const local=getLocal(); if(local) this.data=local;
        }
      }else{
        const local=getLocal(); if(local) this.data=local;
      }
      setModeUI(this.isPremium); setRoadmap(this.data.stage);
      document.dispatchEvent(new CustomEvent("fe:hydrated",{detail:{isPremium:this.isPremium,data:this.data}}));
    },
    update(mutator){
      if(typeof mutator==="function") mutator(this.data);
      setLocal(this.data); setRoadmap(this.data.stage);
      if(this.license) queueSave(this.license,this.data);
    },
    async unlock(k){ setLicense(k); await this.hydrate(); },
    async signOut(){
      setLicense(""); setLocal(null); this.license=""; this.isPremium=false;
      this.data={stage:"profile", memory:{}, history:[], modules:[]};
      setModeUI(false); setRoadmap(this.data.stage);
      document.dispatchEvent(new CustomEvent("fe:signedout"));
    }
  };
  window.FEProgress = Progress;
  document.addEventListener("DOMContentLoaded", ()=>Progress.hydrate());

  // Demo CTA + Key handlers
  el.buyBtns.forEach(n=>n.addEventListener('click',()=>window.open("https://intellartsystems.gumroad.com/l/the-freedom-engine","_blank")));
  el.keyBtns.forEach(n=>n.addEventListener('click',()=>{
    const k = prompt("Enter your license key:"); if(!k) return;
    fetch(VERIFY_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:k.trim()})})
      .then(r=>r.json()).then(j=>{
        if(j?.ok || j?.success){ Progress.unlock(k.trim()).then(()=>post("Premium unlocked. I‚Äôll remember your progress across devices.","bot",{opener:true})); }
        else alert(j?.message||"Key not valid.");
      }).catch(()=>alert("Verify failed."));
  }));
})();
</script>

<script>
/* ---------------- CHAT & UI WIRING (unchanged look) ---------------- */
const chat = document.getElementById('chatSurface');
const composer = document.getElementById('composer');
const sendBtn = document.getElementById('sendBtn');
const kebab = document.getElementById('btnMore');
const menu  = document.getElementById('menu');

function scrollBottom(){ chat.scrollTop = chat.scrollHeight + 9999; }

function post(text, who="bot", opts={}){
  if(opts.opener){ [...chat.querySelectorAll('.msg[data-opener]')].forEach(n=>n.remove()); }
  const m = document.createElement('div');
  m.className = `msg ${who}`; if(opts.opener) m.setAttribute('data-opener','1');
  m.innerHTML = `<div class="head"></div><div class="content">${text}</div>`;
  chat.appendChild(m); scrollBottom();
}

function greet(premium){
  const t = premium
    ? `Premium engaged. I‚Äôm your brutal mentor with nice lighting. We‚Äôll ship one tiny paid offer in ~72 hours. Pick a lane or say ‚Äúhelp me choose‚Äù: ‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other.`
    : `Welcome to the Freedom Engine. I‚Äôm your personal trainer for tiny paid offers. I‚Äôll handle the thinking; you‚Äôll do the reps. If you‚Äôre blank, say ‚Äúhelp me choose‚Äù and I‚Äôll pitch options.`;
  post(t,"bot",{opener:true});
}

// Kebab menu opens above button
function placeMenu(){
  const r = kebab.getBoundingClientRect();
  menu.style.left = (r.left) + "px";
  menu.style.top  = (r.top - menu.offsetHeight - 8) + "px";
}
kebab.addEventListener('click', ()=>{
  const open = !menu.classList.contains('open');
  menu.classList.toggle('open', open);
  kebab.setAttribute('aria-expanded', open?'true':'false');
  if(open){ menu.style.display='block'; placeMenu(); } else { menu.style.display=''; }
});
window.addEventListener('resize', ()=>{ if(menu.classList.contains('open')) placeMenu(); });
document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==kebab){ menu.classList.remove('open'); menu.style.display=''; }});

// Menu actions
document.getElementById('miSave').addEventListener('click', ()=>{
  const data = JSON.stringify(window.FEProgress?.data||{}, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([data],{type:"application/json"}));
  a.download = 'freedom-engine-snapshot.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
});
document.getElementById('miLoad').addEventListener('click', ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return;
    try{ const d=JSON.parse(await f.text()); window.FEProgress.update(s=>Object.assign(s,d||{})); post("Snapshot loaded.","bot"); }
    catch{ alert("Bad snapshot."); }
  }; inp.click();
});
document.getElementById('miReset').addEventListener('click', ()=>{
  if(confirm("Reset local progress?")){
    window.FEProgress.update(d=>{ d.stage="profile"; d.history=[]; d.memory={}; });
    post("Progress cleared. Fresh start. Say ‚Äúhelp me choose‚Äù if you want lanes.","bot",{opener:true});
  }
});
document.getElementById('miSign').addEventListener('click', ()=>window.FEProgress.signOut().then(()=>greet(false)));
document.getElementById('miWake').addEventListener('click', ()=>post("Trainer awake. Choose a lane: design, writing, coaching, dev, or say ‚Äúhelp me choose‚Äù.","bot"));

/* Chat send */
composer.addEventListener('keydown', e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
sendBtn.addEventListener('click', ()=>{ const t=composer.value.trim(); if(!t) return; composer.value=""; talk(t); });

function sanitize(s){ return (s||"").replace(/\bundefined\b/gi,'').replace(/\s{2,}/g,' ').trim(); }

async function talk(userText){
  post(userText,"user");
  try{
    const payload = {
      messages:[
        {role:"system",content:"You are The Freedom Engine ‚Äî a sharp, darkly funny mentor. Keep answers short, practical, momentum-first. Avoid vulgarity; sarcastic is fine. Guide the user through: profile ‚Üí offer ‚Üí copy ‚Üí launch ‚Üí done."},
        ...(window.FEProgress?.data?.memory?.persona? [{role:"system",content:window.FEProgress.data.memory.persona}] : []),
        {role:"user",content:userText}
      ]
    };
    const r=await fetch(CHAT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const j=await r.json().catch(()=>({output:"No response."}));
    const out=sanitize(j.output||j.text||"No response.");
    post(out,"bot");

    // light stage bump
    const lower=(userText+" "+out).toLowerCase();
    window.FEProgress.update(d=>{
      if(d.stage==="profile" && /design|writing|coach|coaching|dev|code|other/.test(lower)) d.stage="offer";
      else if(d.stage==="offer" && /price|proof|deliver|scope|format/.test(lower)) d.stage="copy";
      else if(d.stage==="copy" && /email|page|cta|ad|sales/.test(lower)) d.stage="launch";
      else if(d.stage==="launch" && /live|published|scheduled|launched/.test(lower)) d.stage="done";
      d.history=(d.history||[]).concat({who:"user",text:userText},{who:"bot",text:out}).slice(-200);
    });
  }catch{ post("Cloud hiccup. Hit me again.","bot"); }
}

/* greet once after hydration */
document.addEventListener('fe:hydrated', e=>greet(!!e.detail?.isPremium));

/* keep chat visible on load/resize */
window.addEventListener('load', scrollBottom);
window.addEventListener('resize', scrollBottom);
</script>
</body>
</html>
