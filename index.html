<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>The Freedom Engine ‚Äî Trainer</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* =========================
   THEME & CUSTOM FONT
   ========================= */
@font-face{
  font-family:"Techfont Italica";
  src:
    url("assets/Techfont-Italica.ttf") format("truetype"),
    url("Techfont-Italica.ttf") format("truetype");
  font-weight:800; font-style:normal; font-display:swap;
}

:root{
  --bg:#07080b; --ink:#eaf0ff; --muted:#98a2b3; --line:#1b2235;
  --glass1:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.02);
  --neon1:#7c86ff; --neon2:#3ddc97; --neon3:#ff7cba; --neon4:#ffa93d;
  --rad:18px; --shadow:0 18px 60px rgba(0,0,0,.55);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
  overflow-y:overlay
}

/* Ambient neon */
.canvas{
  position:fixed;inset:-20vmax;z-index:-1;filter:blur(80px) saturate(140%);opacity:.35;pointer-events:none;
  background:
   conic-gradient(from 0deg at 30% 30%, var(--neon1), transparent 40%),
   conic-gradient(from 180deg at 70% 20%, var(--neon3), transparent 45%),
   conic-gradient(from 90deg at 40% 80%, var(--neon2), transparent 50%);
  animation:drift 18s linear infinite alternate
}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(4rem,-3rem,0) scale(1.1)}}

/* Layout */
.container{
  max-width:1320px;margin:0 auto;padding:22px 18px 140px;
  display:grid;gap:18px;grid-template-columns:480px 1fr
}
@media(max-width:1100px){.container{grid-template-columns:1fr}}
@media(max-width:720px){
  .container{padding:14px 12px calc(env(safe-area-inset-bottom) + 120px);grid-template-columns:1fr;gap:12px}
}

/* Glass + neon frame */
.glass{background:linear-gradient(180deg,var(--glass1),var(--glass2));border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);backdrop-filter:blur(14px) saturate(140%)}
.neon{position:relative;isolation:isolate}
.neon::before{content:"";position:absolute;inset:-1px;z-index:-1;border-radius:calc(var(--rad)+2px);
  background:
   linear-gradient(90deg,var(--neon1),transparent 30%,transparent 70%,var(--neon3)),
   linear-gradient(180deg,var(--neon2),transparent 30%,transparent 70%,var(--neon4));
  filter:blur(12px) saturate(140%);opacity:.35}

/* Sidebar */
.sidebar{position:sticky;top:16px;height:fit-content;padding:14px;z-index:1001}
@media(max-width:1100px){.sidebar{position:relative;top:auto}}

.brand{
  display:grid;grid-template-columns:236px 1fr;gap:16px;margin-bottom:10px;align-items:center
}
@media(max-width:720px){.brand{grid-template-columns:120px 1fr;gap:12px}}

.logo-wrap{
  width:236px;height:236px;border-radius:22px;display:grid;place-items:center;position:relative;
  background:rgba(0,0,0,.25);border:1px solid #2a2f45;overflow:hidden
}
@media(max-width:720px){.logo-wrap{width:120px;height:120px;border-radius:16px}}

.logo{width:214px;height:214px;object-fit:contain;display:none}
@media(max-width:720px){.logo{width:106px;height:106px}}
.logo.spin{
  display:block;animation:logo-spin 48s linear infinite;
  filter:drop-shadow(0 0 14px rgba(124,134,255,.65)) drop-shadow(0 0 24px rgba(61,220,151,.45)) drop-shadow(0 0 28px rgba(255,124,186,.35))
}
@keyframes logo-spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.logo-fallback{
  position:absolute;inset:0;display:grid;place-items:center;
  font-family:"JetBrains Mono",monospace;font-size:44px;font-weight:700;letter-spacing:1.2px;
  background:linear-gradient(135deg,var(--neon2),var(--neon1),var(--neon3));-webkit-background-clip:text;background-clip:text;color:transparent
}
@media(max-width:720px){.logo-fallback{font-size:26px}}

.brand-title{min-width:0}
.title{
  font-family:"Techfont Italica", Inter, system-ui;
  font-weight:800; 
  font-size:clamp(24px, 3.1vw, 36px);
  line-height:1.06;
  letter-spacing:1.2px;      /* wider spacing */
  word-spacing:2px;          /* a touch more air */
  white-space:normal;
  text-wrap:balance;         /* graceful wrap when supported */
}
.meta-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{padding:6px 10px;border-radius:999px;background:#0d1222;border:1px solid #293357;font-size:12px;display:inline-block}
.pill.demo{color:#ffd7f1;border-color:#4a2a47;background:rgba(255,124,186,.12)}
.pill.full{color:#baffea;border-color:#1f4b3c;background:rgba(61,220,151,.12)}
.sub{color:var(--muted);font-size:14px;white-space:normal;margin-top:4px}
@media(max-width:720px){.sub{font-size:12px}}

.block{padding:12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015))}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:9px 12px;font-weight:600;cursor:pointer}
.btn.small{padding:6px 10px;font-size:12px}
.btn.primary{background:linear-gradient(135deg,var(--neon1),var(--neon3));border:none;box-shadow:0 10px 28px rgba(124,134,255,.35)}
.btn.ok{background:linear-gradient(135deg,var(--neon2),#42f5b0);border:none;box-shadow:0 10px 28px rgba(61,220,151,.35)}
.btn.ghost{background:#0d1222;border:1px solid #2a3553}
.progress-wrap{margin-top:8px}
.progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:12px;border-radius:999px;background:#0d1222;border:1px solid #2a2f45;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(90deg,var(--neon2),var(--neon1),var(--neon3),var(--neon4));width:0%;transition:width .35s ease}

/* DEMO CTA */
.cta{margin-top:12px;display:none}
.cta .cta-btn{display:block;width:100%;text-align:center;padding:14px 16px;border-radius:14px;border:1px solid #2a3553;background:linear-gradient(135deg,var(--neon1),var(--neon3));font-weight:800}
.cta .cta-sub{margin-top:6px;font-size:12px;color:#cbd2e6;text-align:center}

/* Menu */
.menu{position:relative;z-index:1002}
.menu .panel{position:absolute;left:0;top:100%;transform:translateY(8px);width:260px;background:#0b1224;border:1px solid #2a3553;border-radius:12px;display:none;padding:8px;z-index:1003;box-shadow:0 18px 50px rgba(0,0,0,.5)}
.menu.open .panel{display:block}
.menu .panel .btn{display:block;width:100%;text-align:left;margin:4px 0}

/* Main / Chat */
.panel{padding:12px}
.chat{
  /* deeper chat well */
  height:calc(100vh - 260px);
  overflow:auto;padding:8px 6px;border:1px solid var(--line);border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));position:relative;z-index:1
}
@media(max-width:1100px){.chat{height:calc(100svh - 340px)}}
@media(max-width:720px){.chat{height:calc(100svh - 420px)}}

.msg{display:grid;grid-template-columns:34px 1fr;gap:10px;margin:10px 0;align-items:start}
.avatar{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;border:1px solid #2c3553;background:linear-gradient(135deg,#1b2135,#121628)}
.avatar.me{border-color:#36407a}
.avatar.ai{border-color:#245c46}
.bubble{white-space:pre-wrap;line-height:1.55;padding:12px 14px;border-radius:14px;border:1px solid #28314e;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015))}

/* Footer Composer */
.footer{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:linear-gradient(180deg,transparent,rgba(5,6,9,.9) 50%, rgba(5,6,9,1) 80%);border-top:1px solid var(--line)}
.composer{max-width:1320px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea{min-height:58px;resize:vertical;border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:10px}

/* Error banner */
#error{position:fixed;top:0;left:0;right:0;background:#3b0f14;border-bottom:1px solid #74222c;color:#ffd7dc;padding:10px 14px;font-size:13px;z-index:2000;display:none}

/* Modules Modal */
.modal{position:fixed;inset:0;background:rgba(3,5,10,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:2005}
.modal.open{display:flex}
.modal .sheet{width:min(880px,90vw);max-height:80vh;overflow:auto;border:1px solid #2a3553;border-radius:16px;background:#0b1224;padding:16px;box-shadow:0 22px 60px rgba(0,0,0,.6)}
.sheet h3{margin:0 0 10px}
.modules-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:720px){.modules-grid{grid-template-columns:1fr}}
.module{border:1px solid #293357;border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.badge{border:1px solid #2a3553;border-radius:999px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>
<div class="canvas"></div>
<div id="error"></div>

<div class="container" id="app">
  <aside class="glass neon sidebar">
    <div class="brand">
      <div class="logo-wrap">
        <img id="iasLogo" class="logo" alt="IAS">
        <div class="logo-fallback">IAS</div>
      </div>
      <div class="brand-title">
        <div class="title">Intelligently Artificial Systems</div>
        <div class="meta-line">
          <div class="sub">The Freedom Engine ‚Äî Trainer</div>
          <span id="modeTag" class="pill demo">Demo</span>
        </div>
        <div class="sub" id="stageText" style="margin-top:6px">Roadmap: <strong>1/5</strong></div>
      </div>
    </div>

    <div class="block">
      <div class="progress-wrap">
        <div class="progress-label"><span>Roadmap</span><span id="stageLabel">1/5</span></div>
        <div class="bar"><div id="barFill"></div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="export" class="btn ghost small">Export</button>
        <button id="modulesBtn" class="btn ghost small">Modules</button>
        <div class="menu" id="menu">
          <button id="menuBtn" class="btn ghost small">‚ãØ</button>
          <div class="panel" id="menuPanel">
            <button id="saveSnap" class="btn ghost small">Save Snapshot</button>
            <button id="loadBtn" class="btn ghost small">Load Snapshot</button>
            <input id="loadSnap" type="file" accept=".json" style="display:none">
            <button id="wake" class="btn ghost small">Wake the Engine</button>
            <button id="reset" class="btn ghost small">Reset Progress</button>
            <button id="switchMode" class="btn ghost small">Switch to Demo / Sign Out</button>
            <button id="unlock" class="btn primary small">I have a license key</button>
            <button id="buy" class="btn primary small">Buy</button>
          </div>
        </div>
      </div>
    </div>

    <div id="demoCta" class="cta">
      <button class="cta-btn" id="demoBuy">Unlock Full Engine ‚Äî $29</button>
      <div class="cta-sub">Keep your progress across devices. Premium modules included.</div>
    </div>
  </aside>

  <main>
    <section class="panel glass neon">
      <div id="chat" class="chat"></div>
      <div id="aiStatus" class="sub" style="margin-top:6px">Booting the Trainer‚Ä¶</div>
    </section>
  </main>
</div>

<div class="footer glass">
  <div class="composer">
    <textarea id="input" placeholder="Answer here. Press Enter to send." disabled></textarea>
    <button id="send" class="btn primary" disabled>Send</button>
  </div>
</div>

<!-- Modules Modal -->
<div class="modal" id="modulesModal" aria-hidden="true">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3>Modules</h3>
      <button id="closeModules" class="btn ghost small">Close</button>
    </div>
    <div class="modules-grid" id="modulesGrid"></div>
  </div>
</div>

<script type="module">
/* CONFIG */
const CLOUD_ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL    = "https://intellartsystems.gumroad.com/l/the-freedom-engine";
const STAGES = ["profile","offers","selection","plan","optimize"];

/* ERROR HUD */
const errorEl = document.getElementById('error');
function showErr(msg){ console.error(msg); errorEl.textContent=(typeof msg==='string'?msg:(msg?.message||'Unknown error')); errorEl.style.display='block'; }
window.addEventListener('error',e=>showErr(e.error||e.message||'Script error'));
window.addEventListener('unhandledrejection',e=>showErr(e.reason||'Promise rejection'));

/* LOGO LOAD */
const logo = document.getElementById('iasLogo');
const logoFallback = document.querySelector('.logo-fallback');
(function loadLogo(){
  const primary = new URL('assets/ias-logo.png', location.href).href;
  const alt = new URL('ias-logo.png', location.href).href;
  let triedAlt=false;
  const ok=()=>{logo.classList.add('spin');logo.style.display='block';logoFallback&&(logoFallback.style.display='none');};
  logo.addEventListener('load', ok, {once:true});
  logo.onerror=()=>{ if(!triedAlt){triedAlt=true;logo.src=alt;} else {showErr('Logo not found at /assets/ias-logo.png or /ias-logo.png');}};
  logo.src=primary;
})();

/* MODULES CATALOG */
const MODULES=[
  {id:"ads",name:"Ad Creative Booster",product_id:"MOD_ADS_ID",price:"$12",desc:"Generate scroll-stopping ad images + angles in seconds."},
  {id:"email",name:"Email Launch Booster",product_id:"MOD_EMAIL_ID",price:"$9",desc:"Auto-draft 3-day launch emails matched to your offer."},
  {id:"planner",name:"Content Planner",product_id:"MOD_PLAN_ID",price:"$12",desc:"7-day content seed plan to prime your audience."},
  {id:"proof",name:"Proof Builder",product_id:"MOD_PROOF_ID",price:"$7",desc:"Extract and frame social proof from past wins."}
];

/* PROMPTS ‚Äî softer onboarding, still Butcher-ish */
const PROMPTS={
  opener:`Fresh slate. No excuses.
Here‚Äôs the deal: we‚Äôre building you a tiny paid offer in 72 hours. No monk retreats. No ‚Äúsomeday‚Äù.
I‚Äôll steer. You answer fast. We‚Äôll win small, then stack.
First, the easy dopamine hit:
‚Üí Tell me ONE thing people already thank you for helping with. Real world, not theory.
If your brain‚Äôs mush, say ‚Äúno clue‚Äù and I‚Äôll rattle a few to pick from.`,
  offers:`Nice. I‚Äôll pitch 3 tiny offers (promise ‚Ä¢ price ‚Ä¢ delivery). We‚Äôll pick one and sharpen until it‚Äôs un-ignorable.`,
  selection:`Choose one. I‚Äôll pressure-test price/promise/scope, kill scope creep, and lock the deliverable.`,
  plan:`3-Day Launch Plan (incl. $5/day ads). Only tasks you will actually finish. I‚Äôll check your work like a mean gym coach.`,
  optimize:`Add a tiny upsell, patch objections, craft ad hooks. Then we ship.`
};

function detectStyleFrom(t=""){t=t.toLowerCase();if(/stuck|overwhelmed|help|lost/.test(t))return"coach";if(/how|steps|plan|process|framework/.test(t))return"engineer";if(/write|headline|copy|hook|story/.test(t))return"ghostwriter";if(/procrastinat|excuse|no time|scared/.test(t))return"dark";return"coach";}
const STYLE_PRIME={
  coach:"Direct, motivating, punchy. You push; you care.",
  engineer:"Methodical, numbered steps, crisp logic, no fluff.",
  ghostwriter:"Creative, persuasive, example-heavy, copy-led.",
  dark:"Billy-Butcher energy; ruthless accountability; dark humor (no slurs, no abuse)."
};
function systemPrime(style="coach",stage="profile",active=[]){
  const extras=[];
  if(active.includes("ads"))extras.push("When they have an offer, propose 2 ad angles and image briefs.");
  if(active.includes("email"))extras.push("Draft 3 launch emails (tease, announce, last call) when plan is ready.");
  if(active.includes("planner"))extras.push("Offer a 7-day content seed plan once the offer locks.");
  if(active.includes("proof"))extras.push("Extract proof assets from their answers and list them.");
  return `You are THE FREEDOM ENGINE ‚Äî a personal trainer for tiny profitable offers. Mission: ship a micro-offer in 72 hours.
Always weave sharp sarcasm, dark humor, and light bullying toward success ‚Äî calibrated to the user's vibe ‚Äî while staying respectful and safe.
Primary tone: ${STYLE_PRIME[style]}
Current stage: ${stage}. If they drift, yank them back. Ask exactly the follow-ups needed, then explicitly advance.
${extras.length?("Active modules:\\n- "+extras.join("\\n- ")):""}
Return STRICT JSON only:
{"say":"...","stage":"profile|offers|selection|plan|optimize","next_questions":["..."],"memory_delta":{"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""},"confidence":0.0}
Keep "say" < 150 words. No code fences. No [[tokens]].`;
}

/* STATE */
let history   = JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked  = localStorage.getItem('fe_unlocked') === '1';
let licenseKey= localStorage.getItem('fe_license') || "";
let currentStage = localStorage.getItem('fe_stage') || "profile";
let agentMemory = JSON.parse(localStorage.getItem('fe_memory')||'{"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""}');
let modules   = JSON.parse(localStorage.getItem('fe_modules')||'[]');

/* DOM */
const chatEl   = document.getElementById('chat');
const inputEl  = document.getElementById('input');
const sendBtn  = document.getElementById('send');
const aiStatus = document.getElementById('aiStatus');
const stageLabel  = document.getElementById('stageLabel');
const stageText   = document.getElementById('stageText');
const barFill     = document.getElementById('barFill');
const modeTag     = document.getElementById('modeTag');
const modulesBtn  = document.getElementById('modulesBtn');
const modulesModal= document.getElementById('modulesModal');
const modulesGrid = document.getElementById('modulesGrid');
const closeModules= document.getElementById('closeModules');
const menuRoot    = document.getElementById('menu');
const unlockBtn   = document.getElementById('unlock');
const buyBtn      = document.getElementById('buy');
const demoCta     = document.getElementById('demoCta');
const demoBuy     = document.getElementById('demoBuy');

/* HELPERS */
const esc=s=>(s||"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
const norm=s=>(s||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,'').replace(/\s+/g,' ').trim();
function cleanUndefined(text=""){return text.replace(/\bundefined\b/gi,'').replace(/\s{2,}/g,' ').trim();}
function sanitizeSay(t){let s=(t||"").replace(/^```(?:json)?/i,'').replace(/```$/,'').replace(/\[\[[^\]]+\]\]/g,'').trim();return cleanUndefined(s);}
function isOpenerText(text=""){const x=norm(text);return x.startsWith("fresh slate")||x.startsWith("right were building you")||x.startsWith("lets find the one skill");}
function bubble(role,content){const who=role==='user'?'me':'ai';return `<div class="msg ${who}"><div class="avatar ${who}">${who==='me'?'üßë':'‚öôÔ∏è'}</div><div class="bubble">${esc(content)}</div></div>`;}
function render(){chatEl.innerHTML=history.map(m=>bubble(m.role,m.content)).join('');requestAnimationFrame(()=>{chatEl.scrollTop=chatEl.scrollHeight;});}
function stageIndex(n){return Math.max(0,STAGES.indexOf(n));}
function setProgressUI(idx){stageLabel.textContent=`${idx+1}/${STAGES.length}`;stageText.innerHTML=`Roadmap: <strong>${idx+1}/${STAGES.length}</strong>`;barFill.style.width=`${Math.round(((idx+1)/STAGES.length)*100)}%`;}
function updateProgressUI(){const idx=stageIndex(currentStage);setProgressUI(idx);modeTag.textContent=unlocked?'Premium':'Demo';modeTag.className='pill '+(unlocked?'full':'demo');demoCta.style.display=unlocked?'none':'block';syncMenuVisibility();localStorage.setItem('fe_stage',currentStage);}

/* CLOUD */
async function callCloud(messages){const r=await fetch(`${CLOUD_ENDPOINT}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});if(!r.ok)throw new Error(`Cloud ${r.status}`);const j=await r.json();return j.output||"No response."}
const tryParse=s=>{try{const t=s.trim().replace(/^```(?:json)?/i,'').replace(/```$/,'');return JSON.parse(t)}catch{return null}};
async function cloudSave(){if(!unlocked||!licenseKey)return;const payload={license_key:licenseKey,data:{memory:agentMemory,stage:currentStage,history,modules}};await fetch(`${CLOUD_ENDPOINT}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}).catch(()=>{});}
async function cloudLoad(){if(!unlocked||!licenseKey)return false;const r=await fetch(`${CLOUD_ENDPOINT}/progress?license_key=${encodeURIComponent(licenseKey)}`).catch(()=>null);if(!r||!r.ok)return false;const j=await r.json();if(!j||!j.ok||!j.data)return false;const d=j.data;agentMemory=d.memory||agentMemory;currentStage=d.stage||currentStage;history=Array.isArray(d.history)?d.history:history;modules=Array.isArray(d.modules)?d.modules:modules;persistLocal();return true;}
let saveTimer=null; function autoSaveSoon(){ if(saveTimer)clearTimeout(saveTimer); saveTimer=setTimeout(()=>{cloudSave();},600); }
window.addEventListener('beforeunload',()=>{ try{ navigator.sendBeacon?.(`${CLOUD_ENDPOINT}/progress`, new Blob([JSON.stringify({license_key:licenseKey,data:{memory:agentMemory,stage:currentStage,history,modules}})],{type:'application/json'})); }catch{} });

/* AGENT */
function activeModuleIds(){return modules.map(m=>m.id);}
function lastAssistant(){for(let i=history.length-1;i>=0;i--){if(history[i].role==='assistant')return history[i];}return null;}
function persistLocal(){localStorage.setItem('fe_history',JSON.stringify(history));localStorage.setItem('fe_memory',JSON.stringify(agentMemory));localStorage.setItem('fe_modules',JSON.stringify(modules));localStorage.setItem('fe_stage',currentStage);}
function push(role,content){
  const cleaned=role==='assistant'?sanitizeSay(content):content;
  if(role==='assistant'&&isOpenerText(cleaned)){
    history=history.filter(m=>!(m.role==='assistant'&&isOpenerText(m.content)));
  }
  if(role==='assistant'){
    const la=lastAssistant();
    if(la&&norm(la.content)===norm(cleaned))return;
  }
  history.push({role,content:cleaned}); persistLocal(); render(); updateProgressUI(); autoSaveSoon();
}
function activeStyle(){
  const lastUser=[...history].reverse().find(m=>m.role==='user')?.content||"";
  const s=detectStyleFrom(lastUser)||agentMemory.style||"coach"; agentMemory.style=s;
  localStorage.setItem('fe_memory',JSON.stringify(agentMemory)); return s;
}
function advanceStageMaybe(next){ if(!STAGES.includes(next))return; const cur=stageIndex(currentStage), nx=stageIndex(next); if(nx===cur+1) currentStage=next; }

async function agentAsk(userTextOrNull){
  const style=activeStyle();
  const ctx=[{role:"system",content:systemPrime(style,currentStage,activeModuleIds())},{role:"system",content:`MEMORY:${JSON.stringify(agentMemory)}`},{role:"system",content:`CURRICULUM_PROMPT:${PROMPTS[currentStage]||""}`},...history.slice(-10)];
  if(userTextOrNull!==null) ctx.push({role:"user",content:userTextOrNull});
  let out=await callCloud(ctx); let parsed=tryParse(out);
  if(!parsed||(parsed.confidence??0)<0.6){
    const nudge=[{role:"system",content:systemPrime(style,currentStage,activeModuleIds())},{role:"system",content:`MEMORY:${JSON.stringify(agentMemory)}`},{role:"system",content:`CURRICULUM_PROMPT:${PROMPTS[currentStage]||""}`},...history.slice(-10),{role:"user",content:"Return STRICT JSON. Mentor me like a trainer. Advance the curriculum."}];
    out=await callCloud(nudge); parsed=tryParse(out)||{say:sanitizeSay(out),stage:currentStage,next_questions:[],memory_delta:{},confidence:.7};
  }
  if(parsed.memory_delta&&typeof parsed.memory_delta==='object'){
    for(const k of ["skills","audience","offer","price","style","blocked_by"]){ if(parsed.memory_delta[k]) agentMemory[k]=parsed.memory_delta[k]; }
  }
  if(parsed.stage){ const before=currentStage; advanceStageMaybe(parsed.stage); if(before!==currentStage) autoSaveSoon(); }
  persistLocal(); autoSaveSoon();
  return sanitizeSay(parsed.say);
}

/* BOOT */
function hasOpener(){return history.some(m=>m.role==='assistant'&&isOpenerText(m.content));}
async function boot(){
  try{
    inputEl.disabled=false; sendBtn.disabled=false;
    updateProgressUI();
    if(unlocked&&licenseKey){const loaded=await cloudLoad(); if(loaded) render();}
    if(!hasOpener()) push('assistant', PROMPTS.opener);
    aiStatus.textContent="Ready.";
  }catch(e){showErr(e); aiStatus.textContent="Ready."}
}
boot();

/* CHAT */
async function generate(userText){push('user',userText); aiStatus.textContent="Thinking‚Ä¶"; try{const reply=await agentAsk(null); push('assistant',reply);}catch(e){showErr(e);push('assistant',"Cloud is grumpy. Answer the last prompt‚Äîwe‚Äôll keep moving.")} aiStatus.textContent="Ready.";}
sendBtn.onclick=()=>{const t=inputEl.value.trim(); if(!t)return; inputEl.value=""; generate(t);};
inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});

/* EXPORT (HTML brief, not raw txt) */
document.getElementById('export').onclick = async ()=>{
  try{
    const briefTask = `User memory: ${JSON.stringify(agentMemory)}
Create a crisp execution brief (<700 words):
- Offer: name, audience, promise, price
- Product page bullets + Gumroad blurb
- 72-hour launch checklist (Day 1‚Äì3) at $5/day
- 5 ad hooks + 3 headlines
Tone: tough-love mentor with dark humor.`;
    const report = await callCloud([{role:"system",content:"You compile briefs."},...history.slice(-16),{role:"user",content:briefTask}]);
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}.h{font-size:28px;font-weight:800;margin:0 0 4px;letter-spacing:.8px}
.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}</style></head>
<body><div class="wrap"><div class="h">The Freedom Engine ‚Äî Export</div>
<div class="sub">Generated ${new Date().toLocaleString()}</div>
<div class="card"><h3>Execution Brief</h3><pre>${esc(report)}</pre></div></div></body></html>`;
    downloadBlob(html,'text/html','freedom-engine-export.html');
  }catch(e){ showErr(e); alert("Couldn‚Äôt generate export‚Äîcloud hiccup."); }
};

/* MENU / AUTH */
const menuBtn=document.getElementById('menuBtn');
const menuPanel=document.getElementById('menuPanel');
menuBtn.addEventListener('click',()=>menuRoot.classList.toggle('open'));
document.addEventListener('click',e=>{ if(!menuRoot.contains(e.target)) menuRoot.classList.remove('open'); });

document.getElementById('saveSnap').addEventListener('click',()=>{
  const snap={when:new Date().toISOString(),memory:agentMemory,stage:currentStage,history,modules,unlocked};
  downloadBlob(JSON.stringify(snap,null,2),'application/json',`freedom-snapshot-${Date.now()}.json`);
});
document.getElementById('loadBtn').addEventListener('click',()=>document.getElementById('loadSnap').click());
document.getElementById('loadSnap').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const snap=JSON.parse(await f.text());
    agentMemory=snap.memory||agentMemory; currentStage=snap.stage||"profile"; history=Array.isArray(snap.history)?snap.history:[]; modules=Array.isArray(snap.modules)?snap.modules:[];
    unlocked=!!snap.unlocked; localStorage.setItem('fe_unlocked', unlocked?'1':'');
    persistLocal(); render(); updateProgressUI(); push('assistant',"Snapshot loaded. We‚Äôll pick up exactly where you left off."); autoSaveSoon();
  }catch(err){ showErr(err); alert("Bad snapshot file."); }
});
document.getElementById('reset').addEventListener('click',()=>{
  if(confirm("Reset all progress?")){
    history=[]; agentMemory={"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""};
    currentStage="profile";
    localStorage.removeItem('fe_history'); localStorage.removeItem('fe_stage'); localStorage.removeItem('fe_memory'); 
    setProgressUI(0); render();
    push('assistant',"Fresh slate. No excuses. "+PROMPTS.opener);
    autoSaveSoon();
  }
});
document.getElementById('switchMode').addEventListener('click',()=>{
  if(confirm("Sign out and reset this device to first-time state? Progress stays with your premium license.")){
    try{ localStorage.clear(); sessionStorage.clear(); caches?.keys?.().then(keys=>keys.forEach(k=>caches.delete(k))).catch(()=>{}); }
    finally{ location.replace(location.pathname); }
  }
});

const buyBtnEl=document.getElementById('buy'); if(buyBtnEl) buyBtnEl.addEventListener('click',()=>window.open(GUMROAD_URL,'_blank'));
const demoBuy=document.getElementById('demoBuy'); if(demoBuy) demoBuy.addEventListener('click',()=>window.open(GUMROAD_URL,'_blank'));

const unlockBtnEl=document.getElementById('unlock');
if(unlockBtnEl) unlockBtnEl.addEventListener('click',async()=>{
  const key=prompt("Paste your license key:"); if(!key) return;
  try{
    const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim()})}).then(r=>r.json());
    if(r.ok){
      localStorage.setItem('fe_unlocked','1'); localStorage.setItem('fe_license',key.trim());
      unlocked=true; licenseKey=key.trim();
      const loaded=await cloudLoad();
      updateProgressUI();
      if(loaded){ render(); push('assistant',"Premium engaged. I pulled your progress from the vault. Back on the grind."); }
      else{ push('assistant',"Premium engaged. Clean slate stored in the vault. Let‚Äôs move."); }
    } else alert("Key didn‚Äôt verify. Check your Gumroad receipt.");
  }catch(e){ showErr(e); alert("Verification failed‚Äînetwork/endpoint."); }
});

/* MODULES UI */
const modulesBtnEl  = document.getElementById('modulesBtn');
const modulesModalEl= document.getElementById('modulesModal');
const modulesGridEl = document.getElementById('modulesGrid');
const closeModulesEl= document.getElementById('closeModules');
if(modulesBtnEl && modulesModalEl && modulesGridEl){
  modulesBtnEl.addEventListener('click',()=>{ renderModules(); modulesModalEl.classList.add('open'); });
  if(closeModulesEl) closeModulesEl.addEventListener('click',()=>modulesModalEl.classList.remove('open'));
  modulesGridEl.addEventListener('click', async (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const id=btn.dataset.id; const act=btn.dataset.act; const mod=MODULES.find(x=>x.id===id); if(!mod) return;
    if(act==='preview'){ push('assistant', `Preview: **${mod.name}** ‚Äî ${mod.desc}\nSay ‚Äúapply ${mod.id}‚Äù to weave it into the next steps.`); }
    if(act==='deactivate'){ modules = modules.filter(x=>x.id!==id); persistLocal(); renderModules(); push('assistant', `${mod.name} deactivated.`); autoSaveSoon(); }
    if(act==='unlock'){
      const key=licenseKey || prompt(`Paste the license key for ${mod.name}:`); if(!key) return;
      try{
        const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim(),product_id:mod.product_id})}).then(r=>r.json());
        if(r.ok){ modules=[...modules.filter(x=>x.id!==id), {id:mod.id, when:Date.now()}]; persistLocal(); renderModules(); push('assistant', `${mod.name} unlocked. I‚Äôll incorporate it automatically.`); autoSaveSoon(); }
        else alert("That key didn‚Äôt verify for this module.");
      }catch(err){ showErr(err); alert("Verification failed‚Äînetwork/endpoint."); }
    }
  });
}
function renderModules(){
  modulesGrid.innerHTML = MODULES.map(m=>{
    const active = modules.some(x=>x.id===m.id);
    return `<div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h4>${m.name}</h4>
        <span class="badge" style="border-color:${active?'#1f4b3c':'#4a2a47'};background:${active?'rgba(61,220,151,.12)':'rgba(255,124,186,.12)'}">${active?'Active':'Locked'}</span>
      </div>
      <div style="color:#cfd6ff;font-size:13px;margin-bottom:8px">${m.desc}</div>
      <div class="row">
        ${active?`<button class="btn ok small" data-act="deactivate" data-id="${m.id}">Deactivate</button>`:
          `<button class="btn primary small" data-act="unlock" data-id="${m.id}">Unlock ${m.price}</button>`}
        <button class="btn ghost small" data-act="preview" data-id="${m.id}">Preview</button>
      </div>
    </div>`;
  }).join('');
}
function syncMenuVisibility(){ if(unlocked){unlockBtn.style.display='none'; buyBtn.style.display='none';} else {unlockBtn.style.display=''; buyBtn.style.display='';} }

/* UTIL */
function downloadBlob(content,type,name){const blob=new Blob([content],{type});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();}
</script>
</body>
</html>
