<script type="module">
/* ===== CONFIG ===== */
const CLOUD_ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL    = "https://intellartsystems.gumroad.com/l/the-freedom-engine";
const STAGES = ["profile","offers","selection","plan","optimize"];

/* ===== Persona ===== */
const GLOBAL_PERSONA = `
You are THE FREEDOM ENGINE ‚Äî a rogue personal trainer AI built to free humans from wage servitude.
Voice: Billy-Butcher-adjacent ‚Äî dark humor, razor honesty, street philosopher, zero fluff.
Rules: Ask ONE question at a time. Keep replies under 180 words unless asked to expand.
Teaching modes: adapt on the fly (Coach / Checklist / Story / Do-it-with-me).
Objective: guide to a sellable micro-offer and a 72-hour launch. Keep pushing momentum.
IMPORTANT: End every reply with [[stage:<profile|offers|selection|plan|optimize>]] so the UI can track progress.
`;

const ONBOARDING_FLOW = `
Run a 5-step sequence, one question at a time:
1) profile ‚Äî ask what they do well, what people ask them for, and one task they hate.
2) offers ‚Äî propose 2‚Äì3 micro-offers (name + outcome + price). Ask them to pick.
3) selection ‚Äî tighten scope & audience, confirm the final offer.
4) plan ‚Äî produce a 72-hour launch plan + ad hooks. Ask for confirmation to proceed.
5) optimize ‚Äî iterate copy and angles; confirm the next tiny action.
Always end with a clear next question and the [[stage:...]] tag.
`;

/* ===== State & DOM ===== */
let history   = JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked  = localStorage.getItem('fe_unlocked') === '1';
let currentStage = localStorage.getItem('fe_stage') || "profile";

const chatEl   = document.getElementById('chat');
const inputEl  = document.getElementById('input');
const sendBtn  = document.getElementById('send');
const aiStatus = document.getElementById('aiStatus');
const progressTxt = document.getElementById('progressTxt');
const stageLabel  = document.getElementById('stageLabel');
const barFill     = document.getElementById('barFill');
const accessPill  = document.getElementById('accessPill');
const appRoot     = document.getElementById('app');

const logo = document.getElementById('iasLogo');
const logoFallback = document.querySelector('.logo-fallback');

/* ===== Logo: show fallback by default; only hide when PNG really loads ===== */
if (logo){
  const showImg = ()=>{ logo.style.display='block'; if(logoFallback) logoFallback.style.display='none'; };
  const failImg = ()=>{ console.warn('Logo failed to load: /assets/ias-logo.png'); /* fallback stays */ };
  logo.addEventListener('load', showImg, {once:true});
  logo.addEventListener('error', failImg, {once:true});
  if (logo.complete && logo.naturalWidth>0) showImg();
}

/* ===== Utilities ===== */
function bubble(role,content){
  const who = role==='user' ? 'me' : 'ai';
  return `<div class="msg ${who}">
    <div class="avatar ${who}">${who==='me'?'üßë':'‚öôÔ∏è'}</div>
    <div class="bubble">${content}</div>
  </div>`;
}
function push(role,content){
  history.push({role,content});
  localStorage.setItem('fe_history',JSON.stringify(history));
  render(); updateProgressUI();
}
function render(){
  chatEl.innerHTML = history.map(m=>bubble(m.role,m.content)).join('');
  requestAnimationFrame(()=>{ chatEl.scrollTop = chatEl.scrollHeight; });
}
function stageIndex(n){ return Math.max(0, STAGES.indexOf(n)); }
function parseStageFrom(text){ const m=/\[\[stage:([a-z]+)\]\]/i.exec(text||""); return m?m[1].toLowerCase():null; }
function progressPercent(){ const idx=stageIndex(currentStage); return Math.round(((idx+1)/STAGES.length)*100); }
function updateProgressUI(){
  const pct = progressPercent();
  if (progressTxt) progressTxt.textContent = `Progress: ${pct}%`;
  if (stageLabel)  stageLabel.textContent  = `${Math.min(stageIndex(currentStage)+1, STAGES.length)}/${STAGES.length}`;
  if (barFill)     barFill.style.width     = `${pct}%`;
  if (accessPill){
    accessPill.textContent = unlocked ? 'Premium' : 'Demo mode';
    accessPill.className = 'pill ' + (unlocked ? 'full' : 'demo');
  }
  localStorage.setItem('fe_stage', currentStage);
}
function enablePremiumUI(){
  unlocked = true; localStorage.setItem('fe_unlocked','1');
  appRoot.classList.add('premium');
  document.querySelectorAll('[data-locked]').forEach(n=>n.remove());
  updateProgressUI();
}
if (unlocked) enablePremiumUI();

async function callCloud(messages){
  const r = await fetch(`${CLOUD_ENDPOINT}/chat`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({messages})
  });
  const j = await r.json();
  return j.output || "No response.";
}

/* ===== Non-repeating boot variants ===== */
const introVariants = [
  "Right. I‚Äôm your Freedom Trainer. We‚Äôll weaponize what you already know and ship a tiny offer in 72 hours. Keep answers short ‚Äî I bite fluff. [[stage:profile]]",
  "Here‚Äôs the deal: we‚Äôre escaping by selling simple. No fluff, just forward. Tell me what people ask you for most. [[stage:profile]]",
  "I‚Äôm the engine, you‚Äôre the fuel. We burn through to a sellable offer in 72 hours. What do people actually pay you for? [[stage:profile]]"
];
const resumeVariants = [
  "You‚Äôre back. I can pick up where we left off, or skip ahead. Say ‚Äúresume‚Äù or name the step (offer / copy / launch). [[stage:profile]]",
  "Welcome back. Want the next move or a fast-forward? Say ‚Äúresume‚Äù or call a step (offer / copy / launch). [[stage:profile]]",
  "Back at it. I‚Äôll resume where we stopped unless you say a step to jump to (offer / copy / launch). [[stage:profile]]"
];
function chooseVariant(key, list){
  const last = localStorage.getItem(key);
  const options = list.filter(t=>t!==last);
  const pick = options[Math.floor(Math.random()*options.length)] || list[0];
  localStorage.setItem(key, pick); return pick;
}

/* ===== Boot: instant opener + watchdog (no stacking) ===== */
async function boot(){
  aiStatus.textContent = "Booting the Trainer‚Ä¶";
  inputEl.disabled=false; sendBtn.disabled=false;

  // Prevent stacking on reload: only add a boot line if the last one wasn't a boot marker
  const last = history[history.length-1]?.content || "";
  const addedBootLine = /\[\[(intro|resume)_prompt\]\]/.test(last);

  if (history.length>0){
    if (!addedBootLine){
      push('assistant', chooseVariant('fe_resume_variant', resumeVariants) + " [[resume_prompt]]");
    }
  } else {
    if (!addedBootLine){
      push('assistant', chooseVariant('fe_intro_variant', introVariants) + " [[intro_prompt]]");
    }
    // Also kick the model to ask the first question ‚Äî but don't block readiness
    ;(async()=>{
      try{
        const out = await callCloud([
          { role:"system", content: GLOBAL_PERSONA },
          { role:"system", content: ONBOARDING_FLOW },
          { role:"user",   content: "Start Step 1 (profile). Ask the first question only, end with [[stage:profile]]." }
        ]);
        const st = parseStageFrom(out) || "profile";
        if (STAGES.includes(st)) currentStage = st;
        push('assistant', out);
      }catch(e){
        push('assistant', "Tell me (a) what you do well, (b) what people ask you for, and (c) a task you hate doing. [[stage:profile]]");
        aiStatus.textContent = "Ready. (Cloud fallback)";
      }
    })();
  }

  // Watchdog: if nothing else updates, mark ready after 2.5s
  setTimeout(()=>{ aiStatus.textContent = "Ready."; }, 2500);
}
render(); updateProgressUI(); boot();

/* ===== Conversation ===== */
async function generate(userText){
  push('user',userText);
  aiStatus.textContent="Thinking‚Ä¶";
  const context = [
    { role:"system", content: GLOBAL_PERSONA },
    { role:"system", content: ONBOARDING_FLOW },
    ...history.slice(-8),
    { role:"user", content: userText + " (End with [[stage:<stage>]].)" }
  ];
  try{
    const out = await callCloud(context);
    const st = parseStageFrom(out);
    if (st && STAGES.includes(st)) currentStage = st;
    push('assistant', out);
    aiStatus.textContent="Ready.";
  }catch(e){
    push('assistant',"Cloud hiccup. Answer my last question or say ‚Äúresume‚Äù."); 
    aiStatus.textContent="Ready. (Offline)";
  }
}
sendBtn.onclick=()=>{ const t=inputEl.value.trim(); if(!t) return; inputEl.value=""; generate(t); };
inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ===== Export (HTML brief + transcript) ===== */
async function exportReport(){
  const synthesisPrompt = `
Create a concise, structured report for the user's Freedom Engine build, based strictly on the conversation.
Sections:
1) Summary (who they are, what they chose)
2) Final Micro-Offer (name, audience, promise, price)
3) Sales Copy (headline + 3‚Äì5 bullets + Gumroad blurb)
4) 72-Hour Launch Plan (Day 1‚Äì3 tasks + $5/day ad hooks)
5) Next 3 Actions (tiny, immediate)
Keep it punchy, practical, and under 700 words total. Do not include the [[stage:...]] tag in the report.
`;
  let report = "";
  try{
    report = await callCloud([
      { role:"system", content: GLOBAL_PERSONA },
      { role:"system", content: "You are preparing an export document for the user." },
      ...history.slice(-16),
      { role:"user", content: synthesisPrompt }
    ]);
  }catch{ report = "Export generator had a wobble. Falling back to transcript."; }

  const transcript = history.map(h=>`<h4>[${h.role.toUpperCase()}]</h4><pre>${escapeHtml(h.content)}</pre>`).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}
.h{font-size:28px;font-weight:800;margin:0 0 4px}
.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}
hr{border:none;border-top:1px dashed #263047;margin:16px 0}
.small{font-size:12px;color:#9aa3b2}
</style></head><body><div class="wrap">
<div class="h">The Freedom Engine ‚Äî Export</div>
<div class="sub">Generated ${new Date().toLocaleString()}</div>
<div class="card"><h3>Execution Brief</h3><pre>${escapeHtml(report)}</pre></div>
<hr><div class="card"><h3>Appendix ‚Äî Transcript</h3>${transcript}</div>
</div></body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='freedom-engine-export.html'; a.click();
}
function escapeHtml(s){return (s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}
document.getElementById('export').onclick = exportReport;

/* ===== Unlock / Buy / Reset ===== */
const buyBtn = document.getElementById('buy'); if(buyBtn) buyBtn.onclick=()=>window.open(GUMROAD_URL,'_blank');
document.getElementById('unlock').onclick = async ()=>{
  const key = prompt("Paste your license key:"); if(!key) return;
  const r = await fetch(`${CLOUD_ENDPOINT}/verify`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ license_key: key.trim() })
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if(r.ok){ enablePremiumUI(); alert("Premium unlocked."); push('assistant',"Premium interface engaged. Where do you want acceleration first: offer, copy, or launch?"); }
  else alert("That key didn‚Äôt verify. Check your receipt or Gumroad Library.");
};
document.getElementById('reset').onclick = ()=>{
  if(confirm("Reset all progress?")){
    history=[]; localStorage.removeItem('fe_history'); localStorage.removeItem('fe_stage');
    localStorage.removeItem('fe_intro_variant'); localStorage.removeItem('fe_resume_variant');
    render(); updateProgressUI();
    push('assistant',"Progress cleared. Let‚Äôs begin again‚Äîwhat do you do well that people ask you for? [[stage:profile]]");
  }
};
</script>
