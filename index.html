<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>

<!-- Headline font (kept from earlier), used across UI with lighter weights so it isn‚Äôt visually loud -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,600;1,600&display=swap" rel="stylesheet">

<style>
  :root{
    --glass: rgba(255,255,255,0.08);
    --glass-2: rgba(255,255,255,0.14);
    --ring: rgba(255,255,255,0.22);
    --ink: #e8ecff;
    --ink-dim:#bfc7f9;
    --neon-c:#82f3ff; --neon-m:#ff7bf1; --neon-y:#ffd86a; --neon-g:#77ffb0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:"Kanit",system-ui,sans-serif;
    background: radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,0.12), transparent 60%),
                radial-gradient(900px 600px at 80% 30%, rgba(255,255,255,0.10), transparent 60%),
                linear-gradient(140deg,#2b0f27 0%,#23173a 40%,#18324a 100%);
  }

  /* Layout */
  .wrap{display:grid; grid-template-columns:420px 1fr; gap:24px; padding:24px; height:100dvh;}
  @media(max-width:900px){ .wrap{grid-template-columns:1fr; height:auto; min-height:100dvh} }

  .card{
    background:var(--glass); border:1px solid var(--ring);
    border-radius:22px; box-shadow:0 10px 40px rgba(0,0,0,.35);
    padding:18px; position:relative; overflow:visible; /* FIX: let dropdown escape */
  }
  .card::before{
    content:""; position:absolute; inset:-40%;
    background:conic-gradient(from 0deg, var(--neon-c), var(--neon-m), var(--neon-y), var(--neon-g), var(--neon-c));
    opacity:.12; filter:blur(80px); z-index:0; pointer-events:none;
    animation:swirl 16s linear infinite;
  }
  @keyframes swirl{to{transform:rotate(360deg)}}

  /* Header panel */
  .brand{
    display:grid; grid-template-columns:132px 1fr; gap:16px; align-items:center;
    margin-bottom:16px; position:relative; z-index:1;
  }
  .logo-box{
    height:132px; border-radius:20px; background:var(--glass-2); border:1px solid var(--ring);
    overflow:hidden; display:grid; place-items:center;
  }
  .logo{ width:320px; height:320px; object-fit:contain; animation:spin 38s linear infinite;
         filter:drop-shadow(0 0 12px rgba(255,255,255,.25)); }
  @keyframes spin{to{transform:rotate(360deg)}}

  .titles h1{margin:0; line-height:1.03; font-weight:600; font-size:44px; letter-spacing:.5px; word-break:break-word}
  .titles .sub{opacity:.85; margin-top:4px; font-weight:400}
  .badge{display:inline-block; padding:5px 10px; border-radius:999px;
    background:linear-gradient(90deg,var(--neon-m),var(--neon-c)); color:#151327; font-weight:700; margin-left:8px; font-size:13px}
  .badge.demo{background:linear-gradient(90deg,#ff8ab5,#ffd86a);}

  .road{margin-top:18px; background:var(--glass-2); border:1px solid var(--ring); border-radius:16px; padding:14px; position:relative; z-index:1}
  .bar{height:12px; border-radius:999px; overflow:hidden; background:rgba(0,0,0,.35); border:1px solid var(--ring)}
  .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--neon-c),var(--neon-m),var(--neon-y),var(--neon-g)); transition:width .35s ease;}
  .bar-legend{display:flex; justify-content:space-between; margin-top:8px; font-size:13px; color:var(--ink-dim)}
  .row{display:flex; gap:8px; margin-top:14px; flex-wrap:wrap}
  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:700; color:#0b0c14;
    background:linear-gradient(180deg,#fff,#e9eefc); border-radius:999px; padding:10px 14px;
    box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.35);
  }
  .btn-ghost{ background:var(--glass); color:var(--ink); border:1px solid var(--ring) }
  .btn:active{ transform:translateY(1px) }

  /* Kebab: position with JS, render as fixed so it never clips */
  .drop{ position:relative; }
  .drop-menu{
    position:fixed; inset:auto auto; /* JS sets top/left */
    background:#0e1122f2; border:1px solid var(--ring); border-radius:16px; padding:8px;
    min-width:260px; display:none; z-index:9999; backdrop-filter:blur(8px); max-height:60dvh; overflow:auto;
  }
  .drop.open .drop-menu{ display:block }
  .drop-menu .item{ padding:10px 12px; border-radius:10px; color:var(--ink); font-weight:600; }
  .drop-menu .item:hover{ background:#ffffff18 }
  .drop-menu .danger{ background:#ff5b5b1a; border:1px solid #ff5b5b45 }

  .cta{ margin-top:14px; padding:16px; border-radius:16px; background:linear-gradient(180deg,#1a1031aa,#231b3daa);
        border:1px solid var(--ring); text-align:center; position:relative; z-index:1 }
  .cta .big{ width:100%; padding:14px 16px; border-radius:12px; font-size:18px; font-weight:900;
             background:linear-gradient(90deg,#ff84f7,#ffd86a); color:#0b0c14 }
  .cta small{ display:block; margin-top:8px; color:var(--ink-dim) }

  /* Chat */
  .chat-col{ display:grid; grid-template-rows: 1fr auto; min-height:calc(100dvh - 48px); }
  @media(max-width:900px){ .chat-col{ min-height:70dvh } }
  .chat{ overflow:auto; background:var(--glass); border:1px solid var(--ring); border-radius:22px; padding:18px; scroll-behavior:smooth; }
  .bubble{
    background:linear-gradient(180deg, rgba(255,255,255,0.11), rgba(255,255,255,0.05));
    border:1px solid var(--ring); border-radius:18px; padding:14px 16px; margin:10px 0; position:relative;
  }
  .bubble .who{
    position:absolute; left:-38px; top:10px; width:28px; height:28px;
    display:grid; place-items:center; border-radius:10px; background:#0e1122eb; border:1px solid var(--ring);
  }
  .composer{ margin-top:12px; display:grid; grid-template-columns:1fr 110px; gap:10px; align-items:end }
  textarea{
    width:100%; min-height:54px; max-height:180px; resize:vertical;
    padding:14px 16px; color:var(--ink); background:#0b0f1f; border:1px solid var(--ring); border-radius:16px;
  }
  .send{ height:54px; border-radius:16px; font-weight:900; background:linear-gradient(130deg,#ff7bf1,#82f3ff); color:#0b0c14 }
  .dim{ color:var(--ink-dim) }
</style>
</head>
<body>

<div class="wrap">

  <!-- LEFT -->
  <section class="card" id="left">
    <div class="brand">
      <div class="logo-box"><img class="logo" src="ias-logo.png" alt="IAS Logo"></div>
      <div class="titles">
        <h1>The Freedom Engine</h1>
        <div class="sub">Personal AI Trainer <span class="badge demo" id="tierBadge">Demo</span></div>
      </div>
    </div>

    <div class="road">
      <div class="bar"><span id="bar"></span></div>
      <div class="bar-legend"><span>Roadmap</span><span id="barText">1/5</span></div>
      <div class="row">
        <button class="btn btn-ghost" id="exportBtn">Export</button>
        <button class="btn btn-ghost" id="modulesBtn">Modules</button>

        <div class="drop" id="kebab">
          <button class="btn btn-ghost" id="kebabBtn">‚Ä¶</button>
          <!-- fixed-position menu (no more clipping) -->
          <div class="drop-menu" id="kebabMenu">
            <div class="item" id="saveSnap">Save Snapshot</div>
            <div class="item" id="loadSnap">Load Snapshot</div>
            <div class="item" id="wake">Wake the Engine</div>
            <div class="item danger" id="reset">Reset Progress</div>
            <div class="item" id="switchMode">Switch to Demo / Sign Out</div>
            <div class="item" id="enterKey">I have a license key</div>
            <div class="item" id="buy">Buy</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEMO CTA -->
    <div class="cta" id="demoCTA" style="display:none">
      <button class="big" id="ctaBuy">$29 ‚Äî Unlock Full Engine</button>
      <small>Cloud saves + premium modules included.</small>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="chat-col">
    <div class="chat" id="chat"></div>
    <div class="composer">
      <textarea id="input" placeholder="Answer here. Press Enter to send."></textarea>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </section>

</div>

<script>
/* =========================
   CONFIG
========================= */
const WORKER_BASE = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const STAGES = 5;

/* =========================
   STATE
========================= */
const state = {
  tier: localStorage.getItem("fe_tier") || "demo",
  license: localStorage.getItem("fe_license") || "",
  roadmap: 1,
  messages: [],
  showedCloudHiccup: false
};

const el = {
  bar: document.getElementById("bar"),
  barText: document.getElementById("barText"),
  chat: document.getElementById("chat"),
  input: document.getElementById("input"),
  send: document.getElementById("sendBtn"),
  kebab: document.getElementById("kebab"),
  kebabBtn: document.getElementById("kebabBtn"),
  kebabMenu: document.getElementById("kebabMenu"),
  demoCTA: document.getElementById("demoCTA"),
  tierBadge: document.getElementById("tierBadge"),
  enterKey: document.getElementById("enterKey"),
  buy: document.getElementById("buy"),
  ctaBuy: document.getElementById("ctaBuy"),
  switchMode: document.getElementById("switchMode"),
  reset: document.getElementById("reset"),
  saveSnap: document.getElementById("saveSnap"),
  loadSnap: document.getElementById("loadSnap")
};

/* =========================
   UI HELPERS
========================= */
function setTier(t){
  state.tier = t;
  localStorage.setItem("fe_tier", t);
  const isDemo = t === "demo";
  el.demoCTA.style.display = isDemo ? "block" : "none";
  el.enterKey.style.display = isDemo ? "block" : "none";
  el.buy.style.display = isDemo ? "block" : "none";
  el.tierBadge.textContent = isDemo ? "Demo" : "Premium";
  el.tierBadge.classList.toggle("demo", isDemo);
}
function updateBar(){
  const pct = Math.max(1, Math.min(STAGES, state.roadmap)) / STAGES * 100;
  el.bar.style.width = pct + "%";
  el.barText.textContent = `${Math.max(1,state.roadmap)}/${STAGES}`;
}
function pushBubble(who, text){
  if(!text || typeof text !== "string") return;
  const b = document.createElement("div");
  b.className = "bubble";
  b.innerHTML = `<div class="who">${who==="user"?"üí¨":"‚öôÔ∏è"}</div>${text}`;
  el.chat.appendChild(b);
  state.messages.push({who,text});
  requestAnimationFrame(()=> el.chat.scrollTop = el.chat.scrollHeight);
}
function onceBootGreeting(){
  if(sessionStorage.getItem("fe_booted")) return false;
  sessionStorage.setItem("fe_booted","1");
  pushBubble("ai",
    `Welcome to the Freedom Engine. I‚Äôll carry strategy, templates, and deadlines; you do bite-size reps.
     We‚Äôll ship one in ~72 hours. No monk retreat required.<br><br>
     Pick a lane and I‚Äôll carry the heavy boxes:<br>
     ‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other<br><br>
     If you‚Äôre blank, say <em>‚Äúhelp me choose‚Äù</em> and I‚Äôll pitch options.`
  );
  return true;
}

/* =========================
   KEBAB (fixed-position)
========================= */
function positionKebab(){
  const r = el.kebabBtn.getBoundingClientRect();
  // Prefer opening upward; clamp inside viewport
  const pad = 8;
  const menu = el.kebabMenu;
  menu.style.left = Math.max(pad, Math.min(window.innerWidth - menu.offsetWidth - pad, r.right - menu.offsetWidth)) + "px";
  const desiredTop = r.top - menu.offsetHeight - 8;
  const fallbackTop = r.bottom + 8;
  menu.style.top = (desiredTop > pad ? desiredTop : fallbackTop) + "px";
}

/* =========================
   CLOUD SAVE / LOAD (D1)
========================= */
async function cloudSave(){
  if(state.tier !== "premium" || !state.license) return;
  const payload = { roadmap: state.roadmap, messages: state.messages };
  try{
    await fetch(WORKER_BASE + "/progress",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ license_key: state.license, data: JSON.stringify(payload) })
    });
  }catch(e){
    if(!state.showedCloudHiccup){
      state.showedCloudHiccup = true;
      pushBubble("ai","Cloud hiccup. Keep going ‚Äî I‚Äôm saving locally and I‚Äôll sync when the tubes behave.");
    }
  }
}
async function cloudLoad(){
  if(state.tier !== "premium" || !state.license) return false;
  try{
    const r = await fetch(WORKER_BASE + "/progress?license_key=" + encodeURIComponent(state.license));
    const j = await r.json();
    if(j.ok && j.found && j.data){
      const data = JSON.parse(j.data);
      state.roadmap = Math.max(1, Math.min(STAGES, Number(data.roadmap)||1));
      state.messages = Array.isArray(data.messages) ? data.messages.slice(-80) : [];
      el.chat.innerHTML = "";
      for(const m of state.messages){ pushBubble(m.who, m.text) }
      updateBar();
      return true;
    }
  }catch(e){ /* stay quiet */ }
  return false;
}

/* =========================
   AI (simple but tougher)
========================= */
function aiReply(userText){
  const t = (userText||"").trim();
  const low = t.toLowerCase();

  if(!t){
    pushBubble("ai","Words, champ. Throw me something. Or say <em>help me choose</em>.");
    return;
  }

  if(/help me choose|no clue|idk|i don.?t know/.test(low)){
    state.roadmap = Math.max(1, state.roadmap);
    pushBubble("ai",
      `Cool. Choose a lane ‚Äî reply with a number:<br>
       1) <b>Design</b> ‚Äî logos, graphics, visual packs<br>
       2) <b>Writing</b> ‚Äî copy, guides, micro-ebooks<br>
       3) <b>Coaching</b> ‚Äî 1:1 accelerators, audits<br>
       4) <b>Dev</b> ‚Äî tiny tools, setups, automations<br>
       5) <b>Other</b> ‚Äî pitch your weird idea`
    );
    return;
  }

  const m = low.match(/^\s*([1-5])\s*$/);
  if(m){
    const idx = Number(m[1]);
    const lane = ["","Design","Writing","Coaching","Dev","Other"][idx];
    state.roadmap = 2;
    pushBubble("ai",
      `Locked in: <b>${lane}</b>.<br>
       Give me one fast answer: <b>what can you deliver in the next 48 hours</b> that a real human would pay for?
       Keep it tiny. One deliverable.`
    );
    cloudSave(); updateBar(); return;
  }

  // Default: accept any text and progress
  state.roadmap = Math.min(STAGES, state.roadmap + 1);
  pushBubble("ai",
    `Good ‚Äî I‚Äôve got enough to move. I‚Äôll turn that into a concrete micro-offer and a 3-step launch plan next.
     Quick: list one constraint (time, tools, or absolute ‚Äúnope‚Äù). Constraints make this real.`
  );
  cloudSave(); updateBar();
}

/* =========================
   BOOT
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  // Kebab open/close + positioning
  el.kebabBtn.addEventListener("click", () => {
    el.kebab.classList.toggle("open");
    if(el.kebab.classList.contains("open")){
      el.kebabMenu.style.display = "block";
      positionKebab();
    }else{
      el.kebabMenu.style.display = "none";
    }
  });
  window.addEventListener("resize", () => { if(el.kebab.classList.contains("open")) positionKebab(); });
  document.addEventListener("click",(e)=>{ if(!el.kebab.contains(e.target)) { el.kebab.classList.remove("open"); el.kebabMenu.style.display="none"; }});

  // Buttons
  const gumroad = "https://intellartsystems.gumroad.com/l/the-freedom-engine";
  el.buy.addEventListener("click", ()=> window.open(gumroad,"_blank"));
  el.ctaBuy.addEventListener("click", ()=> window.open(gumroad,"_blank"));

  el.enterKey.addEventListener("click", async ()=>{
    const key = prompt("Enter license key:");
    if(!key) return;
    state.license = key.trim();
    localStorage.setItem("fe_license", state.license);
    setTier("premium");
    const ok = await cloudLoad();
    if(!ok){ el.chat.innerHTML=""; pushBubble("ai","Premium engaged. Clean slate. Say ‚Äúhelp me choose‚Äù or name your lane (design / writing / coaching / dev / other)."); }
    updateBar();
  });

  el.switchMode.addEventListener("click", ()=>{
    localStorage.removeItem("fe_license");
    setTier("demo");
    state.license = "";
    state.roadmap = 1;
    state.messages = [];
    state.showedCloudHiccup = false;
    sessionStorage.removeItem("fe_booted");
    el.chat.innerHTML = "";
    onceBootGreeting();
    updateBar();
  });

  el.reset.addEventListener("click", ()=>{
    state.roadmap = 1; state.messages = []; state.showedCloudHiccup=false;
    sessionStorage.removeItem("fe_booted"); el.chat.innerHTML=""; onceBootGreeting(); cloudSave(); updateBar();
  });

  // Export snapshot (pretty JSON)
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const data = { roadmap: state.roadmap, messages: state.messages, tier: state.tier };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "freedom-engine-snapshot.json"; a.click();
    URL.revokeObjectURL(a.href);
  });

  // Save/Load snapshot to local disk
  el.saveSnap.addEventListener("click", ()=>{
    const data = { roadmap: state.roadmap, messages: state.messages };
    const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "fe-local-snapshot.json"; a.click();
    URL.revokeObjectURL(a.href);
  });
  el.loadSnap.addEventListener("click", ()=>{
    const inp = document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange = async () => {
      const file = inp.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        state.roadmap = Math.max(1, Math.min(STAGES, Number(data.roadmap)||1));
        state.messages = Array.isArray(data.messages) ? data.messages.slice(-80) : [];
        el.chat.innerHTML = ""; state.messages.forEach(m=>pushBubble(m.who,m.text));
        updateBar(); cloudSave();
      }catch(e){ alert("Bad snapshot file."); }
    };
    inp.click();
  });

  // Send
  function sendNow(){
    const v = el.input.value.trim();
    if(!v) return;
    pushBubble("user", v);
    el.input.value="";
    aiReply(v);
  }
  el.send.addEventListener("click", sendNow);
  el.input.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendNow(); } });

  // Init tier and try cloud
  setTier(state.tier);
  let greeted = false;
  if(state.tier==="premium" && state.license){
    const ok = await cloudLoad();
    if(!ok) greeted = onceBootGreeting();
  } else {
    greeted = onceBootGreeting();
  }
  updateBar();
  if(!greeted && state.messages.length===0) onceBootGreeting();
});

/* opener de-dupe on bfcache */
window.addEventListener("pageshow",()=>{
  const list = [...document.querySelectorAll(".bubble")];
  const openers = list.filter(b => b.innerText.toLowerCase().includes("welcome to the freedom engine"));
  if(openers.length>1){ openers.slice(0,-1).forEach(b=>b.remove()); }
});
</script>
</body>
</html>
