<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ---------- Fonts ---------- */
@font-face{
  font-family:"Techfont Italica";
  src:url("assets/Techfont-Italica.ttf") format("truetype"),
      url("Techfont-Italica.ttf") format("truetype");
  font-weight:800; font-style:normal; font-display:swap;
}

/* ---------- Theme ---------- */
:root{
  --bg:#07080b; --ink:#edf2ff; --muted:#aab2c2; --line:#1b2235;
  --g1:rgba(255,255,255,.06); --g2:rgba(255,255,255,.02);
  --n1:#7c86ff; --n2:#3ddc97; --n3:#ff7cba; --n4:#ffa93d;
  --rad:18px; --shadow:0 18px 60px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
  letter-spacing:.2px; overflow-y:overlay;
}

.has-techfont .headline,
.has-techfont .btn,
.has-techfont .pill,
.has-techfont .title {font-family:"Techfont Italica",Inter,system-ui!important;letter-spacing:.8px}
.readable{font-family:Inter,system-ui,-apple-system!important;letter-spacing:0!important}

/* ambient */
.canvas{position:fixed;inset:-20vmax;z-index:-3;filter:blur(80px) saturate(140%);opacity:.35;pointer-events:none;
 background:
  conic-gradient(from 0deg at 30% 30%, var(--n1), transparent 40%),
  conic-gradient(from 180deg at 70% 20%, var(--n3), transparent 45%),
  conic-gradient(from 90deg at 40% 80%, var(--n2), transparent 50%);
 animation:drift 18s linear infinite alternate}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(4rem,-3rem,0) scale(1.1)}}

/* premium sacred fractal overlay */
body.is-premium .fractal{position:fixed;inset:0;pointer-events:none;z-index:-2;opacity:.28;mix-blend-mode:screen}
body.is-premium .fractal::before{content:"";position:absolute;inset:0;
 background:
  radial-gradient(1000px 800px at 18% 22%, rgba(124,134,255,.45), transparent 60%),
  radial-gradient(900px 700px at 82% 18%, rgba(61,220,151,.35), transparent 62%),
  radial-gradient(900px 700px at 78% 78%, rgba(255,124,186,.35), transparent 58%),
  radial-gradient(900px 700px at 24% 76%, rgba(255,169,61,.30), transparent 60%);
}
body.is-premium .fractal::after{content:"";position:absolute;inset:0;
 background:repeating-conic-gradient(from 0deg, rgba(255,255,255,.06) 0 6deg, transparent 6deg 12deg);
 mask:radial-gradient(ellipse at center, rgba(255,255,255,.6), transparent 68%);
 animation:spin 80s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* layout */
.container{max-width:1320px;margin:0 auto;padding:18px 14px 130px;display:grid;gap:18px;grid-template-columns:420px 1fr}
@media(max-width:1100px){.container{grid-template-columns:1fr}}
@media(max-width:720px){.container{grid-template-columns:1fr;gap:12px;padding:12px 10px calc(env(safe-area-inset-bottom)+120px)}}

.glass{background:linear-gradient(180deg,var(--g1),var(--g2));border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);backdrop-filter:blur(14px) saturate(140%)}
.neon{position:relative;isolation:isolate}
.neon::before{content:"";position:absolute;inset:-1px;z-index:-1;border-radius:calc(var(--rad)+2px);
 background:
  linear-gradient(90deg,var(--n1),transparent 30%,transparent 70%,var(--n3)),
  linear-gradient(180deg,var(--n2),transparent 30%,transparent 70%,var(--n4));
 filter:blur(12px) saturate(140%);opacity:.35}

/* sidebar */
.sidebar{position:sticky;top:16px;height:fit-content;padding:14px;z-index:1001}
@media(max-width:1100px){.sidebar{position:relative;top:auto}}

.brand{display:grid;grid-template-columns:210px 1fr;gap:14px;margin-bottom:10px;align-items:center}
@media(max-width:720px){.brand{grid-template-columns:120px 1fr;gap:10px}}

.logo-wrap{width:210px;height:210px;border-radius:22px;position:relative;background:rgba(0,0,0,.25);border:1px solid #2a2f45;overflow:hidden}
@media(max-width:720px){.logo-wrap{width:120px;height:120px;border-radius:16px}}
.logo{position:absolute;left:50%;top:50%;width:300%;height:300%;transform:translate(-50%,-50%);object-fit:contain;display:none}
.logo.spin{display:block;animation:logo-spin 48s linear infinite;
 filter:drop-shadow(0 0 14px rgba(124,134,255,.65)) drop-shadow(0 0 24px rgba(61,220,151,.45)) drop-shadow(0 0 28px rgba(255,124,186,.35))}
@keyframes logo-spin{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}
.logo-fallback{position:absolute;inset:0;display:grid;place-items:center;font-size:40px;font-weight:800;letter-spacing:1.2px;background:linear-gradient(135deg,var(--n2),var(--n1),var(--n3));-webkit-background-clip:text;background-clip:text;color:transparent}
@media(max-width:720px){.logo-fallback{font-size:26px}}

.brand-title{min-width:0}
.title.headline{font-weight:800;font-size:clamp(22px,2.6vw,40px);line-height:1.06;letter-spacing:1.1px;white-space:normal;overflow-wrap:anywhere}
.meta-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{padding:6px 10px;border-radius:999px;background:#0d1222;border:1px solid #293357;font-size:12px}
.pill.demo{color:#ffd7f1;border-color:#4a2a47;background:rgba(255,124,186,.12)}
.pill.full{color:#baffea;border-color:#1f4b3c;background:rgba(61,220,151,.12)}
.sub{color:var(--muted);font-size:14px;margin-top:4px}
@media(max-width:720px){.sub{font-size:12px}}

.block{padding:12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015))}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:9px 12px;font-weight:800;cursor:pointer}
.btn.small{padding:6px 10px;font-size:12px}
.btn.primary{background:linear-gradient(135deg,var(--n1),var(--n3));border:none;box-shadow:0 10px 28px rgba(124,134,255,.35)}
.btn.ok{background:linear-gradient(135deg,var(--n2),#42f5b0);border:none;box-shadow:0 10px 28px rgba(61,220,151,.35)}
.btn.ghost{background:#0d1222;border:1px solid #2a3553}

/* roadmap */
.progress-wrap{margin-top:8px}
.progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:12px;border-radius:999px;background:#0d1222;border:1px solid #2a2f45;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(90deg,var(--n2),var(--n1),var(--n3),var(--n4));width:0%;transition:width .35s ease}

/* Demo CTA */
.cta{margin-top:12px;display:block}
.is-premium .cta{display:none}
.cta .cta-btn{display:block;width:100%;text-align:center;padding:16px 18px;border-radius:14px;border:1px solid #2a3553;background:linear-gradient(135deg,var(--n1),var(--n3));font-weight:800}
.cta .cta-sub{margin-top:6px;font-size:12px;color:#cbd2e6;text-align:center}
@media(max-width:720px){.cta .cta-btn{padding:18px 16px;font-size:16px}}

/* kebab menu */
.menu{position:relative;z-index:3500}
.menu .panel{
  position:fixed;width:280px;max-height:60vh;overflow:auto;
  background:#0b1224;border:1px solid #2a3553;border-radius:12px;display:none;padding:8px;box-shadow:0 18px 50px rgba(0,0,0,.6);z-index:3600
}
.menu.open .panel{display:block}
.menu .panel .btn{display:block;width:100%;text-align:left;margin:4px 0}
/* hide license actions when premium */
.is-premium #unlock,.is-premium #buy{display:none!important}

/* main chat */
.panel{padding:12px}
.chat{overflow:auto;padding:8px 6px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));position:relative;z-index:1;scroll-behavior:smooth;min-height:260px}
.msg{display:grid;grid-template-columns:34px 1fr;gap:10px;margin:10px 0;align-items:start}
.avatar{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;border:1px solid #2c3553;background:linear-gradient(135deg,#1b2135,#121628)}
.avatar.me{border-color:#36407a}.avatar.ai{border-color:#245c46}
.bubble{white-space:pre-wrap;line-height:1.58;padding:12px 14px;border-radius:14px;border:1px solid #28314e;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015))}

/* footer composer */
.footer{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:linear-gradient(180deg,transparent,rgba(5,6,9,.9) 50%, rgba(5,6,9,1) 80%);border-top:1px solid var(--line);z-index:3000}
.composer{max-width:1320px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea.readable{min-height:98px;resize:vertical;border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:10px}

/* modals (modules) */
.modal{position:fixed;inset:0;background:rgba(4,6,12,.6);display:none;align-items:center;justify-content:center;z-index:4200}
.sheet{width:min(800px,94vw);max-height:80vh;overflow:auto;border:1px solid #2a3553;background:#0b1224;border-radius:16px;padding:14px}
.modules-grid{display:grid;grid-template-columns:1fr;gap:10px}
.module{border:1px solid #27314f;border-radius:12px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015))}

/* error/toast */
#error{position:fixed;top:0;left:0;right:0;background:#3b0f14;border-bottom:1px solid #74222c;color:#ffd7dc;padding:10px 14px;font-size:13px;z-index:4000;display:none}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom)+110px);background:#0e1630;border:1px solid #2a3553;color:#d9e0ff;padding:10px 12px;border-radius:10px;z-index:3800;display:none}
</style>
</head>
<body class="is-demo">
<div class="canvas"></div>
<div class="fractal"></div>
<div id="error"></div>
<div id="toast" class="toast readable"></div>

<div class="container" id="app">
  <aside class="glass neon sidebar">
    <div class="brand">
      <div class="logo-wrap">
        <img id="iasLogo" class="logo" alt="IAS">
        <div class="logo-fallback headline">IAS</div>
      </div>
      <div class="brand-title">
        <div class="title headline">The Freedom Engine</div>
        <div class="meta-line">
          <span class="sub readable">Personal AI Trainer</span>
          <span id="modeTag" class="pill demo readable">Demo</span>
        </div>
        <div class="sub readable" id="stageText" style="margin-top:6px">Roadmap: <strong>1/5</strong></div>
      </div>
    </div>

    <div class="block">
      <div class="progress-wrap">
        <div class="progress-label readable"><span>Roadmap</span><span id="stageLabel">1/5</span></div>
        <div class="bar"><div id="barFill"></div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="export" class="btn ghost small headline">Export</button>
        <button id="modulesBtn" class="btn ghost small headline">Modules</button>

        <div class="menu" id="menu">
          <button id="menuBtn" class="btn ghost small headline" aria-haspopup="true" aria-expanded="false">‚ãØ</button>
          <div class="panel" id="menuPanel" role="menu">
            <button id="saveSnap" class="btn ghost small headline" role="menuitem">Save Snapshot</button>
            <button id="loadBtn" class="btn ghost small headline" role="menuitem">Load Snapshot</button>
            <input id="loadSnap" type="file" accept=".json" style="display:none">
            <button id="wake" class="btn ghost small headline" role="menuitem">Wake the Engine</button>
            <button id="reset" class="btn ghost small headline" role="menuitem">Reset Progress</button>
            <button id="switchMode" class="btn ghost small headline" role="menuitem">Switch to Demo / Sign Out</button>
            <button id="unlock" class="btn primary small headline" role="menuitem">I have a license key</button>
            <button id="buy" class="btn primary small headline" role="menuitem">Buy</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Demo CTA lives here; hidden in Premium by CSS -->
    <div id="demoCta" class="cta">
      <button class="cta-btn headline" id="demoBuy">Unlock Full Engine ‚Äî $29</button>
      <div class="cta-sub readable">Keep your progress across devices. Premium modules included.</div>
    </div>
  </aside>

  <main>
    <section class="panel glass neon">
      <div id="chat" class="chat readable"></div>
      <div id="aiStatus" class="sub readable" style="margin-top:6px">Booting the Trainer‚Ä¶</div>
    </section>
  </main>
</div>

<div class="footer glass">
  <div class="composer">
    <textarea id="input" class="readable" placeholder="Answer here. Press Enter to send." disabled></textarea>
    <button id="send" class="btn primary headline" disabled>Send</button>
  </div>
</div>

<!-- Modules Modal -->
<div class="modal" id="modulesModal" style="display:none">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 class="headline">Modules</h3>
      <button id="closeModules" class="btn ghost small headline">Close</button>
    </div>
    <div class="modules-grid" id="modulesGrid"></div>
  </div>
</div>

<script type="module">
/* ---------- helpers ---------- */
const $=id=>document.getElementById(id);
const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
const show=(el,v=true)=>{ if(el) el.style.display=v?'':'none'; };
const text=(el,t)=>{ if(el) el.textContent=t; };
const esc=s=>(s||"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));

/* font flip */
(async()=>{ try{ if(document.fonts?.load){ await document.fonts.load('16px "Techfont Italica"'); document.body.classList.add('has-techfont'); } else { document.body.classList.add('has-techfont'); } }catch{} })();

/* endpoints */
const CLOUD_ENDPOINT="https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL="https://intellartsystems.gumroad.com/l/the-freedom-engine";
const STAGES=["profile","offers","selection","plan","optimize"];

/* prompts */
const PROMPTS={
  profile:`Welcome to the Freedom Engine. I‚Äôm your personal trainer for tiny paid offers.

I‚Äôll carry strategy, templates, and deadlines; you do bite-size reps. We‚Äôll ship one in ~72 hours.

Pick a lane and I‚Äôll carry the heavy boxes:
‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other
If you‚Äôre blank, say ‚Äúhelp me choose‚Äù and I‚Äôll pitch options.`,
  offers:`I‚Äôll pitch three tiny offers (promise ‚Ä¢ price ‚Ä¢ delivery). Pick one; I‚Äôll sharpen it.`,
  selection:`We lock scope + price. One shippable thing.`,
  plan:`72-hour plan: checklist, page copy, ad seed at $5/day.`,
  optimize:`Objection patch, hooks, and tiny upsell. Then we ship.`
};

/* refs */
const chatEl=$('chat'), inputEl=$('input'), sendBtn=$('send'), aiStatus=$('aiStatus');
const stageLabel=$('stageLabel'), stageText=$('stageText'), barFill=$('barFill'), modeTag=$('modeTag');
const demoCta=$('demoCta'), demoBuy=$('demoBuy'), buyBtn=$('buy'), unlockBtn=$('unlock');
const menuRoot=$('menu'), menuBtn=$('menuBtn'), menuPanel=$('menuPanel');
const modulesBtn=$('modulesBtn'), modulesModal=$('modulesModal'), modulesGrid=$('modulesGrid'), closeModules=$('closeModules');
const errorEl=$('error'), footerEl=document.querySelector('.footer'), toastEl=$('toast');

/* state */
let history=JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked=localStorage.getItem('fe_unlocked')==='1';
let licenseKey=localStorage.getItem('fe_license')||"";
let currentStage=localStorage.getItem('fe_stage')||"profile";
let agentMemory=JSON.parse(localStorage.getItem('fe_memory')||'{"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""}');
let modules=JSON.parse(localStorage.getItem('fe_modules')||'[]');

function showErr(msg){ console.error(msg); if(errorEl){ errorEl.textContent=(msg?.message||String(msg)); errorEl.style.display='block'; setTimeout(()=>errorEl.style.display='none',3500);} }
function toast(s){ toastEl.textContent=s; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',2600); }

/* logo load/spin */
(function(){
  const logo=$('iasLogo'); const fallback=document.querySelector('.logo-fallback'); if(!logo)return;
  const primary=new URL('assets/ias-logo.png',location.href).href;
  const alt=new URL('ias-logo.png',location.href).href;
  let tried=false; const ok=()=>{logo.classList.add('spin');logo.style.display='block'; if(fallback) fallback.style.display='none';};
  on(logo,'load',ok); logo.onerror=()=>{ if(!tried){ tried=true; logo.src=alt; } };
  logo.src=primary;
})();

/* tone + prime */
function detectStyleFrom(t=""){t=t.toLowerCase();
  if(/stuck|overwhelmed|help|lost/.test(t))return"coach";
  if(/how|steps|plan|framework/.test(t))return"engineer";
  if(/write|headline|copy|hook|story/.test(t))return"ghostwriter";
  if(/procrastinat|excuse|no time|scared|lazy/.test(t))return"dark";
  return"coach";
}
const STYLE_PRIME={
  coach:"Direct, encouraging, witty roast; never cruel.",
  engineer:"Stepwise and crisp.",
  ghostwriter:"Copy-led examples and hooks.",
  dark:"Ruthless accountability; dark humor (safe)."
};
function systemPrime(style="coach",stage="profile"){
  return `You are THE FREEDOM ENGINE ‚Äî mentor for tiny profitable offers. Mission: ship in ~72 hours.
Explain first, guide second, ask ONE small thing. Conversational with dark witty asides.
Tone: ${STYLE_PRIME[style]}. Stage: ${stage}. Advance only when user confirms.
Handle trolling/NSFW bait by deflecting with humor and steering back to the offer (never engage sexually).
STRICT JSON ONLY:
{"say":"...","stage":"profile|offers|selection|plan|optimize","next_questions":["..."],"memory_delta":{"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""},"confidence":0.0}
"say" <= 140 words.`;
}

/* rendering */
const bubble=(role,content)=>`<div class="msg ${role==='user'?'me':'ai'}"><div class="avatar ${role==='user'?'me':'ai'}">${role==='user'?'üí¨':'‚öôÔ∏è'}</div><div class="bubble readable">${esc(content)}</div></div>`;
function render(){ chatEl.innerHTML=history.map(m=>bubble(m.role,m.content)).join(''); requestAnimationFrame(()=>chatEl.scrollTop=chatEl.scrollHeight); }
function setProgressUI(idx){ text(stageLabel,`${idx+1}/${STAGES.length}`); stageText.innerHTML=`Roadmap: <span class="readable"><strong>${idx+1}/${STAGES.length}</strong></span>`; barFill.style.width=`${Math.round(((idx+1)/STAGES.length)*100)}%`; }
function stageIndex(n){return Math.max(0,STAGES.indexOf(n));}
function updateProgressUI(){ setProgressUI(stageIndex(currentStage)); }

/* chat height */
function sizeChat(){
  const rect = chatEl.getBoundingClientRect();
  const footerH = footerEl.getBoundingClientRect().height || 120;
  const topY = rect.top + window.scrollY;
  const viewH = window.innerHeight;
  const target = Math.max(260, viewH - footerH - (topY - window.scrollY) - 18);
  chatEl.style.height = target + "px";
}
['resize','orientationchange','load'].forEach(ev=>window.addEventListener(ev,()=>setTimeout(sizeChat,50)));
new ResizeObserver(()=>setTimeout(sizeChat,10)).observe(footerEl);

/* UI state */
function bodyClassSync(){ document.body.classList.toggle('is-premium', !!unlocked); document.body.classList.toggle('is-demo', !unlocked); }
function enforceUIState(){
  bodyClassSync();
  modeTag.textContent=unlocked?'Premium':'Demo';
  modeTag.className='pill '+(unlocked?'full':'demo')+' readable';
}

/* persistence */
function persistLocal(){
  localStorage.setItem('fe_history',JSON.stringify(history));
  localStorage.setItem('fe_memory',JSON.stringify(agentMemory));
  localStorage.setItem('fe_modules',JSON.stringify(modules));
  localStorage.setItem('fe_stage',currentStage);
  localStorage.setItem('fe_unlocked',unlocked?'1':'');
  if(licenseKey) localStorage.setItem('fe_license',licenseKey);
  enforceUIState();
}

/* cloud save/load (D1-backed) */
let saveTimer=null; function autoSaveSoon(){ if(saveTimer)clearTimeout(saveTimer); saveTimer=setTimeout(()=>cloudSaveWithBackoff(),600); }
async function cloudSave(){ if(!unlocked||!licenseKey) return {ok:false}; const payload={license_key:licenseKey,data:{memory:agentMemory,stage:currentStage,history,modules}};
  const r=await fetch(`${CLOUD_ENDPOINT}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}); if(!r.ok) throw new Error("save "+r.status); return await r.json();}
async function cloudSaveWithBackoff(){ let tries=0; while(tries<3){ try{ const j=await cloudSave(); if(j&&j.ok){ return; } }catch{} await new Promise(r=>setTimeout(r,400*(2**tries))); tries++; } }
async function cloudLoad(){ if(!unlocked||!licenseKey) return false; try{ const r=await fetch(`${CLOUD_ENDPOINT}/progress?license_key=${encodeURIComponent(licenseKey)}`); if(!r.ok) return false; const j=await r.json(); if(!j?.ok||!j.data) return false;
  const d=j.data; agentMemory=d.memory||agentMemory; currentStage=d.stage||currentStage; history=Array.isArray(d.history)?d.history:history; modules=Array.isArray(d.modules)?d.modules:modules; persistLocal(); return true;}catch{return false;}}

/* API + parsing */
async function callCloud(messages){ const r=await fetch(`${CLOUD_ENDPOINT}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})}); if(!r.ok) throw new Error(`Cloud ${r.status}`); const j=await r.json(); return j.output||""; }
function scrubUndefined(s){
  return (s||"")
    .replace(/\bundefined\b/gi,"")
    .replace(/\bundefined[:=][^\s,)}]+/gi,"")
    .replace(/\bconfidence\s*[:=]\s*[\d.]+\b/gi,"")
    .replace(/\s{3,}/g," ").trim();
}
function extractJSONBlock(s){ let d=null, i=s.indexOf('{'); while(i!==-1){ try{ d=JSON.parse(s.slice(i)); break; }catch{ i=s.indexOf('{',i+1);} } return d; }
function parseAgent(out){ out=(out||"").trim(); let p=null; try{ p=JSON.parse(out); }catch{} if(!p) p=extractJSONBlock(out);
  if(p && typeof p.say==="string"){ return { say:scrubUndefined(p.say), stage:(STAGES.includes(p.stage)?p.stage:currentStage), memory_delta:p.memory_delta||{}, confidence:p.confidence??.7 }; }
  const cleaned=scrubUndefined(out);
  return { say: cleaned || "Say ‚Äúhelp me choose‚Äù and I‚Äôll pitch three lanes to get moving.", stage: currentStage, memory_delta:{}, confidence:.6 };
}

/* chat engine */
const push=(role,content)=>{ history.push({role,content}); persistLocal(); render(); updateProgressUI(); autoSaveSoon(); requestAnimationFrame(sizeChat); };
function activeStyle(){ const lastUser=[...history].reverse().find(m=>m.role==='user')?.content||""; const s=detectStyleFrom(lastUser)||agentMemory.style||"coach"; agentMemory.style=s; localStorage.setItem('fe_memory',JSON.stringify(agentMemory)); return s; }
function canAdvance(to){ const cur=stageIndex(currentStage), nx=stageIndex(to); return nx===cur+1; }
function advanceStageMaybe(to){ if(STAGES.includes(to) && canAdvance(to)) currentStage=to; }
function normalizeUser(t){ const s=t.trim().toLowerCase(); if(!s || /^(idk|no|none|no clue|not sure|\?)$/.test(s)) return "help me choose"; return t; }

async function agentRespond(){
  const style=activeStyle();
  const ctx=[
    {role:"system",content:systemPrime(style,currentStage)},
    {role:"system",content:`MEMORY:${JSON.stringify(agentMemory)}`},
    {role:"system",content:`CURRICULUM:${PROMPTS[currentStage]||""}`},
    ...history.slice(-10).map(m=>({role:m.role==='assistant'?'assistant':'user',content:m.content}))
  ];
  let raw=await callCloud(ctx);
  let p=parseAgent(raw);
  if(!p.say || p.say.length<4){
    const retry=[{role:"system",content:systemPrime(style,currentStage)},{role:"user",content:"Return valid JSON only."},...ctx.slice(-6)];
    raw=await callCloud(retry); p=parseAgent(raw);
  }
  if(p.memory_delta && typeof p.memory_delta==='object'){
    for(const k of ["skills","audience","offer","price","style","blocked_by"]){ if(p.memory_delta[k]) agentMemory[k]=p.memory_delta[k]; }
  }
  advanceStageMaybe(p.stage);
  persistLocal(); autoSaveSoon();
  push('assistant', p.say);
}

/* boot */
function greetIfEmpty(){ if(history.length===0){ push('assistant', PROMPTS.profile); } }
async function boot(){
  enforceUIState(); updateProgressUI(); inputEl.disabled=false; sendBtn.disabled=false;
  if(unlocked && licenseKey){ const ok=await cloudLoad(); if(!ok) toast("Cloud not reachable ‚Äî using local progress."); }
  render(); greetIfEmpty(); aiStatus.textContent="Ready."; sizeChat();
}
document.addEventListener('DOMContentLoaded',boot);

/* composer */
on(sendBtn,'click',async()=>{
  const raw=inputEl.value; const t=normalizeUser(raw); if(!t) return;
  inputEl.value=""; push('user',t); aiStatus.textContent="Thinking‚Ä¶";
  try{ await agentRespond(); }catch(e){ showErr(e); push('assistant',"Cloud hiccup. Give me your next answer; I‚Äôll keep us moving."); }
  aiStatus.textContent="Ready."; setTimeout(sizeChat,60);
});
on(inputEl,'keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

/* export (HTML brief) */
on($('export'),'click', async ()=>{
  try{
    const task=`User memory: ${JSON.stringify(agentMemory)}
Create a crisp execution brief (<700 words):
- Offer: name, audience, promise, price
- Product page bullets + Gumroad blurb
- 72-hour launch checklist (Day 1‚Äì3) at $5/day
- 5 ad hooks + 3 headlines
Tone: tough-love mentor with dark humor.`;
    const report=await callCloud([{role:"system",content:"You compile briefs."},...history.slice(-16),{role:"user",content:task}]);
    const html=`<!doctype html><html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}.h{font-family:"Techfont Italica",Inter;font-size:28px;font-weight:800;margin:0 0 4px;letter-spacing:.8px}
.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}</style></head>
<body><div class="wrap"><div class="h">The Freedom Engine ‚Äî Export</div>
<div class="sub">Generated ${new Date().toLocaleString()}</div>
<div class="card"><h3 class="h">Execution Brief</h3><pre>${esc(report)}</pre></div></div></body></html>`;
    downloadBlob(html,'text/html','freedom-engine-export.html');
  }catch(e){ showErr(e); alert("Couldn‚Äôt generate export‚Äîcloud hiccup."); }
});

/* menu position */
function placeMenu(){
  const btnRect=menuBtn.getBoundingClientRect();
  const panel=menuPanel; const pad=8;
  const prefUp = (btnRect.bottom + 320) > window.innerHeight;
  const top = prefUp ? (btnRect.top - panel.offsetHeight - pad) : (btnRect.bottom + pad);
  const left = Math.min(Math.max(btnRect.right - panel.offsetWidth, 8), window.innerWidth - panel.offsetWidth - 8);
  panel.style.top = Math.max(8, top) + "px";
  panel.style.left = left + "px";
}
on(menuBtn,'click',()=>{
  const open=menuRoot.classList.toggle('open');
  menuBtn.setAttribute('aria-expanded', open?'true':'false');
  if(open){ show(menuPanel,true); setTimeout(()=>{ placeMenu(); }, 10); }
});
document.addEventListener('click',e=>{ if(!menuRoot.contains(e.target)) menuRoot.classList.remove('open'); });

/* snapshot */
on($('saveSnap'),'click',()=>{
  const snap={when:new Date().toISOString(),memory:agentMemory,stage:currentStage,history,modules,unlocked};
  downloadBlob(JSON.stringify(snap,null,2),'application/json',`freedom-snapshot-${Date.now()}.json`);
});
on($('loadBtn'),'click',()=>$('loadSnap').click());
on($('loadSnap'),'change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const snap=JSON.parse(await f.text());
    agentMemory=snap.memory||agentMemory; currentStage=snap.stage||"profile";
    history=Array.isArray(snap.history)?snap.history:[]; modules=Array.isArray(snap.modules)?snap.modules:[];
    unlocked=!!snap.unlocked; licenseKey=localStorage.getItem('fe_license')||licenseKey;
    persistLocal(); render(); updateProgressUI(); enforceUIState();
    push('assistant',"Snapshot loaded. Back on track."); autoSaveSoon(); sizeChat();
  }catch(err){ showErr(err); alert("Bad snapshot file."); }
});

/* reset/sign out */
on($('reset'),'click',()=>{
  if(confirm("Reset all progress?")){
    history=[]; agentMemory={"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""}; currentStage="profile";
    localStorage.removeItem('fe_history'); localStorage.removeItem('fe_stage'); localStorage.removeItem('fe_memory');
    setProgressUI(0); render(); push('assistant', PROMPTS.profile); autoSaveSoon(); sizeChat(); enforceUIState();
  }
});
on($('switchMode'),'click',()=>{
  if(confirm("Sign out on this device? Your premium progress stays attached to the license.")){
    const keep=['fe_license']; const stash=keep.reduce((m,k)=>(m[k]=localStorage.getItem(k)||"",m),{});
    localStorage.clear(); Object.entries(stash).forEach(([k,v])=>v&&localStorage.setItem(k,v));
    unlocked=false; persistLocal(); location.replace(location.pathname);
  }
});

/* buy/unlock */
on(buyBtn,'click',()=>window.open(GUMROAD_URL,'_blank'));
on(demoBuy,'click',()=>window.open(GUMROAD_URL,'_blank'));
on(unlockBtn,'click',async()=>{
  const key=prompt("Paste your license key:"); if(!key) return;
  try{
    const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim()})}).then(r=>r.json());
    if(r.ok){
      unlocked=true; licenseKey=key.trim(); persistLocal();
      await cloudSaveWithBackoff(); const loaded=await cloudLoad();
      enforceUIState();
      if(loaded){ render(); push('assistant',"Premium engaged. Pulled your progress from the vault. Back to work."); }
      else { push('assistant',"Premium engaged. Clean slate stored in the vault. Let‚Äôs move."); await cloudSaveWithBackoff(); }
      sizeChat();
    } else alert("Key didn‚Äôt verify. Check your Gumroad receipt.");
  }catch(e){ showErr(e); alert("Verification failed‚Äînetwork/endpoint."); }
});

/* modules */
const MODULES=[{id:"ads",name:"Ad Creative Booster",product_id:"MOD_ADS_ID",price:"$12",desc:"Generate ad images + angles."},
  {id:"email",name:"Email Launch Booster",product_id:"MOD_EMAIL_ID",price:"$9",desc:"Auto-draft 3-day launch emails."},
  {id:"planner",name:"Content Planner",product_id:"MOD_PLAN_ID",price:"$12",desc:"7-day content seed plan."},
  {id:"proof",name:"Proof Builder",product_id:"MOD_PROOF_ID",price:"$7",desc:"Extract proof from past wins."}];
function renderModules(){
  modulesGrid.innerHTML = MODULES.map(m=>{
    const active = modules.some(x=>x.id===m.id);
    return `<div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h4 class="headline">${m.name}</h4>
        <span class="pill ${active?'full':'demo'} readable">${active?'Active':'Locked'}</span>
      </div>
      <div style="color:#cfd6ff;font-size:13px;margin-bottom:8px" class="readable">${m.desc}</div>
      <div class="row">
        ${active?`<button class="btn ok small headline" data-act="deactivate" data-id="${m.id}">Deactivate</button>`:
          `<button class="btn primary small headline" data-act="unlock" data-id="${m.id}">Unlock ${m.price}</button>`}
        <button class="btn ghost small headline" data-act="preview" data-id="${m.id}">Preview</button>
      </div>
    </div>`;
  }).join('');
}
on(modulesBtn,'click',()=>{ renderModules(); modulesModal.style.display='flex'; });
on(closeModules,'click',()=>{ modulesModal.style.display='none'; });
on(modulesGrid,'click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id; const act=btn.dataset.act; const mod=MODULES.find(x=>x.id===id); if(!mod) return;
  if(act==='preview'){ push('assistant', `Preview: **${mod.name}** ‚Äî ${mod.desc}\nSay ‚Äúapply ${mod.id}‚Äù to weave it into the next steps.`); }
  if(act==='deactivate'){ modules = modules.filter(x=>x.id!==id); persistLocal(); renderModules(); push('assistant', `${mod.name} deactivated.`); autoSaveSoon(); }
  if(act==='unlock'){
    const key=licenseKey || prompt(`Paste the license key for ${mod.name}:`); if(!key) return;
    try{
      const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim(),product_id:mod.product_id})}).then(r=>r.json());
      if(r.ok){ modules=[...modules.filter(x=>x.id!==id), {id:mod.id, when:Date.now()}]; persistLocal(); renderModules(); push('assistant', `${mod.name} unlocked. I‚Äôll incorporate it automatically.`); autoSaveSoon(); }
      else alert("That key didn‚Äôt verify for this module.");
    }catch(err){ showErr(err); alert("Verification failed‚Äînetwork/endpoint."); }
  }
});

/* utilities */
function downloadBlob(content,type,name){const blob=new Blob([content],{type});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();}

/* keep things synced */
function refreshEverything(){ updateProgressUI(); enforceUIState(); render(); sizeChat(); }
document.addEventListener('DOMContentLoaded',refreshEverything);
setInterval(enforceUIState, 3000); // safety net

/* initial status */
(function init(){ aiStatus.textContent="Booting the Trainer‚Ä¶"; setTimeout(()=>aiStatus.textContent="Ready.",600); })();
</script>
</body>
</html>
