<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>

<style>
  :root{
    --bg:#0c0a1a;
    --panel:#131129dd;
    --panel-2:#171535dd;
    --chip:#242046;
    --ink:#e9e7ff;
    --ink-dim:#c9c4ff;
    --accent-1:#66e1ff;
    --accent-2:#7bffad;
    --accent-3:#ffc36c;
    --accent-4:#ff7ad9;
    --good:#7bffad;
    --bad:#ff7a7a;
    --glass:rgba(255,255,255,0.06);
    --glass-2:rgba(255,255,255,0.10);
    --ring:rgba(255,255,255,0.25);
    --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 1px rgba(255,255,255,.15);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 800px at 10% -10%, #2b2055 0%, #0c0a1a 55%) fixed;
    color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Techfont-Italica", sans-serif;
    overflow:hidden;
  }
  /* subtle star dust */
  body::before{
    content:""; position:fixed; inset:-20% -20% auto -20%; height:140%;
    background:
      radial-gradient(1200px 700px at 80% -20%, rgba(255,255,255,.07), transparent 60%),
      radial-gradient(900px 600px at 10% 110%, rgba(255,255,255,.06), transparent 60%);
    pointer-events:none; filter:saturate(120%);
  }

  /* Premium fractal shimmer overlay */
  body.premium::after{
    content:""; position:fixed; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:.35;
    background:
      conic-gradient(from 0deg at 20% 30%, #5ff 0 20%, #0f0 30%, #ff0 40%, #f0f 60%, #0ff 80%, #5ff 100%);
    -webkit-mask:
      radial-gradient(400px 400px at 10% 20%, rgba(0,0,0,.8) 30%, transparent 60%),
      radial-gradient(600px 600px at 90% 80%, rgba(0,0,0,.8) 30%, transparent 60%);
    animation: swirl 24s linear infinite;
    filter: blur(40px);
  }
  @keyframes swirl { to { transform: rotate(360deg) scale(1.05); } }

  .wrap{ display:grid; grid-template-columns: 420px 1fr; gap:24px; padding:24px; height:100%; }
  @media (max-width: 980px){
    body{overflow:auto}
    .wrap{ grid-template-columns: 1fr; height:auto; padding:16px; gap:16px; }
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05)) padding-box,
                radial-gradient(120% 120% at -10% -30%, #7bffad55, transparent 40%),
                radial-gradient(90% 90% at 120% 10%, #66e1ff40, transparent 40%),
                var(--panel);
    border:1px solid var(--ring);
    border-radius:24px; box-shadow: var(--shadow); position:relative; overflow:hidden;
  }
  .card .inner{ padding:24px; }

  /* header / left column */
  .header{
    display:grid; grid-template-rows:auto auto auto 1fr; gap:14px; height:100%;
  }
  .brand{
    display:grid; grid-template-columns:120px 1fr; gap:18px; align-items:center;
  }
  .brand .logo-box{
    width:120px; height:120px; border-radius:20px; background:var(--glass);
    border:1px solid var(--ring); display:grid; place-items:center; overflow:hidden;
    box-shadow:var(--shadow);
  }
  .brand .logo{
    width:360px; height:360px; /* 3x bigger than box; clipped by overflow */
    background: url("./ias-logo.png") center/contain no-repeat;
    animation: spin 40s linear infinite;
    filter: drop-shadow(0 0 12px rgba(123,255,173,.35)) drop-shadow(0 0 16px rgba(255,122,217,.25));
  }
  @keyframes spin { to{ transform:rotate(360deg);} }

  .title h1{
    margin:0; line-height:1;
    font-weight:800; font-size:48px; letter-spacing:.5px;
    text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 18px rgba(102,225,255,.35);
  }
  .sub{ opacity:.85; margin-top:6px; font-size:15px }
  .badge{
    display:inline-block; padding:6px 10px; border-radius:999px;
    background: linear-gradient(90deg, #5ff6, #f7a6); border:1px solid var(--ring);
    font-size:12px; font-weight:700;
  }

  .roadmap{ margin-top:8px }
  .bar{
    height:14px; border-radius:999px; background: #0006; border:1px solid var(--ring);
    position:relative; overflow:hidden;
  }
  .fill{
    position:absolute; inset:0 auto 0 0; width:20%;
    background: linear-gradient(90deg, var(--accent-1), var(--accent-2), var(--accent-3), var(--accent-4));
    border-right:1px solid rgba(255,255,255,.4);
  }
  .bar-head{ display:flex; justify-content:space-between; font-size:12px; opacity:.9; margin:8px 2px 6px }

  .actions{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
  .btn{
    background: var(--chip); color:var(--ink); border:1px solid var(--ring);
    padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer;
    box-shadow:var(--shadow); transition: transform .06s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{
    background: linear-gradient(90deg, #66e1ff, #7bffad, #ffc36c, #ff7ad9);
    color:#0b0a16; border:none;
  }
  .kebab{ width:44px; height:44px; display:grid; place-items:center; border-radius:12px }
  .kebab::after{ content:"‚ãØ"; font-size:22px }

  /* kebab menu ‚Äì opens above the kebab */
  .menu{
    position:absolute; min-width:240px; background:var(--panel-2); border:1px solid var(--ring);
    border-radius:16px; box-shadow:var(--shadow); padding:8px; z-index:30; display:none;
  }
  .menu.open{ display:block; }
  .menu .mi{ padding:10px 12px; border-radius:12px; cursor:pointer; background:transparent; }
  .menu .mi:hover{ background:rgba(255,255,255,.07); }

  /* CTA ribbon for demo (big button) */
  .cta-ribbon{ margin-top:14px; padding:14px; border-radius:16px; border:1px dashed var(--ring);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }
  .cta-title{ font-weight:800; margin-bottom:10px }
  .cta-note{ font-size:13px; opacity:.85 }

  /* chat column */
  .chat{
    display:grid; grid-template-rows: 1fr auto; height:100%;
  }
  .chat .surface{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)), var(--panel);
    border:1px solid var(--ring); border-radius:24px; padding:20px; overflow:auto; min-height:240px;
  }
  .msg{
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
    border:1px solid var(--ring); border-radius:18px; margin:14px 0; padding:16px 18px;
    box-shadow:var(--shadow); position:relative;
  }
  .msg .bubble-head{ position:absolute; left:-12px; top:-12px; width:36px; height:36px;
    display:grid; place-items:center; border-radius:10px; background:var(--chip); border:1px solid var(--ring);
  }
  .msg.user .bubble-head{ background: linear-gradient(135deg, #66e1ff, #ff7ad9); color:#0b0a16; font-weight:900 }
  .msg.user .bubble-head::after{ content:"üí¨"; }
  .msg.bot .bubble-head::after{ content:"‚öôÔ∏è"; }

  .composer{
    margin-top:12px; display:grid; grid-template-columns: 1fr 80px; gap:10px; align-items:end;
  }
  .composer textarea{
    resize:none; height:64px; border-radius:16px; border:1px solid var(--ring);
    background:#0f0e20; color:var(--ink); padding:14px 16px; outline:none; box-shadow:var(--shadow);
  }
  .composer button{
    height:64px; border-radius:16px; border:1px solid var(--ring); background:var(--chip);
    color:var(--ink); font-weight:800; cursor:pointer; box-shadow:var(--shadow);
    background-image: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
  }
  .composer button:hover{ filter:saturate(120%) }

  @media (max-width:980px){
    .title h1{ font-size:34px }
    .brand{ grid-template-columns:96px 1fr }
    .brand .logo-box{ width:96px; height:96px }
    .brand .logo{ width:288px; height:288px }
    .composer{ grid-template-columns: 1fr 76px }
    .composer textarea{ height:72px }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT CARD -->
    <section class="card header" id="leftCard">
      <div class="inner">
        <div class="brand">
          <div class="logo-box"><div class="logo" aria-hidden="true"></div></div>
          <div class="title">
            <h1>The Freedom Engine</h1>
            <div class="sub">Personal AI Trainer <span class="badge" data-mode-badge>Demo</span></div>
          </div>
        </div>

        <div class="roadmap">
          <div class="bar-head">
            <div>Roadmap</div>
            <div data-roadmap-text>1/5</div>
          </div>
          <div class="bar"><div class="fill" data-roadmap-fill style="width:20%"></div></div>
        </div>

        <div class="actions">
          <button class="btn" id="btnExport">Export</button>
          <button class="btn" id="btnModules">Modules</button>
          <button class="btn kebab" id="btnMore" aria-haspopup="menu" aria-expanded="false"></button>
          <!-- Kebab menu (opens ABOVE the kebab) -->
          <div class="menu" id="moreMenu" role="menu" aria-label="More">
            <div class="mi" id="miSave">Save Snapshot</div>
            <div class="mi" id="miLoad">Load Snapshot</div>
            <div class="mi" id="miWake">Wake the Engine</div>
            <div class="mi" id="miReset">Reset Progress</div>
            <div class="mi" id="miSign">Switch to Demo / Sign Out</div>
            <div class="mi" data-menu-have-key>I have a license key</div>
            <div class="mi" data-menu-buy>Buy</div>
          </div>
        </div>

        <!-- Demo CTA ribbon -->
        <div class="cta-ribbon" id="demoCta" role="region" aria-live="polite">
          <div class="cta-title">Unlock Full Engine ‚Äî <strong>$29</strong></div>
          <div class="cta-note">Keep cloud progress across devices. Premium modules included.</div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" data-cta-buy>$29 ‚Äì Unlock Full Engine</button>
            <button class="btn" data-cta-have-key>I have a license key</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CHAT COLUMN -->
    <section class="card chat" id="chatCard">
      <div class="surface" id="chatSurface" aria-live="polite" aria-label="Conversation"></div>
      <div class="composer">
        <textarea id="composer" placeholder="Answer here. Press Enter to send."></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </section>
  </div>

<script>
/* ---------- CONFIG ---------- */
const ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const VERIFY_URL = `${ENDPOINT}/verify`;
const CHAT_URL   = `${ENDPOINT}/chat`;

/* ---------- PROGRESS / LICENSE (cloud + local) ---------- */
(() => {
  const LS = { key:"fe.license", cache:"fe.progress.cache" };
  const STAGES = ["profile","offer","copy","launch","done"];
  const stageIndex = s => Math.max(1, Math.min(5, STAGES.indexOf((s||"").toLowerCase()) + 1));

  const el = {
    roadmapFill: () => document.querySelector('[data-roadmap-fill]'),
    roadmapText: () => document.querySelector('[data-roadmap-text]'),
    modeBadge: () => document.querySelector('[data-mode-badge]'),
    buyBtn: () => document.querySelector('[data-cta-buy]'),
    haveKeyBtn: () => document.querySelector('[data-cta-have-key]'),
    menuBuy: () => document.querySelector('[data-menu-buy]'),
    menuHaveKey: () => document.querySelector('[data-menu-have-key]'),
    demoCta: () => document.getElementById('demoCta'),
  };

  const getLicense = () => localStorage.getItem(LS.key) || "";
  const setLicense = k => { k ? localStorage.setItem(LS.key,k) : localStorage.removeItem(LS.key); };

  const api = {
    async getProgress(license){
      const u=new URL(ENDPOINT+"/progress"); u.searchParams.set("license_key",license);
      const r=await fetch(u); if(!r.ok) throw new Error("GET "+r.status); return r.json();
    },
    async putProgress(license,data){
      const r=await fetch(ENDPOINT+"/progress",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:license,data})});
      if(!r.ok) throw new Error("POST "+r.status); return r.json();
    }
  };

  const getLocal=()=>{ try{ return JSON.parse(localStorage.getItem(LS.cache)||"null"); }catch{ return null; } };
  const setLocal=(obj)=>{ try{ localStorage.setItem(LS.cache, JSON.stringify(obj||null)); }catch{} };

  let saveTimer=null, saving=Promise.resolve();
  function queueSave(license,data){
    clearTimeout(saveTimer);
    const payload=structuredClone(data);
    saveTimer=setTimeout(()=>{ saving=saving.then(()=>api.putProgress(license,payload).catch(()=>{})); },350);
  }

  function setModeUI(isPremium){
    const badge=el.modeBadge(); if(badge) badge.textContent=isPremium?"Premium":"Demo";
    document.body.classList.toggle('premium', !!isPremium);
    const showDemo=!isPremium;
    [el.buyBtn(), el.haveKeyBtn(), el.menuBuy(), el.menuHaveKey(), el.demoCta()].forEach(n=>{
      if(!n) return; n.style.display = showDemo ? "" : "none";
    });
  }
  function setRoadmap(stage){
    const idx=stageIndex(stage); const pct=(idx/5)*100;
    const f=el.roadmapFill(); if(f) f.style.width=pct+"%";
    const t=el.roadmapText(); if(t) t.textContent=`${idx}/5`;
  }

  const Progress = {
    data:{ stage:"profile", memory:{}, history:[], modules:[] },
    isPremium:false, license:"",

    async hydrate(){
      const k=getLicense(); this.license=k; this.isPremium=!!k;
      if(k){
        try{
          const res=await api.getProgress(k);
          if(res?.ok && res.data){ this.data=res.data; setLocal(res.data); }
          else{
            const local=getLocal();
            if(local){ this.data=local; await api.putProgress(k,local).catch(()=>{}); }
            else{ await api.putProgress(k,this.data).catch(()=>{}); }
          }
        }catch{
          const local=getLocal(); if(local) this.data=local;
        }
      }else{
        const local=getLocal(); if(local) this.data=local;
      }
      setModeUI(this.isPremium); setRoadmap(this.data.stage);
      document.dispatchEvent(new CustomEvent("fe:hydrated",{detail:{isPremium:this.isPremium,data:this.data}}));
    },
    update(mutator){
      if(typeof mutator==="function") mutator(this.data);
      setLocal(this.data); setRoadmap(this.data.stage);
      if(this.license) queueSave(this.license,this.data);
    },
    async unlock(k){ setLicense(k); await this.hydrate(); },
    async signOut(){
      setLicense(""); setLocal(null); this.license=""; this.isPremium=false;
      this.data={stage:"profile",memory:{},history:[],modules:[]};
      setModeUI(false); setRoadmap(this.data.stage);
      document.dispatchEvent(new CustomEvent("fe:signedout"));
    }
  };

  window.FEProgress = Progress;
  document.addEventListener("DOMContentLoaded", ()=>Progress.hydrate());
})();
</script>

<script>
/* ---------- UI + CHAT WIRING ---------- */
const chatSurface = document.getElementById('chatSurface');
const composer = document.getElementById('composer');
const sendBtn = document.getElementById('sendBtn');
const kebab = document.getElementById('btnMore');
const menu = document.getElementById('moreMenu');
const miSave  = document.getElementById('miSave');
const miLoad  = document.getElementById('miLoad');
const miReset = document.getElementById('miReset');
const miSign  = document.getElementById('miSign');
const miWake  = document.getElementById('miWake');

function scrollBottom(){ chatSurface.scrollTop = chatSurface.scrollHeight + 9999; }

function postMsg(text, who="bot", opts={}){
  if(opts.opener){
    // remove any previous opener to avoid stacks
    [...chatSurface.querySelectorAll('.msg[data-opener]')].forEach(n=>n.remove());
  }
  const msg = document.createElement('div');
  msg.className = `msg ${who}`;
  if(opts.opener) msg.setAttribute('data-opener','1');
  msg.innerHTML = `<div class="bubble-head"></div><div class="content">${text}</div>`;
  chatSurface.appendChild(msg);
  scrollBottom();
}

async function greet(isPremium){
  const intro = isPremium
    ? `Premium engaged. Clean slate. I‚Äôll steer strategy, templates, and deadlines; you‚Äôll do bite-size reps. We ship one thing in ~72 hours. 
       To get moving, choose a lane, or say ‚Äúhelp me choose‚Äù and I‚Äôll pitch options. ‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other`
    : `Welcome to the Freedom Engine. I‚Äôm your personal trainer for tiny paid offers. I‚Äôll carry strategy, templates, and deadlines; you‚Äôll do bite-size reps.
       We‚Äôll ship one in ~72 hours. If you‚Äôre blank, say ‚Äúhelp me choose‚Äù and I‚Äôll keep the sarcasm warm and the steps short.`;

  postMsg(intro.replace(/\s+\n/g,' '),"bot",{opener:true});
}

function sanitizeLLM(s){
  if(!s || typeof s!=="string") return "‚Ä¶";
  // strip obvious "undefined" accidents
  return s.replace(/\bundefined\b/gi,'').replace(/\s{2,}/g,' ').trim();
}

async function askLLM(userText){
  // optimistic UI
  postMsg(userText,"user");
  try{
    const payload = {
      messages: [
        { role:"system", content: "You are The Freedom Engine ‚Äî a sharp, darkly funny mentor. Keep answers short, practical, and momentum-driven. Never be vulgar; sarcastic is fine. Push the user to produce shippable output in 5 steps: profile ‚Üí offer ‚Üí copy ‚Üí launch ‚Üí done." },
        ...(window.FEProgress?.data?.memory?.persona? [{role:"system",content:window.FEProgress.data.memory.persona}] : []),
        { role:"user", content: userText }
      ]
    };
    const r = await fetch(CHAT_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const j = await r.json().catch(()=>({output:"No response."}));
    const out = sanitizeLLM(j.output || j.text || j.message || "No response.");
    postMsg(out,"bot");

    // very light stage heuristic
    const lower = (userText+" "+out).toLowerCase();
    const prog = window.FEProgress;
    if(prog){
      prog.update(d=>{
        if(d.stage==="profile" && /design|writing|coach|coaching|dev|code|other/.test(lower)) d.stage="offer";
        else if(d.stage==="offer" && /price|proof|benefit|deliver|scope/.test(lower)) d.stage="copy";
        else if(d.stage==="copy" && /email|post|cta|sales/.test(lower)) d.stage="launch";
        else if(d.stage==="launch" && /scheduled|uploaded|published|live/.test(lower)) d.stage="done";
        // append to transcript (trim)
        d.history = (d.history||[]).concat({who:"user",text:userText},{who:"bot",text:out}).slice(-200);
      });
    }
  }catch(e){
    postMsg("The engine coughed. Try again in a few seconds.","bot");
  }
}

function promptLicense(onValid){
  const k = prompt("Enter your license key:");
  if(!k) return;
  // optional verify call
  fetch(VERIFY_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:k})})
    .then(r=>r.json()).then(j=>{
      if(j?.success || j?.ok){
        window.FEProgress.unlock(k).then(()=> onValid && onValid());
      }else{
        alert(j?.message || "Key not valid.");
      }
    }).catch(()=>alert("Verify failed. Try again."));
}

/* kebab behavior (above the button) */
function positionMenu(){
  const r = kebab.getBoundingClientRect();
  menu.style.left = (r.left) + "px";
  menu.style.top  = (r.top - menu.offsetHeight - 8) + "px";
}
kebab.addEventListener('click', ()=>{
  menu.classList.toggle('open');
  kebab.setAttribute('aria-expanded', menu.classList.contains('open') ? 'true' : 'false');
  if(menu.classList.contains('open')){
    // ensure measured height
    menu.style.display='block'; positionMenu();
  }else{
    menu.style.display='';
  }
});
window.addEventListener('resize', ()=>{ if(menu.classList.contains('open')) positionMenu(); });
document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==kebab) { menu.classList.remove('open'); menu.style.display=''; }});

/* menu items */
miReset.addEventListener('click', ()=>{
  if(confirm("Reset all local progress?")){
    window.FEProgress.update(d=>{ d.stage="profile"; d.history=[]; d.memory={}; });
    postMsg("Progress cleared. Fresh start. Want me to help you choose a lane? Say ‚Äúhelp me choose‚Äù.","bot",{opener:true});
  }
});
miSign.addEventListener('click', ()=> window.FEProgress.signOut().then(()=>greet(false)));
miWake.addEventListener('click', ()=> postMsg("Trainer is awake. Keep moving. What lane: design, writing, coaching, dev, or other?","bot"));
miSave.addEventListener('click', ()=>{
  const snap = JSON.stringify(window.FEProgress?.data||{}, null, 2);
  const url = URL.createObjectURL(new Blob([snap],{type:"application/json"}));
  const a = Object.assign(document.createElement('a'), { href:url, download:'freedom-engine-snapshot.json' });
  a.click(); URL.revokeObjectURL(url);
});
miLoad.addEventListener('click', async ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async () => {
    const file = inp.files[0]; if(!file) return;
    try{
      const text = await file.text(); const data = JSON.parse(text);
      window.FEProgress.update(d=>Object.assign(d,data||{}));
      postMsg("Snapshot loaded.","bot");
    }catch{ alert("Not a valid snapshot."); }
  };
  inp.click();
});

/* demo CTAs */
document.querySelectorAll('[data-cta-have-key],[data-menu-have-key]').forEach(n=>{
  n.addEventListener('click', ()=> promptLicense(()=>postMsg("Premium unlocked. I‚Äôll remember progress across devices.","bot",{opener:true})));
});
document.querySelectorAll('[data-cta-buy],[data-menu-buy]').forEach(n=>{
  n.addEventListener('click', ()=>{
    window.open("https://intellartsystems.gumroad.com/l/the-freedom-engine","_blank");
  });
});

/* composer */
composer.addEventListener('keydown', (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});
sendBtn.addEventListener('click', ()=>{
  const t = composer.value.trim(); if(!t) return;
  composer.value=""; askLLM(t);
});

/* Hydration ‚Üí greet once, de-dupe opener */
document.addEventListener('fe:hydrated', (ev)=>{
  greet(!!ev.detail?.isPremium);
});

/* Ensure chat always shows last message on load/resize */
window.addEventListener('load', scrollBottom);
window.addEventListener('resize', scrollBottom);
</script>
</body>
</html>
