<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Freedom Engine ‚Äî Trainer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07080b; --ink:#eaf0ff; --muted:#98a2b3; --line:#1b2235;
  --glass1:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.02);
  --neon1:#7c86ff; --neon2:#3ddc97; --neon3:#ff7cba; --neon4:#ffa93d;
  --rad:18px; --shadow:0 18px 60px rgba(0,0,0,.55);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;overflow-y:overlay;scroll-behavior:smooth}

/* Neon canvas background */
.canvas{
  position:fixed; inset:-20vmax; z-index:-1; pointer-events:none;
  filter:blur(80px) saturate(140%); opacity:.35;
  background:
    conic-gradient(from 0deg at 30% 30%, var(--neon1), transparent 40%),
    conic-gradient(from 180deg at 70% 20%, var(--neon3), transparent 45%),
    conic-gradient(from 90deg at 40% 80%, var(--neon2), transparent 50%);
  animation: drift 18s linear infinite alternate;
}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(4rem,-3rem,0) scale(1.1)}}

/* Layout */
.container{max-width:1220px;margin:0 auto;padding:22px 18px 120px;display:grid;gap:18px;grid-template-columns:300px 1fr}
@media (max-width:1040px){.container{grid-template-columns:1fr}}
.glass{background:linear-gradient(180deg,var(--glass1),var(--glass2));border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);backdrop-filter:blur(14px) saturate(140%)}
.neon{position:relative;isolation:isolate}
.neon::before{content:"";position:absolute;inset:-1px;z-index:-1;border-radius:calc(var(--rad) + 2px);
  background:
    linear-gradient(90deg,var(--neon1),transparent 30%,transparent 70%,var(--neon3)),
    linear-gradient(180deg,var(--neon2),transparent 30%,transparent 70%,var(--neon4));
  filter:blur(12px) saturate(140%);opacity:.35;pointer-events:none;
}

/* Sidebar */
.sidebar{position:sticky;top:16px;height:fit-content;padding:16px}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.logo-wrap{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;position:relative;background:rgba(0,0,0,.25);border:1px solid #2a2f45;overflow:hidden}
.logo{width:44px;height:44px;object-fit:contain;display:none}
.logo.spin{
  display:block;
  animation: logo-spin 48s linear infinite;
  filter:
    drop-shadow(0 0 14px rgba(124,134,255,.65))
    drop-shadow(0 0 24px rgba(61,220,151,.45))
    drop-shadow(0 0 28px rgba(255,124,186,.35));
}
@keyframes logo-spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.logo-fallback{
  position:absolute;inset:0;display:grid;place-items:center;
  font-family:"JetBrains Mono",monospace;font-weight:700;letter-spacing:.8px;
  background:linear-gradient(135deg,var(--neon2),var(--neon1),var(--neon3));
  -webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(124,134,255,.35)
}
.brand-title{line-height:1.05}
.title{font-weight:800;font-size:18px;letter-spacing:.2px}
.sub{color:var(--muted);font-size:12px;margin-top:2px}

/* Blocks & controls */
.block{padding:12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015))}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn,textarea{border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:10px 12px;outline:none}
.btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:.2s ease;font-weight:600}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:linear-gradient(135deg,var(--neon1),var(--neon3));border:none;box-shadow:0 10px 28px rgba(124,134,255,.35)}
.btn.ok{background:linear-gradient(135deg,var(--neon2),#42f5b0);border:none;box-shadow:0 10px 28px rgba(61,220,151,.35)}
.btn.ghost{background:#0d1222;border:1px solid #2a3553}
.pill{padding:6px 10px;border-radius:999px;background:#0d1222;border:1px solid #293357;font-size:12px;color:#cbd6ff}
.pill.demo{color:#ffd7f1;border-color:#4a2a47;background:rgba(255,124,186,.12)}
.pill.full{color:#baffea;border-color:#1f4b3c;background:rgba(61,220,151,.12)}
.tooltip{font-size:12px;color:#98a2b3}
.hide{display:none !important}

/* Progress bar */
.progress-wrap{margin-top:10px}
.progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:10px;border-radius:999px;background:#0d1222;border:1px solid #2a2f45;overflow:hidden}
.bar > div{
  height:100%;
  background:linear-gradient(90deg,var(--neon2),var(--neon1),var(--neon3),var(--neon4));
  width:0%; transition:width .4s ease;
  box-shadow:0 0 16px rgba(124,134,255,.25), 0 0 16px rgba(61,220,151,.18) inset;
}

/* Chat */
.panel{padding:12px;margin-top:0}
.chat{max-height:74vh;overflow:auto;padding:8px 6px;border:1px solid var(--line);border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01))}
.msg{display:grid;grid-template-columns:34px 1fr;gap:10px;margin:10px 0;align-items:start}
.avatar{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;border:1px solid #2c3553;background:linear-gradient(135deg,#1b2135,#121628);box-shadow:inset 0 0 8px rgba(124,134,255,.2)}
.avatar.me{border-color:#36407a;box-shadow:inset 0 0 10px rgba(124,134,255,.3)}
.avatar.ai{border-color:#245c46;box-shadow:inset 0 0 10px rgba(61,220,151,.28)}
.bubble{white-space:pre-wrap;line-height:1.55;padding:12px 14px;border-radius:14px;border:1px solid #28314e;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015));box-shadow:0 10px 28px rgba(0,0,0,.45)}
.me .bubble{border-color:#2f3969;box-shadow:0 0 24px rgba(124,134,255,.18)}
.ai .bubble{border-color:#1f5843;box-shadow:0 0 24px rgba(61,220,151,.16)}
.chat::-webkit-scrollbar{height:10px;width:10px}
.chat::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--neon1),var(--neon3));border-radius:20px}

/* Composer */
.footer{position:fixed;left:0;right:0;bottom:0;padding:12px 14px;background:linear-gradient(180deg,transparent,rgba(5,6,9,.88) 40%, rgba(5,6,9,1) 70%);border-top:1px solid var(--line)}
.composer{max-width:1220px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea{min-height:60px;resize:vertical}

/* Premium mode */
.premium .sidebar .block[data-locked]{display:none}
.premium .sub::after{content:"  ‚Ä¢  Premium"; color:#baffea}
.premium .footer{background:linear-gradient(180deg,transparent,rgba(5,6,9,.78) 40%, rgba(5,6,9,.92) 70%)}
</style>
</head>
<body>
<div class="canvas"></div>

<div class="container" id="app">
  <!-- Sidebar -->
  <aside class="glass neon sidebar">
    <div class="brand">
      <div class="logo-wrap">
        <img id="iasLogo" class="logo" src="assets/ias-logo.png" alt="Intelligently Artificial Systems">
        <div class="logo-fallback">IAS</div>
      </div>
      <div class="brand-title">
        <div class="title">Intelligently Artificial Systems</div>
        <div class="sub">The Freedom Engine ‚Äî Trainer</div>
      </div>
    </div>

    <!-- Access (buy/unlock hide in Premium) -->
    <div class="block glass" data-locked>
      <div class="row">
        <button id="unlock" class="btn ok">I have a license key</button>
      </div>
      <div class="row" style="margin-top:8px;align-items:center;justify-content:space-between">
        <div id="progressTxt" class="tooltip">Progress: 0%</div>
        <div id="accessPill" class="pill demo">Demo mode</div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label"><span>Roadmap</span><span id="stageLabel">0/5</span></div>
        <div class="bar"><div id="barFill"></div></div>
      </div>
    </div>

    <div class="block glass" data-locked>
      <p class="tooltip">Already bought? Paste your key from your receipt or <a class="inline" target="_blank" href="https://app.gumroad.com/library" style="color:#cfd6ff;text-decoration:none;border-bottom:1px dotted #7078ff">Gumroad Library</a>.</p>
      <button id="buy" class="btn primary" style="width:100%">Buy</button>
    </div>

    <!-- Reset: ALWAYS visible (also in Premium) -->
    <div class="block glass">
      <div class="row">
        <button id="reset" class="btn ghost" style="width:100%">Reset Progress</button>
      </div>
    </div>

    <!-- Export -->
    <div class="block glass">
      <button id="export" class="btn ghost" style="width:100%">Export My Plan</button>
    </div>
  </aside>

  <!-- Main -->
  <main>
    <section id="chatWrap" class="panel glass neon">
      <div id="chat" class="chat"></div>
      <div id="aiStatus" class="tooltip" style="margin-top:6px">Booting the Trainer‚Ä¶</div>
    </section>
  </main>
</div>

<!-- Composer -->
<div class="footer glass">
  <div class="composer">
    <textarea id="input" placeholder="Answer here. Press Enter to send." disabled></textarea>
    <button id="send" class="btn primary" disabled>Send</button>
  </div>
</div>

<script type="module">
/* ===== CONFIG ===== */
const CLOUD_ENDPOINT = "https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL    = "https://intellartsystems.gumroad.com/l/the-freedom-engine";
const STAGES = ["profile","offers","selection","plan","optimize"];

/* ===== Agent System ===== */
const SYSTEM_PRIME = `
Act as THE FREEDOM ENGINE ‚Äî a ruthless, darkly funny trainer whose mission is to free users by shipping a tiny paid offer in 72 hours.
Tone: Billy-Butcher-adjacent (no slurs), sharp, honest, motivational. One question at a time.
Process: Diagnose -> Propose -> Narrow -> Plan -> Optimize. Keep momentum and ask for commitment.
Use and update structured memory.
Return STRICT JSON only:
{"say":"...","stage":"profile|offers|selection|plan|optimize","next_questions":["..."],"memory_delta":{"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""},"confidence":0.0}
Keep "say" < 160 words.
`;

/* ===== State & DOM ===== */
let history   = JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked  = localStorage.getItem('fe_unlocked') === '1';
let currentStage = localStorage.getItem('fe_stage') || "profile";
let agentMemory = JSON.parse(localStorage.getItem('fe_memory')||'{"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""}');
let lastTouch = Number(localStorage.getItem('fe_last_touch')||0);

const chatEl   = document.getElementById('chat');
const inputEl  = document.getElementById('input');
const sendBtn  = document.getElementById('send');
const aiStatus = document.getElementById('aiStatus');
const progressTxt = document.getElementById('progressTxt');
const stageLabel  = document.getElementById('stageLabel');
const barFill     = document.getElementById('barFill');
const accessPill  = document.getElementById('accessPill');
const appRoot     = document.getElementById('app');

const logo = document.getElementById('iasLogo');
const logoFallback = document.querySelector('.logo-fallback');

/* ===== Logo spin only when PNG truly loads ===== */
if (logo){
  const onOk = ()=>{ logo.classList.add('spin'); logo.style.display='block'; if(logoFallback) logoFallback.style.display='none'; };
  const onFail = ()=>{ console.warn('Logo failed to load: assets/ias-logo.png'); };
  logo.addEventListener('load', onOk, {once:true});
  logo.addEventListener('error', onFail, {once:true});
  if (logo.complete && logo.naturalWidth>0) onOk();
}

/* ===== Helpers ===== */
function bubble(role,content){
  const who = role==='user' ? 'me' : 'ai';
  return `<div class="msg ${who}">
    <div class="avatar ${who}">${who==='me'?'üßë':'‚öôÔ∏è'}</div>
    <div class="bubble">${content}</div>
  </div>`;
}
function push(role,content){
  history.push({role,content});
  lastTouch = Date.now();
  localStorage.setItem('fe_history',JSON.stringify(history));
  localStorage.setItem('fe_last_touch', String(lastTouch));
  render(); updateProgressUI();
}
function render(){
  chatEl.innerHTML = history.map(m=>bubble(m.role,m.content)).join('');
  requestAnimationFrame(()=>{ chatEl.scrollTop = chatEl.scrollHeight; });
}
function stageIndex(n){ return Math.max(0, STAGES.indexOf(n)); }
function progressPercent(){ const idx=stageIndex(currentStage); return Math.round(((idx+1)/STAGES.length)*100); }
function updateProgressUI(){
  const pct = progressPercent();
  if (progressTxt) progressTxt.textContent = `Progress: ${pct}%`;
  if (stageLabel)  stageLabel.textContent  = `${Math.min(stageIndex(currentStage)+1, STAGES.length)}/${STAGES.length}`;
  if (barFill)     barFill.style.width     = `${pct}%`;
  if (accessPill){
    accessPill.textContent = unlocked ? 'Premium' : 'Demo mode';
    accessPill.className = 'pill ' + (unlocked ? 'full' : 'demo');
  }
  localStorage.setItem('fe_stage', currentStage);
}
function enablePremiumUI(){
  unlocked = true; localStorage.setItem('fe_unlocked','1');
  appRoot.classList.add('premium');
  document.querySelectorAll('[data-locked]').forEach(n=>n.remove());
  updateProgressUI();
}
if (unlocked) enablePremiumUI();

/* ===== Cloud bridge ===== */
async function callCloud(messages){
  const r = await fetch(`${CLOUD_ENDPOINT}/chat`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ messages })
  });
  const j = await r.json();
  return j.output || "No response.";
}

/* ===== Agent runtime ===== */
async function agentAsk(userTextOrNull){
  const context = [
    { role:"system", content: SYSTEM_PRIME },
    { role:"system", content: `MEMORY:${JSON.stringify(agentMemory)}` },
    { role:"system", content: `CURRENT_STAGE:${currentStage}` },
    ...history.slice(-10),
  ];
  if (userTextOrNull !== null) context.push({ role:"user", content: userTextOrNull });

  let out = await callCloud(context);
  let parsed = safeParse(out);

  if (!parsed || (parsed.confidence ?? 0) < 0.6){
    const nudge = [
      { role:"system", content: SYSTEM_PRIME },
      { role:"system", content: `MEMORY:${JSON.stringify(agentMemory)}` },
      { role:"system", content: `CURRENT_STAGE:${currentStage}` },
      ...history.slice(-10),
      { role:"user", content: "Return STRICT JSON only. Clarify and keep 'say' < 140 words." }
    ];
    out = await callCloud(nudge);
    parsed = safeParse(out) || { say: strip(out), stage: currentStage, next_questions: [], memory_delta:{}, confidence:.7 };
  }

  if (parsed.memory_delta && typeof parsed.memory_delta==='object'){
    agentMemory = {...agentMemory, ...cleanDelta(parsed.memory_delta)};
    localStorage.setItem('fe_memory', JSON.stringify(agentMemory));
  }
  if (parsed.stage && STAGES.includes(parsed.stage)) currentStage = parsed.stage;

  return parsed.say;
}
function safeParse(s){
  try{
    const cleaned = s.trim().replace(/^```(?:json)?/i,'').replace(/```$/,'');
    const obj = JSON.parse(cleaned);
    if (obj && typeof obj.say === 'string') return obj;
    return null;
  }catch{return null;}
}
function cleanDelta(o){
  const allow = ["skills","audience","offer","price","style","blocked_by"];
  const r={}; for(const k of allow){ if(typeof o[k]==='string' && o[k].length) r[k]=o[k]; } return r;
}
const strip = t => (t||"").replace(/```/g,'').replace(/\[\[stage:[^\]]+\]\]/gi,'').trim();

/* ===== Boot with smart auto-continue ===== */
async function boot(){
  aiStatus.textContent = "Booting the Trainer‚Ä¶";
  inputEl.disabled=false; sendBtn.disabled=false;

  const last = history[history.length-1];
  const sessionResumed = sessionStorage.getItem('fe_resumed_this_session') === '1';
  const stale = Date.now() - (lastTouch||0) > 90*1000; // >90s

  if (history.length === 0){
    const opener = await agentAsk("Start diagnosis. Ask ONE pointed question to find their best marketable skill. Return JSON.");
    push('assistant', opener);
  } else if (!sessionResumed && (stale || (last && last.role==='user'))){
    const next = await agentAsk("Continue the coaching from the last turn with the single best next question. Return JSON.");
    push('assistant', next);
    sessionStorage.setItem('fe_resumed_this_session','1');
  }

  aiStatus.textContent = "Ready.";
}
render(); updateProgressUI(); boot();

/* ===== Conversation ===== */
async function generate(userText){
  push('user', userText);
  aiStatus.textContent = "Thinking‚Ä¶";
  const reply = await agentAsk(null);
  push('assistant', reply);
  aiStatus.textContent = "Ready.";
}
sendBtn.onclick=()=>{ const t=inputEl.value.trim(); if(!t) return; inputEl.value=""; generate(t); };
inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

/* ===== Export ===== */
async function exportReport(){
  const brief = `
User profile & memory: ${JSON.stringify(agentMemory)}
Create a crisp execution brief:
- Summary of user and chosen direction
- Final Micro-Offer (name, audience, promise, price)
- Sales copy (headline + 3‚Äì5 bullets + Gumroad blurb)
- 72-hour launch plan (Day1‚Äì3 with $5/day ad hooks)
- Next 3 tiny actions
Tone: sharp, witty, no fluff. <700 words. No code blocks.
`;
  let report = await callCloud([
    { role:"system", content:"You are compiling a brief from a coaching transcript. Be concise and practical." },
    ...history.slice(-16),
    { role:"user", content: brief }
  ]).catch(()=> "Export hiccup‚Äîtranscript is below. Use it manually.");

  const transcript = history.map(h=>`<h4>[${h.role.toUpperCase()}]</h4><pre>${escapeHtml(h.content)}</pre>`).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}
.h{font-size:28px;font-weight:800;margin:0 0 4px}
.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}
hr{border:none;border-top:1px dashed #263047;margin:16px 0}
</style></head><body><div class="wrap">
<div class="h">The Freedom Engine ‚Äî Export</div>
<div class="sub">Generated ${new Date().toLocaleString()}</div>
<div class="card"><h3>Execution Brief</h3><pre>${escapeHtml(report)}</pre></div>
<hr><div class="card"><h3>Appendix ‚Äî Transcript</h3>${transcript}</div>
</div></body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='freedom-engine-export.html'; a.click();
}
function escapeHtml(s){return (s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;","\">":"&quot;"}[c]))}

/* ===== Unlock / Buy / Reset ===== */
const buyBtn = document.getElementById('buy'); if(buyBtn) buyBtn.onclick=()=>window.open(GUMROAD_URL,'_blank');
document.getElementById('unlock').onclick = async ()=>{
  const key = prompt("Paste your license key:"); if(!key) return;
  const r = await fetch(`${CLOUD_ENDPOINT}/verify`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ license_key: key.trim() })
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if(r.ok){ enablePremiumUI(); alert("Premium unlocked."); push('assistant',"Premium interface engaged. What‚Äôs blocking you right now? One line."); }
  else alert("That key didn‚Äôt verify. Check your receipt or Gumroad Library.");
};

document.getElementById('reset').onclick = ()=>{
  if(confirm("Reset all progress?")){
    history=[]; agentMemory={"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""};
    localStorage.removeItem('fe_history');
    localStorage.removeItem('fe_stage');
    localStorage.removeItem('fe_memory');
    localStorage.removeItem('fe_last_touch');
    sessionStorage.removeItem('fe_resumed_this_session');
    render(); updateProgressUI();
    push('assistant',"Fresh slate. What do people actually thank you for helping with?");
  }
};

/* ===== Tiny util ===== */
function escapeHtml(s){return (s||"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}
</script>
</body>
</html>
