<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Freedom Engine ‚Äî index.html (I17, visuals locked, Edge Brain v2.1)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#f7f8ff;
  --ink-dim:#cfd4ff;
  --ring:rgba(255,255,255,.22);
  --glass1:rgba(255,255,255,.035);
  --glass2:rgba(255,255,255,.01);
  --shadow:0 18px 48px rgba(0,0,0,.55);
  --radius:24px;
}

*{box-sizing:border-box}
html,body{height:100dvh;margin:0}
body{ color:var(--ink); font-family:"Orbitron",system-ui,-apple-system,Segoe UI,Roboto,sans-serif; overflow:hidden; background:#0f0a1c; }

/* ===== I1 BACKGROUND (wider gamut + 2x speed) ===== */
#fe-bg{
  position:fixed; inset:0; z-index:0;
  background:
    radial-gradient(1200px 820px at 12% 18%, rgba(248, 64, 220, .34), transparent 62%),
    radial-gradient(1200px 820px at 86% 22%, rgba(255, 196, 61,  .30), transparent 65%),
    radial-gradient(1200px 900px at 24% 86%, rgba( 62, 205, 255, .28), transparent 65%),
    radial-gradient(1400px 900px at 80% 90%, rgba( 75, 255, 180, .22), transparent 68%),
    linear-gradient(180deg,#1b1032 0%,#2a184a 50%,#25143f 100%);
  animation: hueCycle 45s linear infinite;
  will-change: filter;
}
@keyframes hueCycle{ from{ filter:hue-rotate(0deg) } to{ filter:hue-rotate(360deg) } }

/* ===== Sacred Geometry (LOCKED) ===== */
#fe-geo{ position:fixed; inset:0; z-index:1; pointer-events:none; opacity:.85; overflow:visible }
#fe-geo svg{width:100%;height:100%;display:block; overflow:visible}

/* ===== App Frame ===== */
#fe{
  position:relative; z-index:3; height:100%;
  padding:14px; display:grid; grid-template-rows:auto auto auto 1fr; gap:12px;
  min-height:0;
  padding-bottom:106px; /* space for fixed composer */
}
.card{
  border-radius:var(--radius);
  padding:14px;
  border:1px solid var(--ring);
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  -webkit-backdrop-filter: blur(2px) saturate(60%);
  backdrop-filter: blur(2px) saturate(60%);
  box-shadow:var(--shadow);
}
.title{margin:0 0 6px;line-height:1.02;letter-spacing:.4px;font-size:24px;font-weight:900;text-shadow:0 2px 12px rgba(0,0,0,.55)}
.sub{margin:0;color:var(--ink-dim);font-size:13px;font-weight:700;opacity:.95;text-shadow:0 2px 10px rgba(0,0,0,.5)}

/* Progress */
.meter{border-radius:20px; padding:10px; border:1px solid var(--ring); background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02))}
.bar{height:10px;border:1px solid var(--ring);border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));position:relative;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#ff7bf1,#ffd86a);width:0%}
.nub{position:absolute;top:50%;transform:translateY(-50%);width:12px;height:12px;border-radius:50%;right:4px;background:#fff;box-shadow:0 0 10px rgba(255,255,255,.6)}
.progtext{color:var(--ink-dim);font-size:12px;margin-top:6px; font-family:"Orbitron",system-ui !important; font-feature-settings:"zero" 0}

/* Chat */
#fe-chat{ overflow:auto; min-height:0; }
#chatlog{padding:12px 12px 16px 12px; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.msg{margin:0 0 10px; max-width:96%; display:flex; align-items:flex-start; gap:8px}
.msg .i{width:22px; height:22px; flex:0 0 22px; display:flex; align-items:center; justify-content:center}
.msg .i .emo{font-size:20px; line-height:1; filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}
.msg .b{flex:1}
.ai .b{background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.04));border:1px solid var(--ring);padding:12px;border-radius:18px; box-shadow:0 12px 28px rgba(0,0,0,.45);}
.you .b{margin-left:auto;background:linear-gradient(90deg,#ff7bf1,#ffd86a);color:#111;border:0;padding:10px 12px;border-radius:18px}

/* Composer */
.composer{position:fixed;left:0;right:0;bottom:0;height:90px;padding:10px 14px;z-index:6;
  background:linear-gradient(180deg, rgba(16,10,28,.78), rgba(16,10,28,.95));
  border-top:1px solid var(--ring); backdrop-filter: blur(12px);
  display:grid; grid-template-columns:1fr auto; gap:8px}
.composer input[type=text]{width:100%;padding:12px;border-radius:16px;border:1px solid var(--ring);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--ink);
  font:16px/1.1 "Orbitron", system-ui;}
.composer button.primary{padding:12px 18px;border-radius:16px;border:1px solid var(--ring);
  color:#111;background:linear-gradient(90deg,#ff7bf1,#ffd86a);font-weight:900;letter-spacing:.3px;box-shadow:0 10px 28px rgba(0,0,0,.45)}
</style>
</head>
<body>

<!-- Moving hue background -->
<div id="fe-bg"></div>

<!-- Sacred Geometry (LOCKED) -->
<div id="fe-geo" aria-hidden="true">
  <svg viewBox="0 0 100 100" preserveAspectRatio="none">
    <defs>
      <linearGradient id="neon" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#ff7bf1"/>
        <stop offset="50%" stop-color="#ffd86a"/>
        <stop offset="100%" stop-color="#79ffd9"/>
      </linearGradient>
      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="0.35" result="b"/>
        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <pattern id="fol" width="8" height="8" patternUnits="userSpaceOnUse">
        <circle cx="4" cy="4" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="0" cy="4" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="8" cy="4" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="4" cy="0" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="4" cy="8" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="0" cy="0" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="8" cy="0" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="0" cy="8" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
        <circle cx="8" cy="8" r="4" fill="none" stroke="url(#neon)" stroke-width=".2" filter="url(#glow)" />
      </pattern>
      <symbol id="tile" viewBox="0 0 100 100" preserveAspectRatio="none">
        <rect x="0" y="0" width="100" height="100" fill="url(#fol)"/>
      </symbol>
    </defs>
    <!-- OVERSCAN 140% -->
    <g opacity=".34">
      <use href="#tile" x="-20" y="-20" width="140" height="140">
        <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 50 50" to="360 50 50" dur="160s" repeatCount="indefinite"/>
        <animateTransform additive="sum" attributeName="transform" attributeType="XML" type="scale" values="1;1.02;1" dur="30s" repeatCount="indefinite"/>
      </use>
    </g>
    <g opacity=".22">
      <use href="#tile" x="-20" y="-20" width="140" height="140">
        <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="360 50 50" to="0 50 50" dur="110s" repeatCount="indefinite"/>
        <animateTransform additive="sum" attributeName="transform" attributeType="XML" type="scale" values="1;1.018;1" dur="26s" repeatCount="indefinite"/>
      </use>
    </g>
  </svg>
</div>

<!-- App frame -->
<div id="fe">
  <div id="fe-header" class="card">
    <h1 class="title">Module 1 ‚Äî Foundations</h1>
    <p class="sub">Build a micro-offer from zero to sellable ‚Äî with a coach who actually gives a damn.</p>
  </div>

  <div id="fe-meter" class="meter card">
    <div class="bar"><div class="fill" id="fe-progress"></div><div class="nub" id="fe-nub" style="display:none"></div></div>
    <div class="progtext" id="fe-progress-text">Progress: 0%</div>
  </div>

  <div id="fe-cta" class="card" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800">Unlock the Full Engine</div>
        <div class="sub" style="font-size:12px">Finish Modules 3‚Äì5 and ship your offer.</div>
      </div>
      <a class="ai cta-button" href="https://intellartsystems.gumroad.com/l/the-freedom-engine" target="_blank" rel="noopener">Unlock ‚Üí</a>
    </div>
  </div>

  <div id="fe-chat" class="card"><div id="chatlog"></div></div>
</div>

<div class="composer" id="fe-composer">
  <input id="composer" type="text" placeholder="Type your answer‚Ä¶ then press Enter  (type RESET to clear)" autocomplete="off" />
  <button class="primary" id="send">Send</button>
</div>

<!-- transformers.js (loads when needed) -->
<script defer src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0"></script>

<script>
/* ==================== Freedom Engine Runtime (Edge Brain v2.1) ==================== */
(function(){
  const STORAGE_KEY = "fe_state";
  const STATE_VERSION = 15;
  const $ = s=>document.querySelector(s);

  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||""); }catch(e){ return null; } }
  function save(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }
  function clear(){ localStorage.removeItem(STORAGE_KEY); location.reload(); }

  if(location.hash.includes("fresh")){ localStorage.removeItem(STORAGE_KEY); history.replaceState(null, "", location.pathname); }

  const prev = load();
  const def = { v:STATE_VERSION, stage:1, stepIndex:0, transcript:[], data:{}, licenseUnlocked:false };
  const state = (!prev || prev.v !== STATE_VERSION) ? def : prev;

  const chat=$("#chatlog");
  const scroller=$("#fe-chat");
  const input=$("#composer");
  const btn=$("#send");
  const progress=$("#fe-progress");
  const progressText=$("#fe-progress-text");
  const nub=$("#fe-nub");
  const cta=$("#fe-cta");
  const headerTitle = document.querySelector("#fe-header .title");

  const ICON_AI = '<div class="emo" aria-hidden="true">‚öôÔ∏è</div>';
  const ICON_YOU = '<div class="emo" aria-hidden="true">üí¨</div>';

  function scrollToBottom(){ scroller.scrollTo({ top: scroller.scrollHeight, behavior: "smooth" }); }

  function node(role, text){
    const wrap = document.createElement("div");
    wrap.className = "msg " + (role==="you"?"you":"ai");
    const icon = document.createElement("div"); icon.className = "i"; icon.innerHTML = role==="you" ? ICON_YOU : ICON_AI;
    const bubble = document.createElement("div"); bubble.className = "b"; bubble.textContent = String(text||"");
    wrap.appendChild(icon); wrap.appendChild(bubble);
    return wrap;
  }
  function say(text, role="ai"){ const el=node(role, text); chat.appendChild(el); scrollToBottom();
    state.transcript.push({ role: role==="you"?"user":"ai", text: String(text||"") }); save(state); }
  function renderTranscript(){ chat.innerHTML=""; (state.transcript||[]).forEach(m=> chat.appendChild(node(m.role==="user"?"you":"ai", m.text))); scrollToBottom(); }
  function you(text){ say(text, "you"); }

  /* ===== Progress UI ===== */
  function setProgress(){
    const pct = Math.min((state.stage-1)*20, 100);
    progress.style.width = pct + "%";
    progressText.textContent = "Progress: " + pct + "%";
    nub.style.display = pct>0 ? "block" : "none";
    nub.style.left = "calc(" + pct + "% - 6px)";
    cta.style.display = (state.stage >=3 ? "block" : "none");
    const titles = { 1:"Module 1 ‚Äî Foundations", 2:"Module 2 ‚Äî Framing", 3:"Module 3 ‚Äî Design (Locked)", 4:"Module 4 ‚Äî Delivery (Locked)", 5:"Module 5 ‚Äî Launch (Locked)" };
    headerTitle.textContent = titles[state.stage] || "The Freedom Engine";
  }

  /* ==================== Edge Brain v2.1 ==================== */
  let embedder = null, loadingEmbedder = false;
  async function ensureEmbedder(){
    if(embedder) return embedder;
    if(loadingEmbedder) { while(!embedder) { await new Promise(r=>setTimeout(r,50)); } return embedder; }
    loadingEmbedder = true;
    try{
      const { pipeline } = window.transformers || {};
      if(!pipeline){ loadingEmbedder=false; return null; }
      embedder = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
      return embedder;
    }catch(e){ console.warn("Embedder load failed", e); loadingEmbedder=false; return null; }
  }

  // Math helpers
  function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s += a[i]*b[i]; return s; }
  function norm(a){ return Math.sqrt(dot(a,a))||1; }
  function cos(a,b){ return dot(a,b)/(norm(a)*norm(b)); }

  // Example bank (expanded/confusion/guidance). Each: { in, out, slot? }
  const BANK = [
    {in:"help", out:"Got you. We‚Äôll keep it simple. First: what skill or asset are you using here‚Äîediting, writing, design, outreach, automation?", slot:"seed"},
    {in:"confused huh wtf", out:"You're fine. Pick one tiny win you can deliver in a day. A) 10 hooks B) mini audit C) template setup. Reply A/B/C.", slot:null},
    {in:"leads quick niche choose lane", out:"Solid. What niche do you want those leads from? Pick a lane so we can make it punchy.", slot:"audience"},
    {in:"design logos quick", out:"Nice. Who exactly? Freelancers, Etsy sellers, local shops? Pick one.", slot:"audience"},
    {in:"busy moms reels 49", out:"Draft: For busy moms, I‚Äôll batch 10 reels for $49 so they post without stress. Want this as the starter offer?", slot:"price"},
    {in:"coaches", out:"Coaches‚Äîgreat. What single outcome will you give them in 48‚Äì72 hours? Keep it tight.", slot:"audience"},
    {in:"landing page in a day", out:"Crisp. Promise locked: one-page site in 24 hours. What‚Äôs the simple price to test first?", slot:"promise"},
    {in:"price 29 49 99", out:"Starter price: pick $29, $49, or $99. We'll test and adjust.", slot:"price"},
    {in:"outcome more sales vague", out:"Too broad. Pick a measurable win: X leads, Y signups, or Z booked calls. Which?", slot:"outcome"},
    {in:"logo for tattoo artists", out:"Niche picked: tattoo artists. What‚Äôs the quick promise? (e.g., 1-day logo, 3 concepts)", slot:"audience"},
    {in:"checklist", out:"Checklists are great. Who‚Äôs it for, and what problem does it fix immediately?", slot:"seed"},
    {in:"course creators", out:"Course creators‚Äînice. Smallest promise you can deliver this week?", slot:"audience"},
    {in:"templates for realtors", out:"Templates for realtors‚Äîgood lane. Price test: $29, $49, or $99?", slot:"audience"},
    {in:"sales page audit", out:"Audit is sharp. Outcome target: A) 5 key fixes B) score + roadmap C) rewrite top 3 sections?", slot:"promise"},
    {in:"grow instagram big", out:"Too big. Bite-size promise: A) 10 hooks B) 10 reels batch C) 14‚Äëday calendar. Reply A/B/C.", slot:"outcome"},
    {in:"unsure stuck idk", out:"Pick a person you can help this week. That‚Äôs your audience. Say it in 3 words.", slot:"audience"},
    {in:"how much should I charge", out:"Starter price: pick $29, $49, or $99. We‚Äôll test fast.", slot:"price"},
    {in:"freelancers niche chosen", out:"Freelancers‚Äîlocked. Choose the smallest promise you can deliver in 48 hours.", slot:"audience"}
  ];

  // Regex & heuristics
  const RX_PRICE = /(?:\$)?(\d+)(?:\s*usd)?/i;
  const RX_AUDIENCE = /(coaches|creators?|freelancers?|realtors?|moms?|tattoo\s*artists?|smbs?|local\s*shops?|students?|designers?)/i;
  const RX_CHOICE = /\b([abc])\b/i;
  const RX_HELPY = /\b(help|huh|confused|wtf|lost|idk|unsure|not sure)\b/i;
  const RX_LEADS = /\bleads?\b/i;

  function extractSlots(text){
    const out = {};
    const price = text.match(RX_PRICE); if(price){ out.price = price[1]; }
    const aud = text.match(RX_AUDIENCE); if(aud){ out.audience = aud[1]; }
    if(RX_LEADS.test(text)) out.outcome = out.outcome || "qualified leads";
    if(/logo|audit|template|checklist|landing\s*page|sales\s*page|reels?|hooks?|calendar/i.test(text)) out.seed = out.seed || "your skill";
    if(/landing\s*page|audit|logo|reels?|hooks?|calendar|templates?/i.test(text)) out.promise = out.promise || "fast deliverable";
    return out;
  }
  function fillSlots(obj){ for(const k of ["seed","outcome","audience","promise","price"]){ if(obj[k]) state.data[k] = obj[k]; } save(state); }

  // Top‚Äëk retrieval with confidence
  async function suggestReply(userText){
    const txt = userText.trim();
    // quick exits
    if(/^next|continue$/i.test(txt)) return { out:"Moving on. Got anything else to add? If not, I‚Äôll prompt.", slot:null, score:1 };
    if(RX_HELPY.test(txt)) return { out:"You're good. Pick one tiny win you can deliver in a day. A) 10 hooks B) mini audit C) template setup. Reply A/B/C.", slot:null, score:.9 };

    const e = await ensureEmbedder();
    let vecU = null;
    if(e){
      vecU = (await e(txt, { pooling: 'mean', normalize: true })).data;
    }
    // compute top-k
    let scored = [];
    for(const item of BANK){
      let score = 0;
      if(e){
        if(!item._vec){ item._vec = (await e(item.in, { pooling: 'mean', normalize: true })).data; }
        score = cos(vecU, item._vec);
      }else{
        const overlap = item.in.split(/\W+/).filter(w => w && txt.toLowerCase().includes(w.toLowerCase())).length;
        score = overlap / Math.max(1, item.in.split(/\W+/).length);
      }
      scored.push({ ...item, score });
    }
    scored.sort((a,b)=>b.score-a.score);
    const top = scored.slice(0,3);
    const best = top[0];

    // confidence thresholds
    const HIGH = .52, MID = .36;
    if(best && best.score >= HIGH){
      return best;
    }
    if(best && best.score >= MID){
      // blend: offer the best suggestion + a follow-up question
      return { out: best.out, slot: best.slot, score: best.score };
    }
    // Low confidence ‚Üí universal clarifier + examples
    return { out:"Give me one plain sentence about what you‚Äôll deliver fast and for who. If stuck: A) 10 hooks B) mini audit C) template setup. Reply A/B/C.", slot:null, score:0 };
  }

  function nextQuestion(){
    if(!state.data.seed) return "What skill or asset are you using for this offer? Keep it concrete.";
    if(!state.data.outcome) return "What‚Äôs the small, visible outcome they‚Äôll get in 48‚Äì72 hours?";
    if(!state.data.audience) return "Who exactly is this for? Pick a lane so it lands.";
    if(!state.data.promise) return "Smallest promise you can deliver quickly? (e.g., 10 hooks / 1-day audit / 1-page site)";
    if(!state.data.price) return "Starter price to test: $29, $49, or $99?";
    return "Type NEXT when you‚Äôre ready for Module 2 or refine any detail.";
  }
  function reflect(prevOut){ return prevOut.length>160 ? prevOut.slice(0,150)+'‚Ä¶' : prevOut; }

  function draftOffer(){
    const a = state.data.audience||"your audience";
    const p = state.data.promise||state.data.outcome||"a clear win";
    const pr = state.data.price ? ("$"+String(state.data.price).replace(/[^0-9.]/g,'')) : "$‚Äì";
    const seed = state.data.seed||"your skill";
    return `Draft micro-offer ‚Üí For ${a}, I‚Äôll deliver ${p} using ${seed}. Starter price: ${pr}.`;
  }

  async function brainTurn(userText){
    fillSlots(extractSlots(userText));

    const ch = userText.match(RX_CHOICE);
    if(ch){
      const c = ch[1].toLowerCase();
      if(!state.data.outcome && /[abc]/.test(c)){
        const map = { a:"15 leads", b:"20 email subs", c:"3 booked calls" };
        state.data.outcome = map[c]; save(state);
        say(`Outcome locked: ${map[c]}.`, "ai");
        say(nextQuestion(), "ai");
        return;
      }
    }

    const s = await suggestReply(userText);
    if(s.slot && !state.data[s.slot]){
      say(reflect(s.out), "ai");
    } else {
      // If slot already filled or no slot, still speak but avoid repetition
      say(reflect(s.out), "ai");
    }

    const filled = ["seed","outcome","audience","promise","price"].filter(k => !!state.data[k]).length;
    if(filled >= 3){
      say(draftOffer(), "ai");
      if(filled < 5) say(nextQuestion(), "ai");
      else say("Type NEXT when you‚Äôre ready for Module 2.", "ai");
    }
  }

  function runIntro(){
    setProgress();
    chat.innerHTML = "";
    state.transcript = [];
    save(state);
    say("Welcome in. I'm your Freedom Trainer ‚Äî laid-back, direct, and here to help you build your first micro-offer.", "ai");
    say(nextQuestion(), "ai");
  }

  if(state.transcript && state.transcript.length>0 && state.stage<=2){
    renderTranscript();
  } else {
    runIntro();
  }

  // Long-press reset on header
  let pressTimer;
  const header = document.querySelector("#fe-header");
  const start = ()=>{ pressTimer=setTimeout(clear, 2000); };
  const cancel = ()=>{ clearTimeout(pressTimer); };
  ["mousedown","touchstart"].forEach(ev=> header.addEventListener(ev, start));
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(ev=> header.addEventListener(ev, cancel));

  // Input handling
  let sendLock=false;
  function handleUserInput(val){
    if(sendLock) return;
    sendLock=true; setTimeout(()=>sendLock=false, 400);
    const raw=(val||"").trim(); if(!raw) return;
    if(raw.toUpperCase()==="RESET"){ clear(); return; }
    you(raw);

    if(/^next|continue$/i.test(raw)){
      if(state.stage >= 3 && !state.licenseUnlocked){ say("Locked. Use Unlock above, then type NEXT.", "ai"); return; }
      state.stage = Math.min(state.stage+1, 5); state.stepIndex = 0; save(state); setProgress();
      say("Module switched. Keep going.", "ai");
      return;
    }
    brainTurn(raw);
  }

  btn.addEventListener("click", ()=>{ const v=input.value; input.value=""; input.focus(); handleUserInput(v); });
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ const v=e.target.value; e.target.value=""; handleUserInput(v); } });
})();
</script>
</body>
</html>
