<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>The Freedom Engine ‚Äî Personal AI Trainer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
/* ===== THEME ===== */
@font-face{
  font-family:"Techfont Italica";
  src:url("assets/Techfont-Italica.ttf") format("truetype"),
      url("Techfont-Italica.ttf") format("truetype");
  font-weight:800;font-style:normal;font-display:swap;
}
:root{
  --bg:#07080b;--ink:#eaf0ff;--muted:#aab2c2;--line:#1b2235;
  --glass1:rgba(255,255,255,.06);--glass2:rgba(255,255,255,.02);
  --neon1:#7c86ff;--neon2:#3ddc97;--neon3:#ff7cba;--neon4:#ffa93d;
  --rad:18px;--shadow:0 18px 60px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;overflow-y:overlay}

/* Ambient bloom */
.canvas{position:fixed;inset:-20vmax;z-index:-1;filter:blur(80px) saturate(140%);opacity:.35;pointer-events:none;
  background:
   conic-gradient(from 0deg at 30% 30%, var(--neon1), transparent 40%),
   conic-gradient(from 180deg at 70% 20%, var(--neon3), transparent 45%),
   conic-gradient(from 90deg at 40% 80%, var(--neon2), transparent 50%);
  animation:drift 18s linear infinite alternate}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(4rem,-3rem,0) scale(1.1)}}

/* Layout */
.container{
  max-width:1320px;margin:0 auto;padding:18px 14px 130px;
  display:grid;gap:18px;grid-template-columns:420px 1fr;
}
@media(max-width:1100px){.container{grid-template-columns:1fr}}
@media(max-width:720px){.container{grid-template-columns:1fr;gap:12px;padding:12px 10px calc(env(safe-area-inset-bottom) + 120px)}}

/* Glass + neon */
.glass{background:linear-gradient(180deg,var(--glass1),var(--glass2));
  border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);
  backdrop-filter:blur(14px) saturate(140%)}
.neon{position:relative;isolation:isolate}
.neon::before{content:"";position:absolute;inset:-1px;z-index:-1;border-radius:calc(var(--rad)+2px);
  background:
   linear-gradient(90deg,var(--neon1),transparent 30%,transparent 70%,var(--neon3)),
   linear-gradient(180deg,var(--neon2),transparent 30%,transparent 70%,var(--neon4));
  filter:blur(12px) saturate(140%);opacity:.35}

/* Sidebar */
.sidebar{position:sticky;top:16px;height:fit-content;padding:14px;z-index:1001}
@media(max-width:1100px){.sidebar{position:relative;top:auto}}

.brand{display:grid;grid-template-columns:210px 1fr;gap:14px;margin-bottom:10px;align-items:center}
@media(max-width:720px){.brand{grid-template-columns:120px 1fr;gap:10px}}

.logo-wrap{
  width:210px;height:210px;border-radius:22px;display:block;position:relative;
  background:rgba(0,0,0,.25);border:1px solid #2a2f45;overflow:hidden
}
@media(max-width:720px){.logo-wrap{width:120px;height:120px;border-radius:16px}}

.logo{position:absolute;left:50%;top:50%;width:300%;height:300%;
  transform:translate(-50%,-50%);object-fit:contain;display:none}
.logo.spin{
  display:block;animation:logo-spin 48s linear infinite;
  filter:drop-shadow(0 0 14px rgba(124,134,255,.65)) drop-shadow(0 0 24px rgba(61,220,151,.45)) drop-shadow(0 0 28px rgba(255,124,186,.35))
}
@keyframes logo-spin{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}

.logo-fallback{position:absolute;inset:0;display:grid;place-items:center;
  font-family:"JetBrains Mono",monospace;font-size:38px;font-weight:700;letter-spacing:1.2px;
  background:linear-gradient(135deg,var(--neon2),var(--neon1),var(--neon3));-webkit-background-clip:text;background-clip:text;color:transparent}
@media(max-width:720px){.logo-fallback{font-size:24px}}

.brand-title{min-width:0}
.title{font-family:"Techfont Italica",Inter,system-ui;font-weight:800;
  font-size:clamp(22px,3.4vw,34px);line-height:1.04;letter-spacing:1.1px;word-spacing:1.6px;word-break:break-word}
.meta-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{padding:6px 10px;border-radius:999px;background:#0d1222;border:1px solid #293357;font-size:12px}
.pill.demo{color:#ffd7f1;border-color:#4a2a47;background:rgba(255,124,186,.12)}
.pill.full{color:#baffea;border-color:#1f4b3c;background:rgba(61,220,151,.12)}
.sub{color:var(--muted);font-size:14px;margin-top:4px}
@media(max-width:720px){.sub{font-size:12px}}

.block{padding:12px;border-radius:14px;border:1px solid var(--line);
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015))}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:9px 12px;font-weight:600;cursor:pointer}
.btn.small{padding:6px 10px;font-size:12px}
.btn.primary{background:linear-gradient(135deg,var(--neon1),var(--neon3));border:none;box-shadow:0 10px 28px rgba(124,134,255,.35)}
.btn.ok{background:linear-gradient(135deg,var(--neon2),#42f5b0);border:none;box-shadow:0 10px 28px rgba(61,220,151,.35)}
.btn.ghost{background:#0d1222;border:1px solid #2a3553}
.progress-wrap{margin-top:8px}
.progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:12px;border-radius:999px;background:#0d1222;border:1px solid #2a2f45;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(90deg,var(--neon2),var(--neon1),var(--neon3),var(--neon4));width:0%;transition:width .35s ease}

.cta{margin-top:12px;display:none}
.cta .cta-btn{display:block;width:100%;text-align:center;padding:14px 16px;border-radius:14px;border:1px solid #2a3553;background:linear-gradient(135deg,var(--neon1),var(--neon3));font-weight:800}
.cta .cta-sub{margin-top:6px;font-size:12px;color:#cbd2e6;text-align:center}

/* Menu */
.menu{position:relative;z-index:1002}
.menu .panel{position:absolute;left:0;top:100%;transform:translateY(8px);width:260px;background:#0b1224;border:1px solid #2a3553;border-radius:12px;display:none;padding:8px;z-index:1003;box-shadow:0 18px 50px rgba(0,0,0,.5)}
.menu.open .panel{display:block}
.menu .panel .btn{display:block;width:100%;text-align:left;margin:4px 0}

/* Main / Chat */
.panel{padding:12px}
.chat{
  /* JS will set exact height to meet composer */
  overflow:auto;padding:8px 6px;border:1px solid var(--line);border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
  position:relative;z-index:1;scroll-behavior:smooth
}

.msg{display:grid;grid-template-columns:34px 1fr;gap:10px;margin:10px 0;align-items:start}
.avatar{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;border:1px solid #2c3553;background:linear-gradient(135deg,#1b2135,#121628)}
.avatar.me{border-color:#36407a}
.avatar.ai{border-color:#245c46}
.bubble{white-space:pre-wrap;line-height:1.55;padding:12px 14px;border-radius:14px;border:1px solid #28314e;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015))}

/* Footer Composer */
.footer{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:linear-gradient(180deg,transparent,rgba(5,6,9,.9) 50%, rgba(5,6,9,1) 80%);border-top:1px solid var(--line)}
.composer{max-width:1320px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
textarea{min-height:98px;resize:vertical;border-radius:12px;border:1px solid #263048;background:#0f1424;color:var(--ink);padding:10px}

/* Error banner */
#error{position:fixed;top:0;left:0;right:0;background:#3b0f14;border-bottom:1px solid #74222c;color:#ffd7dc;padding:10px 14px;font-size:13px;z-index:2000;display:none}

/* Modules Modal */
.modal{position:fixed;inset:0;background:rgba(3,5,10,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:2005}
.modal.open{display:flex}
.modal .sheet{width:min(880px,90vw);max-height:80vh;overflow:auto;border:1px solid #2a3553;border-radius:16px;background:#0b1224;padding:16px;box-shadow:0 22px 60px rgba(0,0,0,.6)}
.sheet h3{margin:0 0 10px}
.modules-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:720px){.modules-grid{grid-template-columns:1fr}}
.module{border:1px solid #293357;border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.badge{border:1px solid #2a3553;border-radius:999px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>
<div class="canvas"></div>
<div id="error"></div>

<div class="container" id="app">
  <aside class="glass neon sidebar">
    <div class="brand">
      <div class="logo-wrap">
        <img id="iasLogo" class="logo" alt="IAS">
        <div class="logo-fallback">IAS</div>
      </div>
      <div class="brand-title">
        <div class="title">The Freedom Engine</div>
        <div class="meta-line">
          <span class="sub">Personal AI Trainer</span>
          <span id="modeTag" class="pill demo">Demo</span>
        </div>
        <div class="sub" id="stageText" style="margin-top:6px">Roadmap: <strong>1/5</strong></div>
      </div>
    </div>

    <div class="block">
      <div class="progress-wrap">
        <div class="progress-label"><span>Roadmap</span><span id="stageLabel">1/5</span></div>
        <div class="bar"><div id="barFill"></div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="export" class="btn ghost small">Export</button>
        <button id="modulesBtn" class="btn ghost small">Modules</button>
        <div class="menu" id="menu">
          <button id="menuBtn" class="btn ghost small">‚ãØ</button>
          <div class="panel" id="menuPanel">
            <button id="saveSnap" class="btn ghost small">Save Snapshot</button>
            <button id="loadBtn" class="btn ghost small">Load Snapshot</button>
            <input id="loadSnap" type="file" accept=".json" style="display:none">
            <button id="wake" class="btn ghost small">Wake the Engine</button>
            <button id="reset" class="btn ghost small">Reset Progress</button>
            <button id="switchMode" class="btn ghost small">Switch to Demo / Sign Out</button>
            <button id="unlock" class="btn primary small">I have a license key</button>
            <button id="buy" class="btn primary small">Buy</button>
          </div>
        </div>
      </div>
    </div>

    <div id="demoCta" class="cta">
      <button class="cta-btn" id="demoBuy">Unlock Full Engine ‚Äî $29</button>
      <div class="cta-sub">Keep your progress across devices. Premium modules included.</div>
    </div>
  </aside>

  <main>
    <section class="panel glass neon">
      <div id="chat" class="chat"></div>
      <div id="aiStatus" class="sub" style="margin-top:6px">Booting the Trainer‚Ä¶</div>
    </section>
  </main>
</div>

<div class="footer glass">
  <div class="composer">
    <textarea id="input" placeholder="Answer here. Press Enter to send." disabled></textarea>
    <button id="send" class="btn primary" disabled>Send</button>
  </div>
</div>

<!-- Modules Modal -->
<div class="modal" id="modulesModal" aria-hidden="true">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3>Modules</h3>
      <button id="closeModules" class="btn ghost small">Close</button>
    </div>
    <div class="modules-grid" id="modulesGrid"></div>
  </div>
</div>

<script type="module">
/* ===== short helpers ===== */
const $=id=>document.getElementById(id);
const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
const show=(el,v=true)=>{ if(!el) return; el.style.display=v?'':'none'; };
const text=(el,t)=>{ if(!el) return; el.textContent=t; };
const esc=s=>(s||"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));

/* ===== endpoints & curriculum ===== */
const CLOUD_ENDPOINT="https://freedom-engine-worker.intelligentlyartificialsystems.workers.dev";
const GUMROAD_URL="https://intellartsystems.gumroad.com/l/the-freedom-engine";
const STAGES=["profile","offers","selection","plan","optimize"];
const PROMPTS={
  opener:`Welcome to the Freedom Engine. I‚Äôm your personal trainer for tiny paid offers.
Here‚Äôs the drill: I‚Äôll handle strategy, templates, and deadlines; you do bite-size reps.
We‚Äôll ship one in ~72 hours. No monk retreat required.
To get you moving, choose a lane and I‚Äôll carry the heavy boxes:
‚Ä¢ design ‚Ä¢ writing ‚Ä¢ coaching ‚Ä¢ dev ‚Ä¢ other
If you‚Äôre blank, say ‚Äúhelp me choose‚Äù and I‚Äôll pitch options. I‚Äôll keep the sarcasm warm and the steps short.`,
  offers:`I‚Äôll propose three tiny offers with promise ‚Ä¢ price ‚Ä¢ delivery. Pick one; I‚Äôll sharpen it.`,
  selection:`We lock scope + price. One shippable thing. No scope creep, no martyrdom.`,
  plan:`Your 3-day plan: checklist, page copy, ad seed at $5/day. Minimal effort; maximum signal.`,
  optimize:`Quick upsell, objections patch, and hooks. Then we ship and learn fast.`
};

/* ===== DOM refs ===== */
const chatEl=$('chat'), inputEl=$('input'), sendBtn=$('send'), aiStatus=$('aiStatus');
const stageLabel=$('stageLabel'), stageText=$('stageText'), barFill=$('barFill'), modeTag=$('modeTag');
const menuRoot=$('menu'), menuBtn=$('menuBtn'), menuPanel=$('menuPanel');
const unlockBtn=$('unlock'), buyBtn=$('buy'), demoCta=$('demoCta'), demoBuy=$('demoBuy');
const modulesBtn=$('modulesBtn'), modulesModal=$('modulesModal'), modulesGrid=$('modulesGrid'), closeModules=$('closeModules');
const errorEl=$('error'), footerEl=document.querySelector('.footer');

/* ===== state ===== */
let history=JSON.parse(localStorage.getItem('fe_history')||'[]');
let unlocked=localStorage.getItem('fe_unlocked')==='1';
let licenseKey=localStorage.getItem('fe_license')||"";
let currentStage=localStorage.getItem('fe_stage')||"profile";
let agentMemory=JSON.parse(localStorage.getItem('fe_memory')||'{"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""}');
let modules=JSON.parse(localStorage.getItem('fe_modules')||'[]');

/* ===== error banner ===== */
function showErr(msg){console.error(msg); if(!errorEl) return; errorEl.textContent=(typeof msg==='string'?msg:(msg?.message||'Unknown error')); errorEl.style.display='block';}

/* ===== logo load ===== */
(function loadLogo(){
  const logo=$('iasLogo'); const fallback=document.querySelector('.logo-fallback');
  if(!logo) return;
  const primary=new URL('assets/ias-logo.png', location.href).href;
  const alt=new URL('ias-logo.png', location.href).href;
  let tried=false;
  const ok=()=>{logo.classList.add('spin');logo.style.display='block'; if(fallback) fallback.style.display='none';};
  on(logo,'load',ok);
  logo.onerror=()=>{ if(!tried){ tried=true; logo.src=alt; } else { showErr('Logo missing at /assets/ias-logo.png and /ias-logo.png'); } };
  logo.src=primary;
})();

/* ===== tone/style ===== */
function detectStyleFrom(t=""){t=t.toLowerCase();
  if(/stuck|overwhelmed|help|lost/.test(t))return"coach";
  if(/how|steps|plan|framework/.test(t))return"engineer";
  if(/write|headline|copy|hook|story/.test(t))return"ghostwriter";
  if(/procrastinat|excuse|no time|scared/.test(t))return"dark";
  return"coach";
}
const STYLE_PRIME={
  coach:"Direct, encouraging, light roast; never cruel.",
  engineer:"Stepwise, numbered, crisp.",
  ghostwriter:"Copy-led examples and hooks.",
  dark:"Ruthless accountability; dark humor (safe, no slurs)."
};
function systemPrime(style="coach",stage="profile",mods=[]){
  return `You are THE FREEDOM ENGINE ‚Äî mentor for tiny profitable offers. Mission: ship in ~72 hours.
Explain first, guide second, ask ONE small thing at a time. Keep it conversational, with dark witty asides.
Tone: ${STYLE_PRIME[style]}. Stage: ${stage}. Advance the curriculum.
Avoid interrogation lists. No ‚Äúwhat do people thank you for‚Äù question. Prefer: suggest ‚Üí confirm.
Return STRICT JSON ONLY:
{"say":"...","stage":"profile|offers|selection|plan|optimize","next_questions":["..."],"memory_delta":{"skills":"","audience":"","offer":"","price":"","style":"","blocked_by":""},"confidence":0.0}
Keep "say" < 140 words.`;
}

/* ===== render helpers ===== */
const bubble=(role,content)=>`<div class="msg ${role==='user'?'me':'ai'}">
  <div class="avatar ${role==='user'?'me':'ai'}">${role==='user'?'üí¨':'‚öôÔ∏è'}</div>
  <div class="bubble">${esc(content)}</div></div>`;
function scrollBottom(){if(!chatEl)return; chatEl.scrollTop=chatEl.scrollHeight;}
function render(){ if(!chatEl) return; chatEl.innerHTML=history.map(m=>bubble(m.role,m.content)).join(''); requestAnimationFrame(scrollBottom); }
function stageIndex(n){return Math.max(0,STAGES.indexOf(n));}
function setProgressUI(idx){ text(stageLabel,`${idx+1}/${STAGES.length}`); if(stageText) stageText.innerHTML=`Roadmap: <strong>${idx+1}/${STAGES.length}</strong>`; if(barFill) barFill.style.width=`${Math.round(((idx+1)/STAGES.length)*100)}%`; }
function updateProgressUI(){ setProgressUI(stageIndex(currentStage)); if(modeTag){modeTag.textContent=unlocked?'Premium':'Demo'; modeTag.className='pill '+(unlocked?'full':'demo');} show(demoCta,!unlocked); localStorage.setItem('fe_stage',currentStage); }

/* Chat height to meet composer */
function sizeChat(){
  if(!chatEl||!footerEl) return;
  const top=chatEl.getBoundingClientRect().top + window.scrollY;
  const h=window.innerHeight - footerEl.offsetHeight - (top - window.scrollY) - 16;
  chatEl.style.height = Math.max(220, h) + "px";
}
window.addEventListener('resize',()=>setTimeout(sizeChat,50));
document.addEventListener('DOMContentLoaded',()=>setTimeout(sizeChat,50));

/* ===== cloud save/load ===== */
async function cloudSave(){
  if(!unlocked||!licenseKey) return;
  const payload={license_key:licenseKey,data:{memory:agentMemory,stage:currentStage,history,modules}};
  try{ await fetch(`${CLOUD_ENDPOINT}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}); }catch{}
}
async function cloudLoad(){
  if(!unlocked||!licenseKey) return false;
  try{
    const r=await fetch(`${CLOUD_ENDPOINT}/progress?license_key=${encodeURIComponent(licenseKey)}`);
    if(!r.ok) return false; const j=await r.json(); if(!j||!j.ok||!j.data) return false;
    const d=j.data; agentMemory=d.memory||agentMemory; currentStage=d.stage||currentStage;
    history=Array.isArray(d.history)?d.history:history; modules=Array.isArray(d.modules)?d.modules:modules;
    persistLocal(); return true;
  }catch{return false;}
}
let saveTimer=null; function autoSaveSoon(){if(saveTimer)clearTimeout(saveTimer); saveTimer=setTimeout(cloudSave,600);}
function persistLocal(){localStorage.setItem('fe_history',JSON.stringify(history));localStorage.setItem('fe_memory',JSON.stringify(agentMemory));localStorage.setItem('fe_modules',JSON.stringify(modules));localStorage.setItem('fe_stage',currentStage);}

/* ===== API & parsing ===== */
async function callCloud(messages){
  const r=await fetch(`${CLOUD_ENDPOINT}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
  if(!r.ok) throw new Error(`Cloud ${r.status}`);
  const j=await r.json(); return j.output||"No response.";
}
function extractJSONBlock(s){
  let start=s.indexOf('{'); while(start!==-1){
    const sub=s.slice(start);
    try{ return JSON.parse(sub); }catch{ start=s.indexOf('{', start+1); }
  }
  return null;
}
function parseAgent(out){
  out=(out||"").trim();
  let parsed=null; try{ parsed=JSON.parse(out); }catch{}
  if(!parsed) parsed=extractJSONBlock(out);
  if(parsed && typeof parsed.say==="string"){
    return { say: parsed.say, stage: parsed.stage||currentStage, memory_delta: parsed.memory_delta||{}, confidence: parsed.confidence??.7 };
  }
  const cleaned = out.replace(/\{[\s\S]*?\}/g,'').replace(/\n{3,}/g,'\n\n').trim();
  return { say: cleaned || "Pick a lane (design / writing / coaching / dev / other), or say ‚Äúhelp me choose‚Äù.", stage: currentStage, memory_delta:{}, confidence:.6 };
}

/* ===== chat engine ===== */
function push(role,content){history.push({role,content}); persistLocal(); render(); updateProgressUI(); autoSaveSoon();}
function activeStyle(){ const lastUser=[...history].reverse().find(m=>m.role==='user')?.content||""; const s=detectStyleFrom(lastUser)||agentMemory.style||"coach"; agentMemory.style=s; localStorage.setItem('fe_memory',JSON.stringify(agentMemory)); return s; }
function advanceStageMaybe(next){ if(!STAGES.includes(next))return; const cur=stageIndex(currentStage), nx=stageIndex(next); if(nx===cur+1) currentStage=next; }

async function agentRespond(){
  const style=activeStyle();
  const ctx=[{role:"system",content:systemPrime(style,currentStage,modules.map(m=>m.id))},
             {role:"system",content:`MEMORY:${JSON.stringify(agentMemory)}`},
             {role:"system",content:`CURRICULUM:${PROMPTS[currentStage]||""}`},
             ...history.slice(-10)];
  const raw=await callCloud(ctx);
  const p=parseAgent(raw);
  if(p.memory_delta&&typeof p.memory_delta==='object'){
    for(const k of ["skills","audience","offer","price","style","blocked_by"]){ if(p.memory_delta[k]) agentMemory[k]=p.memory_delta[k]; }
  }
  advanceStageMaybe(p.stage);
  persistLocal(); autoSaveSoon();
  push('assistant', p.say);
}

/* ===== boot ===== */
function greetIfEmpty(){ if(history.length===0){ push('assistant', PROMPTS.opener); } }
async function boot(){
  inputEl.disabled=false; sendBtn.disabled=false;
  updateProgressUI(); sizeChat();
  if(unlocked&&licenseKey){ const loaded=await cloudLoad(); if(loaded){ render(); } }
  render(); greetIfEmpty();
  text(aiStatus,"Ready."); setTimeout(()=>{sizeChat(); scrollBottom();},140);
}
document.addEventListener('DOMContentLoaded',boot);

/* ===== composer ===== */
on(sendBtn,'click',async()=>{
  const t=inputEl.value.trim(); if(!t) return;
  inputEl.value=""; push('user',t);
  text(aiStatus,"Thinking‚Ä¶");
  try{ await agentRespond(); }catch(e){ showErr(e); push('assistant',"Cloud hiccup. Give me your next answer; I‚Äôll keep us moving."); }
  text(aiStatus,"Ready."); setTimeout(()=>{sizeChat(); scrollBottom();},60);
});
on(inputEl,'keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

/* ===== export brief (HTML) ===== */
on($('export'),'click', async ()=>{
  try{
    const briefTask=`User memory: ${JSON.stringify(agentMemory)}
Create a crisp execution brief (<700 words):
- Offer: name, audience, promise, price
- Product page bullets + Gumroad blurb
- 72-hour launch checklist (Day 1‚Äì3) at $5/day
- 5 ad hooks + 3 headlines
Tone: tough-love mentor with dark humor.`;
    const report=await callCloud([{role:"system",content:"You compile briefs."},...history.slice(-16),{role:"user",content:briefTask}]);
    const html=`<!doctype html><html><head><meta charset="utf-8"><title>Freedom Engine ‚Äî Export</title>
<style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0b0d12;color:#eef3ff;margin:0;padding:28px}
.wrap{max-width:900px;margin:0 auto}.h{font-size:28px;font-weight:800;margin:0 0 4px;letter-spacing:.8px}
.sub{color:#9aa3b2;margin:0 0 18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #1b2235;border-radius:16px;padding:16px;margin:14px 0}
pre{white-space:pre-wrap;background:#0d1117;border:1px solid #232c40;border-radius:10px;padding:12px;line-height:1.5}</style></head>
<body><div class="wrap"><div class="h">The Freedom Engine ‚Äî Export</div>
<div class="sub">Generated ${new Date().toLocaleString()}</div>
<div class="card"><h3>Execution Brief</h3><pre>${esc(report)}</pre></div></div></body></html>`;
    downloadBlob(html,'text/html','freedom-engine-export.html');
  }catch(e){ showErr(e); alert("Couldn‚Äôt generate export‚Äîcloud hiccup."); }
});

/* ===== menu/auth ===== */
on(menuBtn,'click',()=>menuRoot && menuRoot.classList.toggle('open'));
document.addEventListener('click',e=>{ if(menuRoot && !menuRoot.contains(e.target)) menuRoot.classList.remove('open'); });

on($('saveSnap'),'click',()=>{
  const snap={when:new Date().toISOString(),memory:agentMemory,stage:currentStage,history,modules,unlocked};
  downloadBlob(JSON.stringify(snap,null,2),'application/json',`freedom-snapshot-${Date.now()}.json`);
});
on($('loadBtn'),'click',()=>$('loadSnap').click());
on($('loadSnap'),'change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const snap=JSON.parse(await f.text());
    agentMemory=snap.memory||agentMemory; currentStage=snap.stage||"profile";
    history=Array.isArray(snap.history)?snap.history:[]; modules=Array.isArray(snap.modules)?snap.modules:[];
    unlocked=!!snap.unlocked; localStorage.setItem('fe_unlocked',unlocked?'1':''); persistLocal(); render(); updateProgressUI();
    push('assistant',"Snapshot loaded. Back on track."); autoSaveSoon(); sizeChat();
  }catch(err){ showErr(err); alert("Bad snapshot file."); }
});
on($('reset'),'click',()=>{
  if(confirm("Reset all progress?")){
    history=[]; agentMemory={"skills":"","audience":"","offer":"","price":"","style":"coach","blocked_by":""}; currentStage="profile";
    localStorage.removeItem('fe_history'); localStorage.removeItem('fe_stage'); localStorage.removeItem('fe_memory');
    setProgressUI(0); render(); push('assistant', PROMPTS.opener); autoSaveSoon(); sizeChat();
  }
});
on($('switchMode'),'click',()=>{
  if(confirm("Sign out on this device? Your premium progress stays attached to the license.")){
    try{ localStorage.clear(); sessionStorage.clear(); caches?.keys?.().then(keys=>keys.forEach(k=>caches.delete(k))).catch(()=>{}); }
    finally{ location.replace(location.pathname); }
  }
});
on(buyBtn,'click',()=>window.open(GUMROAD_URL,'_blank'));
on(demoBuy,'click',()=>window.open(GUMROAD_URL,'_blank'));
on(unlockBtn,'click',async()=>{
  const key=prompt("Paste your license key:"); if(!key) return;
  try{
    const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim()})}).then(r=>r.json());
    if(r.ok){
      localStorage.setItem('fe_unlocked','1'); localStorage.setItem('fe_license',key.trim());
      unlocked=true; licenseKey=key.trim();
      const loaded=await cloudLoad();
      updateProgressUI();
      if(loaded){ render(); push('assistant',"Premium engaged. I pulled your progress from the vault. Back to work."); }
      else { push('assistant',"Premium engaged. Clean slate stored in the vault. Let‚Äôs move."); await cloudSave(); }
      sizeChat();
    } else alert("Key didn‚Äôt verify. Check your Gumroad receipt.");
  }catch(e){ showErr(e); alert("Verification failed‚Äînetwork/endpoint."); }
});

/* ===== modules (UI only) ===== */
const MODULES=[{id:"ads",name:"Ad Creative Booster",product_id:"MOD_ADS_ID",price:"$12",desc:"Generate ad images + angles."},
  {id:"email",name:"Email Launch Booster",product_id:"MOD_EMAIL_ID",price:"$9",desc:"Auto-draft 3-day launch emails."},
  {id:"planner",name:"Content Planner",product_id:"MOD_PLAN_ID",price:"$12",desc:"7-day content seed plan."},
  {id:"proof",name:"Proof Builder",product_id:"MOD_PROOF_ID",price:"$7",desc:"Extract proof from past wins."}];
on(modulesBtn,'click',()=>{ renderModules(); modulesModal.classList.add('open'); });
on(closeModules,'click',()=>modulesModal.classList.remove('open'));
on(modulesGrid,'click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id; const act=btn.dataset.act; const mod=MODULES.find(x=>x.id===id); if(!mod) return;
  if(act==='preview'){ push('assistant', `Preview: **${mod.name}** ‚Äî ${mod.desc}\nSay ‚Äúapply ${mod.id}‚Äù to weave it into the next steps.`); }
  if(act==='deactivate'){ modules = modules.filter(x=>x.id!==id); persistLocal(); renderModules(); push('assistant', `${mod.name} deactivated.`); autoSaveSoon(); }
  if(act==='unlock'){
    const key=licenseKey || prompt(`Paste the license key for ${mod.name}:`); if(!key) return;
    try{
      const r=await fetch(`${CLOUD_ENDPOINT}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:key.trim(),product_id:mod.product_id})}).then(r=>r.json());
      if(r.ok){ modules=[...modules.filter(x=>x.id!==id), {id:mod.id, when:Date.now()}]; persistLocal(); renderModules(); push('assistant', `${mod.name} unlocked. I‚Äôll incorporate it automatically.`); autoSaveSoon(); }
      else alert("That key didn‚Äôt verify for this module.");
    }catch(err){ showErr(err); alert("Verification failed‚Äînetwork/endpoint."); }
  }
});
function renderModules(){
  modulesGrid.innerHTML = MODULES.map(m=>{
    const active = modules.some(x=>x.id===m.id);
    return `<div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h4>${m.name}</h4>
        <span class="badge" style="border-color:${active?'#1f4b3c':'#4a2a47'};background:${active?'rgba(61,220,151,.12)':'rgba(255,124,186,.12)'}">${active?'Active':'Locked'}</span>
      </div>
      <div style="color:#cfd6ff;font-size:13px;margin-bottom:8px">${m.desc}</div>
      <div class="row">
        ${active?`<button class="btn ok small" data-act="deactivate" data-id="${m.id}">Deactivate</button>`:
          `<button class="btn primary small" data-act="unlock" data-id="${m.id}">Unlock ${m.price}</button>`}
        <button class="btn ghost small" data-act="preview" data-id="${m.id}">Preview</button>
      </div>
    </div>`;
  }).join('');
}

/* ===== utilities ===== */
function downloadBlob(content,type,name){const blob=new Blob([content],{type});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();}

/* ===== greeting / wake ===== */
const $wake=$('wake'); on($wake,'click',()=>{ push('assistant',"Engine awake. No incense required."); });

/* ===== demo CTA visibility ===== */
function refreshCTA(){ show(demoCta,!unlocked); }
refreshCTA();
</script>
</body>
</html>
